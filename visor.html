<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visor de Estado PAD - Optimizado TV</title>

<style>
  :root{
    --bg:#000;
    --card:#08203a; --muted:#cfe8ff;
    --header-h-1:48px; --header-h-2:44px;
    --pozo-font-size:20px; --stock-font-size:14px; --cell-font-size:19px;
    --w-id:54px; --w-seq:110px;
    --reel-gap:8px; --reel-pad:10px; --reel-num-size:20px; --reel-date-size:18px;
    --row-h:44px; --nudge-x:0px; --nudge-y:0px; --overscan:0px;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Segoe UI,Arial,sans-serif; overflow:hidden;}
  .wrap{padding:calc(14px + var(--overscan));box-sizing:border-box;display:flex;flex-direction:column;height:100%;transform:translate(var(--nudge-x),var(--nudge-y));transition:transform .25s ease;}

  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  header h1{margin:0;font-size:28px;letter-spacing:.6px}
  header .meta{opacity:.9;font-size:13px;color:#9fd7ff}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{background:#0b61a8;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,.08)}
  .switch{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--muted);cursor:pointer}

  main{flex:1;margin-top:12px;display:flex;min-height:0}
  .board{flex:1;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border-radius:10px;padding:12px;box-sizing:border-box;display:flex;flex-direction:column}

  .table-container{flex:1;overflow:auto;border-radius:8px;position:relative;min-height:0}
  table{border-collapse:collapse;width:100%;min-width:1280px}
  th,td{border:1px solid rgba(255,255,255,.06);padding:8px 10px;text-align:center;white-space:nowrap}

  thead th{background:var(--bg);box-shadow:0 2px 0 rgba(0,0,0,.25)}
  thead tr:first-child th{position:sticky;top:0;z-index:11;height:var(--header-h-1)}
  thead tr:nth-child(2) th{position:sticky;top:var(--header-h-1);z-index:12;height:var(--header-h-2)}

  tbody td{height:var(--row-h);background:transparent;color:#e6f7ff;transition:background .15s ease}
  tbody tr.alt td{background:rgba(255,255,255,.03)}
  tbody tr:hover td{background:rgba(255,255,255,.06)}

  th.rowid,td.rowid{position:sticky;left:0;z-index:20;width:var(--w-id);min-width:var(--w-id);max-width:var(--w-id)}
  td.rowid{font-weight:800;color:#bfe8ff;background:#0c1833}

  td.seq{font-weight:800;letter-spacing:.2px;background:rgba(0,255,160,.06)}
  .fh{line-height:1.1}
  .fh .d{color:#2fffd2;font-weight:900;display:inline-block}
  .fh .t{color:#ffb357;font-weight:900;display:inline-block}

  .pozoTop{font-size:var(--pozo-font-size);font-weight:800;letter-spacing:.6px;position:relative}
  .pozo-1{background:#ffd83a;color:#002}
  .pozo-2{background:#7ad39a;color:#002}
  .pozo-3{background:#74b3ff;color:#002}
  .pozo-4{background:#ff7b7b;color:#002}
  .pozo-5{background:#ffffff;color:#002}
  .pozo-6{background:#e8c3ff;color:#201}

  .pozoTop .badge{
    margin-left:8px;padding:2px 7px;border-radius:999px;font-size:12px;font-weight:900;line-height:1;color:#fff;
    background:rgba(0,0,0,.6); border:1px solid rgba(255,255,255,0.2);
    vertical-align:middle
  }

  td.stop{background:rgba(255,60,60,.14)!important;color:#ffb3b3!important;font-weight:900}

  .stockwrap{display:flex;align-items:center;gap:10px;flex:1 1 auto;min-width:0}
  .stockbar{display:block;overflow-x:auto;overflow-y:hidden;white-space:nowrap;flex:1 1 auto}
  .pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);padding:8px 12px;border-radius:999px;font-size:var(--stock-font-size);color:#e9f6ff;font-weight:700;margin-right:8px}
  .pill .dot{width:8px;height:8px;border-radius:50%}

  .kpis{display:grid;grid-template-columns:repeat(3,minmax(120px,1fr)) 1.2fr 1.2fr;gap:10px;align-items:stretch}
  .kpi{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px;display:flex;flex-direction:column;justify-content:center}
  .kpi-label{font-size:12px;color:#bfe8ff;opacity:.9;font-weight:700;margin-bottom:2px}
  .kpi-value{font-size:26px;font-weight:900;letter-spacing:.3px}
  .kpi-green{color:#45ffb2}
  .kpi-amber{color:#ffcc66}

  .reel{display:flex;align-items:center;gap:var(--reel-gap);overflow-x:auto}
  .reel-btn{width:28px;height:28px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,0.05);color:#cfe8ff;font-weight:800;cursor:pointer}
  .date-chip{display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:132px;padding:var(--reel-pad);border-radius:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08)}
  .date-chip.latest{background:linear-gradient(180deg,rgba(0,163,255,.18),rgba(0,163,255,.08));border-color:rgba(0,163,255,.35)}

  #saver{position:fixed;inset:0;display:none;z-index:9997;background:#000}
  #saver .ticker{position:absolute;left:0;right:0;bottom:5%;text-align:center;font-size:14px;color:#cfe8ff;opacity:.9}
  .bImg, .fallImg{
      position:absolute;
      width:min(14vw,200px);
      height:auto;
      will-change: transform;
      pointer-events:none;
  }

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.8);z-index:9998}
  .modal-card{width:min(900px,96vw);max-height:90vh;overflow:auto;background:#0c1833;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:16px}
  
  /* OPTIMIZACIÓN TV: QUITAR FILTROS PESADOS */
  html.is-tv * { box-shadow: none !important; text-shadow: none !important; backdrop-filter: none !important; }
  html.is-tv .board { background: #05101a; }
</style>
</head>

<body>
<div id="dimVeil" style="position:fixed;inset:0;pointer-events:none;background:#000;opacity:0;z-index:9996"></div>
<div id="saver">
  <div id="saverStage" style="position:absolute;inset:0;overflow:hidden"></div>
  <div class="ticker" id="saverTicker"></div>
</div>

<div class="wrap">
  <header>
    <div>
      <h1>Visor de Estado PAD</h1>
      <div class="meta">Actualiza automáticamente</div>
    </div>
    <div class="controls">
      <div style="display:flex;align-items:center;gap:4px;margin-right:12px;background:rgba(255,255,255,0.06);padding:3px 6px;border-radius:8px">
        <button class="btn secondary" id="btnZoomOut">-</button>
        <span id="txtZoom" style="font-size:13px;min-width:40px;text-align:center;font-weight:700">100%</span>
        <button class="btn secondary" id="btnZoomIn">+</button>
      </div>

      <label class="switch">
        <input id="autoScroll" type="checkbox" />
        Auto-scroll (últimas <span id="autoN"></span>)
      </label>
      <button class="btn" id="btnRefresh">Refrescar</button>
      <button class="btn secondary" id="btnSettings">Ajustes</button>
    </div>
  </header>

  <main>
    <div class="board">
      <div class="bar" style="flex-wrap:wrap">
        <div class="kpis" style="flex:1 1 680px">
          <div class="kpi"><div class="kpi-label">Etapas totales</div><div id="kpiTotal" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-label">Realizadas</div><div id="kpiDone" class="kpi-value kpi-green">0</div></div>
          <div class="kpi"><div class="kpi-label">Restantes</div><div id="kpiRemain" class="kpi-value kpi-amber">0</div></div>
          <div class="kpi">
            <div class="kpi-label">Promedio Real</div>
            <div id="kpiAvg" style="font-size:18px;font-weight:800">—</div>
            <div id="kpiWindow" style="font-size:11px;opacity:0.8">Ventana: —</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Fin estimado</div>
            <div id="kpiETA" style="font-size:18px;font-weight:800">—</div>
          </div>
        </div>

        <div class="indicators" style="margin-left:auto">
          <div id="datesReel" class="reel"></div>
        </div>
      </div>

      <div class="bar">
        <div class="stockwrap">
          <div style="font-weight:800;opacity:0.8">STOCK:</div>
          <div id="stockBar" class="stockbar"></div>
        </div>
      </div>

      <div class="table-container" id="tableContainer">
        <table id="mainTable">
          <thead>
            <tr id="hdrTop"><th class="rowid">#</th></tr>
            <tr id="hdrSub"><th class="rowid">&nbsp;</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <footer style="display:flex;justify-content:space-between;margin-top:10px;font-size:13px;opacity:0.8">
        <div>Última actualización: <strong id="lastUpdate">-</strong> <span id="delta"></span></div>
        <div id="netStatus" class="pill" style="padding:4px 10px;font-size:11px">Conectando…</div>
      </footer>
    </div>
  </main>
</div>

<div id="settingsModal" class="modal">
  <div class="modal-card">
    <div class="modal-head"><strong>Configuración</strong></div>
    <div class="modal-body" style="display:grid;gap:15px;padding:10px">
      <section style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px">
        <h4>ETA</h4>
        <label><input type="checkbox" id="setUseManualSpeed"> Usar velocidad fija</label>
        <input type="number" id="setManualSpeed" step="0.1" style="width:100px;margin-left:10px">
      </section>
      <section style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px">
        <h4>Protector de pantalla</h4>
        Modo: <select id="setSaverMode"><option value="valores-lluvia">Lluvia</option><option value="valores-rebotando">Rebote</option></select>
        Inactivo (min): <input type="number" id="setSaverIdle" style="width:60px">
        <button class="btn secondary" id="btnTestSaver">Probar</button>
      </section>
      <section>
        <h4>Pozos visibles</h4>
        <div id="wellChooser" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px"></div>
      </section>
    </div>
    <div class="modal-actions" style="margin-top:15px;display:flex;justify-content:flex-end;gap:10px">
      <button class="btn secondary" id="btnCloseSettings">Cerrar</button>
      <button class="btn" id="btnSaveSettings">Guardar</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  /* CONFIG */
  var ROWS=71, POZOS=6, JSON_URL='https://baseslucas8071-maker.github.io/tablero/status.json';
  var LAST_N_TO_SHOW=7;
  
  if(/\b(Android TV|SMART-TV|TCL|BRAVIA|AFT)\b/i.test(navigator.userAgent)) document.documentElement.classList.add('is-tv');

  var prefs={
    get:function(k,d){ try{ var v=localStorage.getItem(k); return v!==null?JSON.parse(v):d; }catch(_){ return d; } },
    set:function(k,v){ try{ localStorage.setItem(k,JSON.stringify(v)); }catch(_){} }
  };

  var DISPLAY=prefs.get('display:cfg',{
    pozoFont:20, stockFont:16, cellFont:19,
    saver:{ mode:'valores-lluvia', idleMinutes:30 },
    kpi: { useManual: true, manualSpeed: 10 },
    view: { visibleWells:[1,2,3,4,5,6] }
  });

  /* INICIALIZAR TABLA #00 - #70 */
  function initializeDOM(){
    var hTop=document.getElementById('hdrTop'), hSub=document.getElementById('hdrSub'), tbody=document.getElementById('tbody');
    for(var i=1;i<=POZOS;i++){
      var th=document.createElement('th'); th.className='pozo-'+i+' pozoTop'; th.colSpan=3; th.innerText='POZO #'+i; hTop.appendChild(th);
      ['F/h','TPN','ESTADO'].forEach(function(t){ var s=document.createElement('th'); s.innerText=t; hSub.appendChild(s); });
    }
    var frag=document.createDocumentFragment();
    for(var r=0; r<ROWS; r++){
      var id='#'+String(r).padStart(2,'0');
      var tr=document.createElement('tr'); tr.dataset.rowId=id;
      if(r%2===0) tr.classList.add('alt');
      tr.innerHTML = '<td class="rowid">'+id+'</td>' + Array(POZOS*3).fill('<td></td>').join('');
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
  }

  /* PROCESAMIENTO DE DATOS */
  var prevDataMap = {}, latestDataMap = {};
  function isStop(v){ return String(v||"").trim().toUpperCase()==='STOP'; }
  function isDate(v){ var s=String(v||"").trim(); return s && (!isNaN(s) && Number(s)>40000 || /^(\d{1,2})[\/\-]\d{1,2}[\/\-]\d{2,4}/.test(s)); }

  async function loadData(){
    try {
      const res = await fetch(JSON_URL + '?t=' + Date.now());
      const data = await res.json();
      const rows = data.items || [];
      
      let tot_slots=0, tot_hechas=0, dailyMap = new Map();

      // Procesar cada pozo para KPIs y UI
      for(var p=1; p<=POZOS; p++){
        var fk=`FechaFracPozo${p}`, tk=`TPNPozo${p}`, sk=`SecuenciaPozo${p}`, active=true;
        
        rows.forEach((r, idx) => {
          if(idx >= ROWS || !active) return;
          var val = r[fk];
          if(isStop(val)) active=false;
          else if(active){
            tot_slots++;
            if(isDate(val)){
               tot_hechas++;
               var dKey = String(val).split(' ')[0];
               dailyMap.set(dKey, (dailyMap.get(dKey)||0)+1);
            }
          }
          
          // Actualizar UI solo si cambió
          var rowId = '#' + String(idx).padStart(2,'0');
          var tr = document.querySelector('tr[data-row-id="'+rowId+'"]');
          if(tr && prevDataMap[rowId+p] !== val){
            var baseIdx = (p-1)*3 + 1;
            tr.cells[baseIdx].innerText = r[sk] || '';
            tr.cells[baseIdx+1].innerText = r[tk] || '';
            tr.cells[baseIdx+2].innerText = val || '';
            tr.cells[baseIdx+2].className = isStop(val) ? 'stop' : '';
            prevDataMap[rowId+p] = val;
          }
          latestDataMap[rowId] = r;
        });
      }

      // KPIs
      document.getElementById('kpiTotal').innerText = tot_slots;
      document.getElementById('kpiDone').innerText = tot_hechas;
      document.getElementById('kpiRemain').innerText = tot_slots - tot_hechas;
      
      var hist = Array.from(dailyMap.values());
      var avg = hist.length ? (hist.reduce((a,b)=>a+b,0)/hist.length).toFixed(1) : 0;
      document.getElementById('kpiAvg').innerText = avg + ' et/día';
      document.getElementById('kpiWindow').innerText = 'Días: ' + hist.length;

      var speed = DISPLAY.kpi.useManual ? DISPLAY.kpi.manualSpeed : avg;
      if(speed > 0){
        var eta = new Date(Date.now() + ((tot_slots - tot_hechas)/speed)*86400000);
        document.getElementById('kpiETA').innerText = eta.toLocaleDateString('es-AR') + ' (v:'+speed+')';
      }

      renderStock(data.stock || []);
      renderReel(dailyMap);
      document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString();
      setNetStatus('OK', true);
      if(document.getElementById('autoScroll').checked) scrollToLast();
    } catch(e) { setNetStatus('ERROR', false); }
  }

  /* PROTECTOR DE PANTALLA OPTIMIZADO */
  var idleTime = 0, raf = null, sprites = [];
  function startSaver(){
    var stage = document.getElementById('saverStage'); stage.innerHTML = '';
    document.getElementById('saver').style.display = 'block';
    // Caché de dimensiones para evitar layout thrashing
    var W = window.innerWidth, H = window.innerHeight;
    sprites = [1,2,3,4,5,6].map(function(i){
      var img = document.createElement('img');
      img.src = 'https://raw.githubusercontent.com/baseslucas8071-maker/tablero/main/images/'+i+'.png';
      img.className = 'bImg'; stage.appendChild(img);
      return { el:img, x:Math.random()*W*0.6, y:Math.random()*H*0.6, vx:2, vy:2, w:180, h:100 };
    });
    function anim(){
      for(var i=0; i<sprites.length; i++){
        var s = sprites[i];
        s.x += s.vx; s.y += s.vy;
        if(s.x <= 0 || s.x + s.w >= W) s.vx *= -1;
        if(s.y <= 0 || s.y + s.h >= H) s.vy *= -1;
        s.el.style.transform = 'translate3d('+s.x+'px,'+s.y+'px,0)';
      }
      raf = requestAnimationFrame(anim);
    }
    anim();
  }

  /* UI HELPERS */
  function setNetStatus(txt, ok){
    var el = document.getElementById('netStatus');
    el.innerText = txt; el.style.background = ok ? 'rgba(0,255,100,0.2)' : 'rgba(255,50,50,0.2)';
  }

  function renderStock(list){
    var bar = document.getElementById('stockBar'); bar.innerHTML = '';
    list.forEach(function(s, i){
      bar.innerHTML += '<div class="pill"><span class="dot" style="background:hsl('+(i*45)+',70%,60%)"></span>'+s.ITEM+': '+s.STOCK+'</div>';
    });
  }

  function renderReel(map){
    var reel = document.getElementById('datesReel'); reel.innerHTML = '';
    Array.from(map.entries()).slice(-3).forEach(function(e){
      reel.innerHTML += '<div class="date-chip"><div style="font-size:10px">'+e[0]+'</div><div style="font-size:18px;font-weight:900">'+e[1]+'</div></div>';
    });
  }

  function scrollToLast(){
    var container = document.getElementById('tableContainer');
    var rows = document.querySelectorAll('#tbody tr');
    for(var i = rows.length-1; i >= 0; i--){
      if(rows[i].cells[2].innerText.trim() !== ""){
        container.scrollTo({ top: rows[i].offsetTop - 100, behavior: 'smooth' });
        break;
      }
    }
  }

  /* EVENTOS */
  window.addEventListener('mousemove', function(){ 
    idleTime = 0; 
    document.getElementById('saver').style.display='none'; 
    cancelAnimationFrame(raf);
  });

  document.getElementById('btnRefresh').onclick = loadData;
  document.getElementById('autoN').innerText = LAST_N_TO_SHOW;

  // Zoom
  var zoom = 1.0;
  document.getElementById('btnZoomIn').onclick = function(){ zoom += 0.1; applyZoom(); };
  document.getElementById('btnZoomOut').onclick = function(){ zoom -= 0.1; applyZoom(); };
  function applyZoom(){ document.querySelector('.wrap').style.transform = 'scale('+zoom+')'; document.querySelector('.wrap').style.transformOrigin = 'top left'; document.getElementById('txtZoom').innerText = Math.round(zoom*100)+'%'; }

  // Modal Ajustes
  document.getElementById('btnSettings').onclick = function(){ 
    document.getElementById('setManualSpeed').value = DISPLAY.kpi.manualSpeed;
    document.getElementById('setUseManualSpeed').checked = DISPLAY.kpi.useManual;
    document.getElementById('setSaverIdle').value = DISPLAY.saver.idleMinutes;
    document.getElementById('settingsModal').style.display = 'flex'; 
  };
  document.getElementById('btnCloseSettings').onclick = function(){ document.getElementById('settingsModal').style.display = 'none'; };
  document.getElementById('btnSaveSettings').onclick = function(){
    DISPLAY.kpi.manualSpeed = parseFloat(document.getElementById('setManualSpeed').value);
    DISPLAY.kpi.useManual = document.getElementById('setUseManualSpeed').checked;
    DISPLAY.saver.idleMinutes = parseInt(document.getElementById('setSaverIdle').value);
    prefs.set('display:cfg', DISPLAY);
    document.getElementById('settingsModal').style.display = 'none';
    loadData();
  };

  /* INIT */
  initializeDOM();
  loadData();
  setInterval(loadData, REFRESH_SECONDS * 1000);
  setInterval(function(){ 
    idleTime++; 
    if(idleTime >= DISPLAY.saver.idleMinutes) startSaver(); 
  }, 60000);
});
</script>
</body>
</html>
