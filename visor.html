<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visor de Estado PAD</title>
<style>
  :root {
    --bg: #071027;
    --card: #08203a;
    --muted: #cfe8ff;
    --accent: #00a3ff;
    --header-h-1: 48px;
    --header-h-2: 44px;

    /* ===== AJUSTES RÁPIDOS ===== */
    --w-id: 54px;            /* ancho columna Fila (#01) */
    --w-seq: 50px;           /* ancho columnas Secuencia */
    --pozo-font-size: 18px;  /* tamaño “POZO #n” (ajustable en Ajustes) */
    --stock-font-size: 14px; /* tamaño texto stock (ajustable en Ajustes) */
    --stock-pad-x: 12px;
    --stock-pad-y: 8px;

    /* Mini-reel de fechas */
    --reel-gap: 8px;
    --reel-pad: 10px;
    --reel-num-size: 20px;
    --reel-date-size: 12px;
  }

  html, body { height: 100%; margin: 0; background: var(--bg); color: #fff; font-family: Inter, Segoe UI, Arial, sans-serif; }
  .wrap { padding: 14px; box-sizing: border-box; display: flex; flex-direction: column; height: 100%; }
  header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  header h1 { margin: 0; font-size: 28px; letter-spacing: 0.6px; }
  header .meta { opacity: 0.9; font-size: 13px; color: #9fd7ff; }
  .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .btn { background: #0b61a8; border: none; color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }
  .btn.secondary { background: transparent; border: 1px solid rgba(255, 255, 255, 0.12); }
  .switch { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--muted); cursor: pointer; }

  main { flex: 1; margin-top: 12px; display: flex; min-height: 0; }
  .board { flex: 1; background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01)); border-radius: 10px; padding: 12px; box-sizing: border-box; display: flex; flex-direction: column; }
  .table-container { flex: 1; overflow: auto; border-radius: 8px; position: relative; min-height: 0; }
  table { border-collapse: collapse; width: 100%; min-width: 1280px; }
  th, td { border: 1px solid rgba(255, 255, 255, 0.06); padding: 8px 10px; text-align: center; white-space: nowrap; }
  thead th { background: var(--bg); box-shadow: 0 2px 0 rgba(0,0,0,.25); }
  thead tr:first-child th { position: sticky; top: 0; z-index: 11; height: var(--header-h-1); }
  thead tr:nth-child(2) th { position: sticky; top: var(--header-h-1); z-index: 12; height: var(--header-h-2); }
  tbody td { height: 44px; background: transparent; color: #e6f7ff; transition: background .15s ease; }
  tbody tr.alt td { background: rgba(255, 255, 255, 0.01); }
  tbody tr:hover td { background: rgba(255,255,255,.03); }

  /* Columna Fila (#01) angosta y sticky */
  th.rowid, td.rowid { position: sticky; left: 0; z-index: 20; width: var(--w-id); min-width: var(--w-id); max-width: var(--w-id); }
  td.rowid { font-weight: 800; color: #bfe8ff; background: #0c1833; }

  /* Secuencia (verde fosforescente) */
  th.seq, td.seq { width: var(--w-seq); min-width: var(--w-seq); max-width: var(--w-seq); }
  td.seq {
    font-weight: 800;
    color: #00ff9c;
    letter-spacing: 0.4px;
    text-shadow: 0 0 6px rgba(0,255,160,0.7), 0 0 12px rgba(0,255,160,0.35);
    background: rgba(0,255,160,0.05);
  }
  thead th:first-child { position: sticky; left: 0; z-index: 21; }

  /* Cabeceras por pozo */
  .pozoTop { font-size: var(--pozo-font-size); font-weight: 800; letter-spacing: .6px; position: relative; }
  .pozo-1{background:linear-gradient(90deg,#ffd83a,#ffd83a); color:#002;}
  .pozo-2{background:linear-gradient(90deg,#7ad39a,#5fbf87); color:#002;}
  .pozo-3{background:linear-gradient(90deg,#74b3ff,#4686ff); color:#002;}
  .pozo-4{background:linear-gradient(90deg,#ff7b7b,#ff4c4c); color:#002;}
  .pozo-5{background:linear-gradient(90deg,#ffffff,#f2f6f9); color:#002;}  /* blanco */
  .pozo-6{background:linear-gradient(90deg,#e8c3ff,#d79bf6); color:#201;}  /* lila */

  /* Badge por pozo (alto contraste universal) */
  .pozoTop .badge{
    margin-left: 8px; padding: 2px 7px; border-radius: 999px;
    font-size: 12px; font-weight: 900; line-height: 1; color: #fff;
    background: rgba(0,0,0,.45);
    border: 1px solid rgba(0,0,0,.55);
    box-shadow: 0 0 0 1px rgba(255,255,255,.35), 0 1px 6px rgba(0,0,0,.35);
    text-shadow: 0 1px 1px rgba(0,0,0,.55);
    backdrop-filter: saturate(120%) blur(1px);
    -webkit-backdrop-filter: saturate(120%) blur(1px);
    vertical-align: middle;
  }

  /* STOP resaltado */
  td.stop {
    background: rgba(255, 60, 60, .14) !important;
    color: #ffb3b3 !important;
    font-weight: 900; letter-spacing: .4px;
    text-shadow: 0 0 6px rgba(255,60,60,.4);
  }

  .changed { animation: highlight 1.6s ease; box-shadow: 0 6px 18px rgba(0,160,220,0.10) inset; }
  @keyframes highlight { 0% { background: rgba(0,163,255,0.35);} 100% { background: none; } }
  .fetching-indicator { animation: pulse 1s infinite; }
  @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

  footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 13px; color: var(--muted); gap: 10px; }
  #footerLeft { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

  /* Scrollbar */
  .table-container::-webkit-scrollbar{height:10px;width:10px}
  .table-container::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:6px}

  /* Barra superior (una línea con scroll si no entra) */
  .bar{ display:flex; align-items:center; gap:14px; margin-bottom:10px; flex-wrap:nowrap; overflow-x:auto; }
  .stockwrap{ display:flex; align-items:center; gap:10px; flex:1 1 auto; min-width:0; }
  .stocklabel { font-weight:800; color:#cfe8ff; opacity:.9; }
  .stockbar { display:block; overflow-x:auto; overflow-y:hidden; white-space:nowrap; flex:1 1 auto; }
  .pill {
    display:inline-flex; align-items:center; gap:8px;
    background: rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.08);
    padding: var(--stock-pad-y) var(--stock-pad-x);
    border-radius:999px;
    font-size: var(--stock-font-size);
    color:#e9f6ff;
    font-weight: 700;
    margin-right:8px;
  }
  .pill .dot { width:8px; height:8px; border-radius:50%; box-shadow: 0 0 8px rgba(255,255,255,.25); }

  /* Paleta de fondo por ítem (distinción visual) */
  .stock-theme-0 { background: rgba(40,120,255,.18);  border-color: rgba(40,120,255,.35); }
  .stock-theme-1 { background: rgba(255,160,40,.18);  border-color: rgba(255,160,40,.35); }
  .stock-theme-2 { background: rgba(60,200,140,.18);  border-color: rgba(60,200,140,.35); }
  .stock-theme-3 { background: rgba(180,70,255,.18);  border-color: rgba(180,70,255,.35); }
  .stock-theme-4 { background: rgba(255,80,120,.18);  border-color: rgba(255,80,120,.35); }
  .stock-theme-5 { background: rgba(0,200,220,.18);   border-color: rgba(0,200,220,.35);  }
  .stock-theme-6 { background: rgba(200,220,60,.18);  border-color: rgba(200,220,60,.35); }
  .stock-theme-7 { background: rgba(255,120,40,.18);  border-color: rgba(255,120,40,.35); }

  /* Semáforo: anillo + punto */
  .stock-low  { box-shadow: inset 0 0 0 2px rgba(220,60,60,.65);  }
  .stock-mid  { box-shadow: inset 0 0 0 2px rgba(255,180,0,.65); }
  .stock-high { box-shadow: inset 0 0 0 2px rgba(40,200,120,.65); }
  .stock-low  .dot{ background:#ff6b6b; }
  .stock-mid  .dot{ background:#ffcc66; }
  .stock-high .dot{ background:#4dffb3; }

  .delta { font-size:12px; color:#96d7ff; margin-left:8px; }

  /* Indicadores a la derecha */
  .indicators{ display:flex; align-items:center; gap:14px; flex:0 0 auto; min-width:max-content; }
  .ind{ background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); padding: 6px 10px; border-radius: 8px; font-weight:700; }

  /* Reel de fechas */
  .reel{ display:flex; align-items:center; gap:var(--reel-gap); overflow-x:auto; }
  .reel-btn { width: 28px; height: 28px; border-radius: 8px; border:1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); color:#cfe8ff; font-weight: 800; cursor: pointer; }
  .reel-btn:disabled { opacity:.4; cursor: default; }
  .date-chip { display:flex; flex-direction:column; align-items:center; justify-content:center; min-width: 132px; padding: var(--reel-pad); border-radius: 10px; background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08); }
  .date-chip.latest { background: linear-gradient(180deg, rgba(0,163,255,0.18), rgba(0,163,255,0.08)); border-color: rgba(0,163,255,0.35); }
  .date-chip .date { font-size: var(--reel-date-size); color:#bfe8ff; }
  .date-chip .num  { font-size: var(--reel-num-size); font-weight: 900; line-height: 1.1; }

  .subind{ font-size: 12px; color: #bfe8ff; margin-top: 4px; font-weight: 600; opacity: .95; }
  .status { padding:6px 12px; border-radius:999px; font-weight:800; }

  /* ====== Screensaver (protector) ====== */
  :root{ --brand-dark:#0b3e51; --brand-teal:#007c99; }
  #saver{ position:fixed; inset:0; z-index:9999; display:none; align-items:center; justify-content:center; text-align:center;
          background: radial-gradient(1200px 1200px at var(--x,50%) var(--y,50%), rgba(0,0,0,.28), rgba(0,0,0,.54));
          backdrop-filter: brightness(calc(0.88 - var(--night-dim,0))) saturate(110%);}
  #saver.on{ display:flex; }
  #saver .msg{ color:#e6f7ff; user-select:none; pointer-events:none; }
  #saver .clock{ margin-top:12px; font-size:12px; opacity:.85; color:#cdefff; }
  #saverLogo{ width:min(26vw,320px); max-width:45vh; opacity:.98; filter: drop-shadow(0 6px 20px rgba(0,0,0,.45)); }
  .mode-float #saverLogo{ animation: logoFloat 12s ease-in-out infinite, pixelDrift 60s linear infinite; }
  @keyframes logoFloat{ 0%,100%{ transform: translateY(0) scale(1) } 50%{ transform: translateY(-10px) scale(1.02) } }
  @keyframes pixelDrift{ 0%{transform:translate(0,0)}25%{transform:translate(4px,2px)}50%{transform:translate(0,4px)}75%{transform:translate(-3px,1px)}100%{transform:translate(0,0)} }
  .mode-frac .frac-strip{ display:flex; gap:8px; margin-top:18px; justify-content:center; }
  .mode-frac .stage{ width:26px; height:10px; border-radius:5px; background:#35d19f; opacity:.18; box-shadow: 0 0 10px rgba(53,209,159,.25); animation: stageLight 2.6s linear infinite; animation-delay: calc(var(--i)*0.11s); }
  @keyframes stageLight{ 0%,60%{opacity:.18} 72%{opacity:.95} 100%{opacity:.18} }
  .mode-bounce #bounceBox{ position:relative; width:100vw; height:100vh; }
  .mode-bounce #saverLogo{ position:absolute; }
  .mode-pulse .pads{ display:grid; grid-template-columns: repeat(8, min(8vw,80px)); gap:12px; margin-top:16px; justify-content:center; }
  .mode-pulse .pad{ width:min(8vw,80px); height:min(8vw,80px); border-radius:18%; background: radial-gradient(circle at 50% 40%, rgba(0,255,180,.35), rgba(0,255,180,.08)); box-shadow: inset 0 0 0 2px rgba(0,255,180,.20), 0 0 12px rgba(0,255,180,.15); animation: padPulse 3.8s ease-in-out infinite; animation-delay: calc(var(--i)*.12s); }
  @keyframes padPulse{ 0%,100%{transform:scale(1); opacity:.65} 50%{transform:scale(1.06); opacity:1} }

  /* ====== MODAL AJUSTES ====== */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:flex-start; justify-content:center; padding:40px 16px; z-index:10000; }
  .modal.on{ display:flex; }
  .card{ background:#0b1733; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:16px; width:min(860px,96vw); color:#eaf6ff; }
  .card h3{ margin:8px 0 12px; font-size:18px; }
  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .field{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:8px; }
  .field label{ font-weight:700; color:#cfe8ff; }
  .field input[type="number"], .field input[type="text"], .field select{ width:140px; padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.18); background:#0d2142; color:#eaf6ff; }
  .small{ font-size:12px; opacity:.85; }
  .line{ height:1px; background:rgba(255,255,255,.08); margin:10px 0; }
  .tbl{ width:100%; border-collapse:collapse; }
  .tbl th, .tbl td{ border:1px solid rgba(255,255,255,.08); padding:6px 8px; text-align:left; }
  .tbl th{ background:rgba(255,255,255,.06); }
  .right{ text-align:right; }
  .btns{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Visor de Estado PAD</h1>
      <div class="meta">Actualiza automáticamente</div>
    </div>
    <div class="controls">
      <label class="switch"><input id="autoScroll" type="checkbox" /> Auto-scroll (últimas 7)</label>
      <button class="btn" id="btnRefresh">Forzar actualización</button>
      <button class="btn secondary" id="btnPause">Pausar</button>
      <button class="btn secondary" id="btnFull">Pantalla completa</button>
      <button class="btn secondary" id="btnSettings">Ajustes</button>
    </div>
  </header>

  <main>
    <div class="board">
      <div class="bar">
        <div class="stockwrap">
          <div class="stocklabel">STOCK ACTUAL:</div>
          <div id="stockBar" class="stockbar"></div>
        </div>

        <div class="indicators">
          <div class="ind" id="fractureBox">
            <div id="fractureTotal">Total fracturas: 0</div>
            <div id="remainingStages" class="subind">Etapas restantes: 0</div>
          </div>
          <div id="datesReel" class="reel" aria-label="Fracturas por fecha (reel)"></div>
        </div>
      </div>

      <div class="table-container" id="tableContainer">
        <table id="mainTable">
          <thead>
            <tr id="hdrTop"><th class="rowid">#</th></tr>
            <tr id="hdrSub"><th class="rowid">&nbsp;</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <footer>
        <div id="footerLeft">
          <span>Última actualización: <strong id="lastUpdate">-</strong></span>
          <span id="delta" class="delta"></span>
          <span id="netStatus" class="pill status">Conectando…</span>
        </div>
        <div class="meta">Actualiza cada <span id="refreshSec">15</span>s</div>
      </footer>
    </div>
  </main>
</div>

<!-- Screensaver -->
<div id="saver" aria-hidden="true">
  <div class="msg">
    <div id="saverContent"></div>
    <div class="clock"></div>
  </div>
</div>

<!-- Modal Ajustes -->
<div id="modalSettings" class="modal" aria-hidden="true">
  <div class="card">
    <h3>Ajustes rápidos</h3>
    <div class="grid2">
      <div class="field">
        <label for="optPozoFont">Tamaño “POZO #n”</label>
        <input id="optPozoFont" type="number" min="12" max="28" step="1">
      </div>
      <div class="field">
        <label for="optStockFont">Tamaño “STOCK”</label>
        <input id="optStockFont" type="number" min="10" max="22" step="1">
      </div>
      <div class="field">
        <label for="optSaverMode">Protector de pantalla</label>
        <select id="optSaverMode">
          <option value="logoFloat">Logo flotante</option>
          <option value="fracStrip">Tira de etapas</option>
          <option value="wellPulse">Pads pulsantes</option>
          <option value="bouncingLogo">Logo rebotando</option>
          <option value="rotate">Rotar todos</option>
        </select>
      </div>
      <div class="field">
        <label for="optIdleMin">Minutos inactivo</label>
        <input id="optIdleMin" type="number" min="1" max="60" step="1">
      </div>
      <div class="field">
        <label for="optNightDim">Atenuación nocturna (0–0.8)</label>
        <input id="optNightDim" type="number" min="0" max="0.8" step="0.05">
      </div>
      <div class="field">
        <label for="optRotateEvery">Rotar cada (min)</label>
        <input id="optRotateEvery" type="number" min="1" max="30" step="1">
      </div>
    </div>

    <div class="line"></div>
    <h3>Reglas de stock <span class="small">(umbral bajo/medio y unidad)</span></h3>
    <div class="field" style="justify-content:flex-start; gap:8px;">
      <button class="btn secondary" id="btnLoadFromStock">Cargar ítems detectados</button>
      <button class="btn secondary" id="btnAddRule">Añadir regla</button>
    </div>
    <table class="tbl" id="rulesTable">
      <thead>
        <tr><th>Ítem</th><th>Unidad</th><th class="right">Bajo</th><th class="right">Medio</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="btns">
      <button class="btn secondary" id="btnCloseSettings">Cerrar</button>
      <button class="btn secondary" id="btnResetSettings">Restablecer</button>
      <button class="btn" id="btnSaveSettings">Guardar</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const JSON_URL = 'status.json';
  const REFRESH_SECONDS = 15;
  const ROWS = 60;
  const POZOS = 6;
  const LAST_N_TO_SHOW = 8;
  const REEL_SIZE = 2;

  /* ===== Umbrales base ===== */
  const STOCK_RULES_BASE = {
    'GAS OIL':             { unit: 'M3', thresholds: [50, 150] },
    'ARENA MALLA #100':    { unit: 'Tn', thresholds: [100, 300] },
    'ARENA MALLA #30/70':  { unit: 'Tn', thresholds: [300, 800] },
    'GEL BOLSONES':        { unit: 'ud', thresholds: [10, 25] },
    'GEL TOTE':            { unit: 'ud', thresholds: [5, 15] },
  };

  /* ===== Preferencias (localStorage) ===== */
  const prefs = {
    get(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; } catch{ return def; } },
    set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
    del(k){ localStorage.removeItem(k); }
  };

  /* ===== Estado UI ===== */
  let paused = prefs.get('ui:paused', false);
  let prevDataMap = {};
  let latestDataMap = {};
  let isFetching = false;
  let lastStockData = []; // guarda el último stock para re-render

  const tbody = document.getElementById('tbody');
  const hdrTop = document.getElementById('hdrTop');
  const hdrSub = document.getElementById('hdrSub');
  const tableContainer = document.getElementById('tableContainer');
  const autoScrollCheckbox = document.getElementById('autoScroll');
  const lastUpdateEl = document.getElementById('lastUpdate');
  const deltaEl = document.getElementById('delta');
  const net = document.getElementById('netStatus');
  const stockBar = document.getElementById('stockBar');
  const btnRefresh = document.getElementById('btnRefresh');
  const btnPause = document.getElementById('btnPause');
  const btnFull = document.getElementById('btnFull');
  const btnSettings = document.getElementById('btnSettings');
  const fractureTotalEl = document.getElementById('fractureTotal');
  const datesReel = document.getElementById('datesReel');
  const remainingEl = document.getElementById('remainingStages');

  autoScrollCheckbox.checked = prefs.get('ui:autoScroll', true);
  btnPause.innerText = paused ? 'Reanudar' : 'Pausar';
  document.getElementById('refreshSec').innerText = REFRESH_SECONDS;

  btnRefresh.addEventListener('click', handleForceRefresh);
  btnPause.addEventListener('click', togglePause);
  btnFull.addEventListener('click', () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
  });
  autoScrollCheckbox.addEventListener('change', () => {
    prefs.set('ui:autoScroll', autoScrollCheckbox.checked);
    if (autoScrollCheckbox.checked) requestAnimationFrame(() => scrollToLastWithData(LAST_N_TO_SHOW));
  });

  /* Atajos */
  window.addEventListener('keydown', e => {
    const k = e.key.toLowerCase();
    if (k === 'r') btnRefresh.click();
    if (k === 'p') btnPause.click();
    if (e.key === 'ArrowLeft')  datesReel.querySelector('.reel-btn:not(:disabled)')?.click();
    if (e.key === 'ArrowRight') datesReel.querySelectorAll('.reel-btn')?.[1]?.click();
  });

  function togglePause() {
    paused = !paused; prefs.set('ui:paused', paused);
    btnPause.innerText = paused ? 'Reanudar' : 'Pausar';
  }

  async function handleForceRefresh() {
    if (isFetching) return;
    const original = btnRefresh.innerText;
    btnRefresh.disabled = true; btnRefresh.innerText = 'Actualizando...';
    await loadAndRender(true);
    btnRefresh.innerText = original; btnRefresh.disabled = false;
  }

  function initializeDOM() {
    for (let i = 1; i <= POZOS; i++) {
      const thTop = document.createElement('th');
      thTop.className = `pozo-${i} pozoTop`;
      thTop.colSpan = 3;
      thTop.innerText = `POZO #${i}`;
      hdrTop.appendChild(thTop);

      const thSeq = document.createElement('th'); thSeq.className = 'seq'; thSeq.innerText = 'SEQ'; hdrSub.appendChild(thSeq);
      const thSub1 = document.createElement('th'); thSub1.innerText = 'TPN'; hdrSub.appendChild(thSub1);
      const thSub2 = document.createElement('th'); thSub2.innerText = 'FRACTURADO'; hdrSub.appendChild(thSub2);
    }

    const frag = document.createDocumentFragment();
    for (let i = 1; i <= ROWS; i++) {
      const id = '#' + String(i).padStart(2, '0');
      const tr = document.createElement('tr'); tr.dataset.rowId = id;
      if (i % 2 === 0) tr.classList.add('alt');

      const tdId = document.createElement('td'); tdId.className = 'rowid'; tdId.innerText = id; tr.appendChild(tdId);

      for (let p = 1; p <= POZOS; p++) {
        const tdSeq = document.createElement('td'); tdSeq.dataset.col = `Seq${p}`; tdSeq.className = 'seq'; tr.appendChild(tdSeq);
        const td1  = document.createElement('td'); td1.dataset.col  = `Pozo${p}`; tr.appendChild(td1);
        const td2  = document.createElement('td'); td2.dataset.col  = `Estado${p}`; tr.appendChild(td2);
      }
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
  }

  /* ========= Adaptadores JSON ========= */
  function transformItems(items) {
    if (!Array.isArray(items)) return [];
    return items.map((raw) => {
      const out = {};
      out.fila = (raw.Fila ?? raw.fila ?? '').toString();
      for (let i = 1; i <= POZOS; i++) {
        out['Seq'   + i] = (raw['SecuenciaPozo'   + i] ?? '').toString();
        out['Pozo'  + i] = (raw['TPNPozo'         + i] ?? '').toString();
        out['Estado'+ i] = (raw['FechaFracPozo'   + i] ?? '').toString();
      }
      return out;
    });
  }
  function extractHeaderRows(converted) {
    const headers = converted.filter(it => (it.fila || '').trim() === '');
    return { top: headers[0] || null, sub: headers[1] || null };
  }
  function itemsArrayToMap(converted) {
    const map = {};
    for (const it of converted) {
      const key = (it.fila || '').toString().trim();
      if (!key) continue;
      map[key] = it;
    }
    return map;
  }

  /* ========= Fechas ========= */
  function excelSerialToYMD(num){ const base = Date.UTC(1899, 11, 30); const ms = base + Math.round(num)*86400000; const d=new Date(ms); return { y:d.getUTCFullYear(), m:d.getUTCMonth()+1, d:d.getUTCDate() }; }
  function pad2(n){return String(n).padStart(2,'0');}
  function parseDateValue(val){
    const s = (val ?? '').toString().trim();
    if (!s) return null;
    let m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (m){ const y=+m[1], mo=+m[2], d=+m[3]; return { display:`${d}/${mo}/${y}`, normalized:`${y}-${pad2(mo)}-${pad2(d)}` }; }
    m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (m){ const d=+m[1], mo=+m[2], y=+m[3]; return { display:`${d}/${mo}/${y}`, normalized:`${y}-${pad2(mo)}-${pad2(d)}` }; }
    if (/^-?\d+(\.\d+)?$/.test(s)){ const n = Number(s.replace(',', '.')); if (Number.isFinite(n) && n >= 30000 && n <= 70000){ const {y,m:mo,d}=excelSerialToYMD(n); return { display:`${d}/${mo}/${y}`, normalized:`${y}-${pad2(mo)}-${pad2(d)}` }; } }
    return null;
  }
  function maybeFormatDate(val){ const p = parseDateValue(val); return p ? p.display : (val ?? ''); }
  function isStop(val){ return String(val ?? '').trim().toUpperCase() === 'STOP'; }
  function isFechaValida(val){ return parseDateValue(val) !== null; }

  /* ========= Encabezados ========= */
  function updateHeaderNames(topRow, subRow) {
    if (!topRow && !subRow) return;

    const newNames = [];
    for (let i = 1; i <= POZOS; i++) {
      const pTop = (topRow && topRow['Pozo' + i]) ? String(topRow['Pozo' + i]).trim() : '';
      const eTop = (topRow && topRow['Estado' + i]) ? String(topRow['Estado' + i]).trim() : '';
      const pSub = (subRow && subRow['Pozo' + i]) ? String(subRow['Pozo' + i]).trim() : '';
      const eSub = (subRow && subRow['Estado' + i]) ? String(subRow['Estado' + i]).trim() : '';

      let topLabel = pTop || pSub || `POZO #${i}`;
      let topSuffix = eTop || '';
      if (!topSuffix && eSub && !/^TPN$/i.test(eSub)) topSuffix = eSub;

      const headerText = (topLabel + (topSuffix ? (' ' + topSuffix) : '')).trim();
      newNames.push(headerText);
    }

    hdrTop.querySelectorAll('th.pozoTop').forEach((th, idx) => { th.innerText = newNames[idx] || `POZO #${idx+1}`; });

    const subCells = hdrSub.querySelectorAll('th');
    for (let i = 1; i <= POZOS; i++) {
      const pSub = (subRow && subRow['Pozo' + i]) ? String(subRow['Pozo' + i]).trim() : 'TPN';
      const eSub = (subRow && subRow['Estado' + i]) ? String(subRow['Estado' + i]).trim() : 'FRACTURADO';
      const base = (i - 1) * 3 + 1;
      if (subCells[base])     subCells[base].innerText     = 'SEQ';
      if (subCells[base + 1]) subCells[base + 1].innerText = pSub || 'TPN';
      if (subCells[base + 2]) subCells[base + 2].innerText = eSub || 'FRACTURADO';
    }
  }

  /* ========= Tabla ========= */
  function hasVisibleData(dataObj) {
    if (!dataObj) return false;
    for (let i = 1; i <= POZOS; i++) {
      const tpn = String(dataObj['Pozo' + i] ?? '').trim();
      const estado = dataObj['Estado' + i];
      if (tpn !== '' || (estado && !isStop(estado) && isFechaValida(estado))) return true;
    }
    return false;
  }

  function updateRowCells(rowId, newData) {
    const tr = tbody.querySelector(`tr[data-row-id="${rowId}"]`);
    if (!tr) return { changed: false, cells: 0 };
    let changedAny = false, changedCells = 0;

    for (let p = 1; p <= POZOS; p++) {
      const tdSeq = tr.querySelector(`td[data-col="Seq${p}"]`);
      const td1  = tr.querySelector(`td[data-col="Pozo${p}"]`);
      const td2  = tr.querySelector(`td[data-col="Estado${p}"]`);

      const vSeq = (newData && newData['Seq' + p]) ? String(newData['Seq' + p]) : '';
      const v1   = (newData && newData['Pozo' + p]) ? String(newData['Pozo' + p]) : '';
      const v2raw= (newData && newData['Estado' + p]) ? newData['Estado' + p] : '';
      const v2   = maybeFormatDate(v2raw);

      if (tdSeq && tdSeq.innerText !== vSeq) { tdSeq.innerText = vSeq; changedAny = true; changedCells++; }
      if (td1   && td1.innerText   !== v1 ) { td1.innerText   = v1;  changedAny = true; changedCells++; }
      if (td2   && td2.innerText   !== v2 ) { td2.innerText   = v2;  changedAny = true; changedCells++; }

      if (td2){
        const isS = (String(v2raw).trim().toUpperCase() === 'STOP') || (String(v2).trim().toUpperCase() === 'STOP');
        td2.classList.toggle('stop', isS);
      }
    }
    return { changed: changedAny, cells: changedCells };
  }

  function updateDOM(dataMap) {
    const changedRows = [];
    let changedCellsTotal = 0;

    for (let i = 1; i <= ROWS; i++) {
      const id = '#' + String(i).padStart(2, '0');
      const newObj = dataMap[id] || {};
      const newString = JSON.stringify(newObj);
      const prevString = prevDataMap[id];

      if (prevString === undefined) {
        prevDataMap[id] = newString;
        latestDataMap[id] = newObj;
        const { cells } = updateRowCells(id, newObj);
        changedCellsTotal += cells;
        continue;
      }

      if (prevString !== newString) {
        const { changed, cells } = updateRowCells(id, newObj);
        if (changed) changedRows.push(id);
        changedCellsTotal += cells;
        prevDataMap[id] = newString;
        latestDataMap[id] = newObj;
      } else {
        latestDataMap[id] = newObj;
      }
    }
    return { changedRows, changedCellsTotal };
  }

  /* ========= Métricas ========= */
  let datesArr = []; let reelStart = prefs.get('reel:start', 0); let userMovedReel = prefs.get('reel:moved', false);

  function computeFractureStats(converted){
    const freq = new Map(); let total = 0;
    for (const it of converted){
      if (!it.fila || !it.fila.trim()) continue;
      for (let i = 1; i <= POZOS; i++){
        const p = parseDateValue(it['Estado'+i]);
        if (p){ total++; const cur = freq.get(p.normalized); if (cur) cur.count++; else freq.set(p.normalized, { display: p.display, count: 1, normalized: p.normalized }); }
      }
    }
    return { total, freq };
  }
  function renderFractureTotal(total){ fractureTotalEl.textContent = `Total fracturas: ${total}`; }

  function updateDatesArray(freq){
    const arr = Array.from(freq.values()).sort((a,b)=> a.normalized.localeCompare(b.normalized));
    datesArr = arr;
    const maxStart = Math.max(0, datesArr.length - REEL_SIZE);
    if (!userMovedReel) reelStart = maxStart; else reelStart = Math.min(reelStart, maxStart);
    prefs.set('reel:start', reelStart); renderDatesReel();
  }

  function renderDatesReel(){
    datesReel.innerHTML = '';
    if (!datesArr.length){
      const empty = document.createElement('div'); empty.className = 'pill'; empty.textContent = 'Sin fechas'; datesReel.appendChild(empty); return;
    }
    const maxStart = Math.max(0, datesArr.length - REEL_SIZE);

    const btnPrev = document.createElement('button'); btnPrev.className = 'reel-btn'; btnPrev.textContent = '‹';
    btnPrev.disabled = (reelStart === 0);
    btnPrev.onclick = () => { reelStart = Math.max(0, reelStart - REEL_SIZE); userMovedReel = true; prefs.set('reel:moved', true); prefs.set('reel:start', reelStart); renderDatesReel(); };
    datesReel.appendChild(btnPrev);

    for (let k = 0; k < REEL_SIZE; k++){
      const idx = reelStart + k; if (idx >= datesArr.length) break;
      const d = datesArr[idx];
      const chip = document.createElement('div'); const isLatest = (idx === datesArr.length - 1);
      chip.className = 'date-chip' + (isLatest ? ' latest' : '');
      const dd = document.createElement('div'); dd.className = 'date'; dd.textContent = d.display;
      const nn = document.createElement('div'); nn.className = 'num';  nn.textContent = d.count;
      chip.append(dd, nn); datesReel.appendChild(chip);
    }

    const btnNext = document.createElement('button'); btnNext.className = 'reel-btn'; btnNext.textContent = '›';
    btnNext.disabled = (reelStart >= maxStart);
    btnNext.onclick = () => { reelStart = Math.min(maxStart, reelStart + REEL_SIZE); userMovedReel = true; prefs.set('reel:moved', true); prefs.set('reel:start', reelStart); renderDatesReel(); };
    datesReel.appendChild(btnNext);
  }

  /* ========= Etapas restantes ========= */
  function computeRemainingStages(converted){
    const rows = converted
      .filter(it => (it.fila || '').trim())
      .map(it => { const m = (it.fila || '').trim().match(/^#?(\d+)/); return { ...it, _row: m ? parseInt(m[1], 10) : NaN }; })
      .filter(it => Number.isFinite(it._row))
      .sort((a,b) => a._row - b._row);

    let total = 0;
    for (let p = 1; p <= POZOS; p++){
      let stopRow = null;
      for (const r of rows){ const v = (r['Estado' + p] || '').toString().trim().toUpperCase(); if (v === 'STOP'){ stopRow = r._row; break; } }
      if (!stopRow) continue;
      for (const r of rows){ if (r._row >= stopRow) break; const raw = (r['Estado' + p] || '').toString().trim(); if (raw === '') total++; }
    }
    return total;
  }
  function renderRemaining(n){ remainingEl.textContent = `Etapas restantes: ${n}`; }

  /* ========= Stock + semáforo ========= */
  function parseNumberFromStock(s) { if (!s) return NaN; const m = s.toString().replace(',', '.').match(/-?\d+(\.\d+)?/); return m ? parseFloat(m[0]) : NaN; }
  function getMergedRules(){
    const override = prefs.get('stock:rules', {});
    return { ...STOCK_RULES_BASE, ...override };
  }
  function stockClassByLevel(item, value) {
    const rules = getMergedRules();
    const rule = rules[item.toUpperCase()];
    if (!rule || !Number.isFinite(value)) return 'stock-mid';
    const [low, mid] = rule.thresholds;
    if (value < low) return 'stock-low';
    if (value <= mid) return 'stock-mid';
    return 'stock-high';
  }
  const itemThemeIdx = new Map();
  function renderStock(stockArr = []) {
    lastStockData = stockArr;
    stockBar.innerHTML = '';
    if (!Array.isArray(stockArr) || stockArr.length === 0) return;
    let idx = 0;
    for (const s of stockArr) {
      const itemName = (s.ITEM ?? '').toString();
      const qtyStr   = (s.STOCK ?? '').toString();
      const value    = parseNumberFromStock(qtyStr);
      if (!itemThemeIdx.has(itemName)) itemThemeIdx.set(itemName, idx++ % 8);
      const theme = `stock-theme-${itemThemeIdx.get(itemName)}`;
      const level = stockClassByLevel(itemName, value);

      const div = document.createElement('div'); div.className = `pill ${theme} ${level}`;
      const dot = document.createElement('span'); dot.className = 'dot';
      const txt = document.createElement('span'); txt.textContent = `${itemName}: ${qtyStr}`;
      div.append(dot, txt); stockBar.appendChild(div);
    }
  }

  /* ========= Badges por pozo ========= */
  function remainingPerPozo(converted){
    const rows = converted
      .filter(it => (it.fila || '').trim())
      .map(it => { const m = (it.fila || '').trim().match(/^#?(\d+)/); return { ...it, _row: m ? parseInt(m[1], 10) : NaN }; })
      .filter(it => Number.isFinite(it._row))
      .sort((a,b) => a._row - b._row);

    const result = Array(POZOS).fill(0);
    for (let p = 1; p <= POZOS; p++){
      let stopRow = null;
      for (const r of rows){ const v = (r['Estado' + p] || '').toString().trim().toUpperCase(); if (v === 'STOP'){ stopRow = r._row; break; } }
      if (!stopRow) continue;
      for (const r of rows){ if (r._row >= stopRow) break; if ((r['Estado' + p] || '').toString().trim() === '') result[p-1]++; }
    }
    return result;
  }
  function paintBadgesPerPozo(arr){
    const ths = document.querySelectorAll('#hdrTop th.pozoTop');
    ths.forEach((th, i) => {
      th.querySelectorAll('.badge').forEach(b => b.remove());
      const val = arr[i] ?? 0;
      if (val > 0){ const b = document.createElement('span'); b.className = 'badge'; b.textContent = val; th.appendChild(b); }
    });
  }

  /* ========= Carga ========= */
  async function loadAndRender(isForced = false) {
    if (paused && !isForced) return;
    if (isFetching) return;
    isFetching = true;

    try {
      const t0 = performance.now();
      const res = await fetch(`${JSON_URL}?_=${Date.now()}`, { cache: 'no-store' });
      const t1 = performance.now();
      if (!res.ok) throw new Error('HTTP ' + res.status);
      net.textContent = `OK ${Math.round(t1 - t0)}ms`;
      net.style.background = 'rgba(0,180,60,.2)';
      net.style.borderColor = 'rgba(0,180,60,.35)';

      const json = await res.json();
      const lu = json.lastUpdate ? new Date(json.lastUpdate) : new Date();
      lastUpdateEl.innerText = lu.toLocaleString();

      renderStock(json.stock || []);
      const converted = transformItems(json.items || []);
      const { top, sub } = extractHeaderRows(converted);
      updateHeaderNames(top, sub);
      const dataMap = itemsArrayToMap(converted);

      const { changedRows, changedCellsTotal } = updateDOM(dataMap);
      deltaEl.textContent = changedCellsTotal > 0 ? `• ${changedCellsTotal} cambio(s)` : '';

      const stats = computeFractureStats(converted);
      renderFractureTotal(stats.total);
      updateDatesArray(stats.freq);

      const remaining = computeRemainingStages(converted);
      renderRemaining(remaining);
      const perPozo = remainingPerPozo(converted);
      paintBadgesPerPozo(perPozo);

      if (autoScrollCheckbox.checked) requestAnimationFrame(() => scrollToLastWithData(LAST_N_TO_SHOW));

      /* — actividad para el protector — */
      saver.lastChangeTs = Date.now();
      hideSaver();

    } catch (err) {
      console.error('Error al cargar datos:', err);
      lastUpdateEl.innerHTML = `<span style="color:salmon">Error de conexión</span>`;
      deltaEl.textContent = '';
      net.textContent = 'ERROR';
      net.style.background = 'rgba(220,60,60,.25)';
      net.style.borderColor = 'rgba(220,60,60,.4)';
    } finally {
      isFetching = false;
    }
  }

  function scrollToLastWithData(n = LAST_N_TO_SHOW) {
    if (!autoScrollCheckbox.checked) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const idxWithData = [];
    rows.forEach((tr, idx) => { const id = tr.dataset.rowId; if (hasVisibleData(latestDataMap[id])) idxWithData.push(idx); });
    if (idxWithData.length === 0) return;
    const startIdx = idxWithData[Math.max(0, idxWithData.length - n)];
    const startRow = rows[startIdx]; if (!startRow) return;
    const headerHeight = hdrTop.offsetHeight + hdrSub.offsetHeight;
    const targetTop = startRow.offsetTop - headerHeight - 8;
    tableContainer.scrollTo({ top: Math.max(0, targetTop), behavior: 'smooth' });
  }

  /* ====== Screensaver (todos los modos + ajustes) ====== */
  const LOGO_URL = 'logo-pluspetrol.png';
  const saverEl = document.getElementById('saver');
  const saverContent = document.getElementById('saverContent');
  const saver = {
    mode: prefs.get('saver:mode','rotate'),
    idleMinutes: prefs.get('saver:idle', 2),
    nightDim: prefs.get('saver:night', 0.35),
    rotateEvery: prefs.get('saver:rotateEvery', 3),
    lastChangeTs: Date.now(),
    tick: null, rotTick: null, bounceRAF: null,
  };

  function kickActivity(){ saver.lastChangeTs = Date.now(); hideSaver(); }
  ['mousemove','keydown','click','wheel','touchstart'].forEach(evt => document.addEventListener(evt, kickActivity, {passive:true}));

  function showSaver(){
    if (saverEl.classList.contains('on')) return;
    const h = new Date().getHours(); const night = (h >= 22 || h <= 6);
    saverEl.style.setProperty('--night-dim', night ? saver.nightDim : 0);
    saverEl.style.setProperty('--x', `${40 + Math.random()*20}%`);
    saverEl.style.setProperty('--y', `${40 + Math.random()*20}%`);
    const mode = (saver.mode === 'rotate') ? nextModeForRotate() : saver.mode;
    buildSaver(mode);
    saverEl.classList.add('on'); renderSaverClock();
  }
  function hideSaver(){ saverEl.classList.remove('on'); clearBounce(); }
  function renderSaverClock(){ const el = saverEl.querySelector('.clock'); if (el) el.textContent = new Date().toLocaleString(); }
  function checkSaver(){ const idle = (Date.now() - saver.lastChangeTs)/60000; if (idle >= saver.idleMinutes) showSaver(); else hideSaver(); renderSaverClock(); }
  saver.tick = setInterval(checkSaver, 10000);

  const MODES = ['logoFloat','fracStrip','wellPulse','bouncingLogo'];
  let rotateIdx = 0;
  function nextModeForRotate(){ const m = MODES[rotateIdx % MODES.length]; rotateIdx++; return m; }
  if (saver.mode === 'rotate') saver.rotTick = setInterval(() => { if (saverEl.classList.contains('on')) showSaver(); }, saver.rotateEvery*60000);

  function buildSaver(mode){
    saverEl.classList.remove('mode-float','mode-frac','mode-bounce','mode-pulse');
    saverContent.innerHTML = ''; clearBounce();
    if (mode === 'logoFloat'){
      saverEl.classList.add('mode-float');
      const img = new Image(); img.id = 'saverLogo'; img.src = LOGO_URL; saverContent.appendChild(img);
    } else if (mode === 'fracStrip'){
      saverEl.classList.add('mode-frac');
      const img = new Image(); img.id = 'saverLogo'; img.src = LOGO_URL;
      const strip = document.createElement('div'); strip.className = 'frac-strip';
      for (let i=0;i<24;i++){ const s=document.createElement('span'); s.className='stage'; s.style.setProperty('--i',i); strip.appendChild(s); }
      saverContent.append(img, strip);
    } else if (mode === 'bouncingLogo'){
      saverEl.classList.add('mode-bounce');
      const box = document.createElement('div'); box.id='bounceBox';
      const img = new Image(); img.id='saverLogo'; img.src = LOGO_URL; box.appendChild(img);
      saverContent.appendChild(box); startBounce(img, box);
    } else if (mode === 'wellPulse'){
      saverEl.classList.add('mode-pulse');
      const img = new Image(); img.id = 'saverLogo'; img.src = LOGO_URL;
      const pads = document.createElement('div'); pads.className = 'pads';
      const N = 24; for (let i=0;i<N;i++){ const p = document.createElement('span'); p.className='pad'; p.style.setProperty('--i',i); pads.appendChild(p); }
      saverContent.append(img, pads);
    }
  }
  function startBounce(img, box){
    let x=80, y=80, vx=2.1, vy=1.6;
    function step(){
      const bw = box.clientWidth, bh = box.clientHeight, w = img.clientWidth, h = img.clientHeight;
      x += vx; y += vy;
      if (x<=0 || x+w>=bw){ vx = -vx; tintLogo(img); }
      if (y<=0 || y+h>=bh){ vy = -vy; tintLogo(img); }
      img.style.transform = `translate(${Math.max(0,Math.min(x,bw-w))}px,${Math.max(0,Math.min(y,bh-h))}px)`;
      saver.bounceRAF = requestAnimationFrame(step);
    }
    saver.bounceRAF = requestAnimationFrame(step);
  }
  function clearBounce(){ if (saver.bounceRAF){ cancelAnimationFrame(saver.bounceRAF); saver.bounceRAF = null; } }
  function tintLogo(img){ img.style.filter = `drop-shadow(0 6px 18px rgba(0,0,0,.45)) hue-rotate(${Math.round(Math.random()*20-10)}deg)`; }

  /* ====== Ajustes (UI) ====== */
  const modal = document.getElementById('modalSettings');
  const optPozoFont = document.getElementById('optPozoFont');
  const optStockFont = document.getElementById('optStockFont');
  const optSaverMode = document.getElementById('optSaverMode');
  const optIdleMin = document.getElementById('optIdleMin');
  const optNightDim = document.getElementById('optNightDim');
  const optRotateEvery = document.getElementById('optRotateEvery');
  const rulesTable = document.getElementById('rulesTable').querySelector('tbody');

  btnSettings.addEventListener('click', openSettings);
  document.getElementById('btnCloseSettings').addEventListener('click', () => modal.classList.remove('on'));
  document.getElementById('btnResetSettings').addEventListener('click', resetSettings);
  document.getElementById('btnSaveSettings').addEventListener('click', saveSettings);
  document.getElementById('btnLoadFromStock').addEventListener('click', () => {
    const names = Array.from(new Set((lastStockData||[]).map(s=> (s.ITEM||'').toString().trim()).filter(Boolean)));
    names.forEach(name => addOrUpdateRuleRow(name.toUpperCase()));
  });
  document.getElementById('btnAddRule').addEventListener('click', () => addOrUpdateRuleRow('NUEVO ITEM'));

  function openSettings(){
    optPozoFont.value = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--pozo-font-size')) || 18;
    optStockFont.value = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--stock-font-size')) || 14;
    optSaverMode.value = saver.mode;
    optIdleMin.value = saver.idleMinutes;
    optNightDim.value = saver.nightDim;
    optRotateEvery.value = saver.rotateEvery;
    buildRulesTable();
    modal.classList.add('on');
  }

  function resetSettings(){
    prefs.del('ui:pozoFont'); prefs.del('ui:stockFont');
    prefs.del('saver:mode'); prefs.del('saver:idle'); prefs.del('saver:night'); prefs.del('saver:rotateEvery');
    prefs.del('stock:rules');
    applyPrefs(); renderStock(lastStockData); modal.classList.remove('on');
  }

  function saveSettings(){
    const pf = clamp(+optPozoFont.value, 12, 28);
    const sf = clamp(+optStockFont.value, 10, 22);
    const im = clamp(+optIdleMin.value, 1, 60);
    const nd = clamp(+optNightDim.value, 0, 0.8);
    const re = clamp(+optRotateEvery.value, 1, 30);
    prefs.set('ui:pozoFont', pf);
    prefs.set('ui:stockFont', sf);
    prefs.set('saver:mode', optSaverMode.value);
    prefs.set('saver:idle', im);
    prefs.set('saver:night', nd);
    prefs.set('saver:rotateEvery', re);

    const rules = tableToRules();
    prefs.set('stock:rules', rules);

    applyPrefs(); renderStock(lastStockData); modal.classList.remove('on');
    if (saverEl.classList.contains('on')) showSaver();
  }

  function clamp(v, min, max){ return Math.min(max, Math.max(min, isNaN(v)?min:v)); }

  function buildRulesTable(){
    rulesTable.innerHTML = '';
    const merged = getMergedRules();
    Object.keys(merged).sort().forEach(name => addRuleRow(name, merged[name]));
  }
  function addOrUpdateRuleRow(name){
    const merged = getMergedRules();
    addRuleRow(name, merged[name] || { unit:'', thresholds:[0,0] });
  }
  function addRuleRow(name, rule){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="${name}" /></td>
      <td><input type="text" value="${(rule.unit||'')}" /></td>
      <td class="right"><input type="number" step="0.01" value="${(rule.thresholds?.[0]??0)}" /></td>
      <td class="right"><input type="number" step="0.01" value="${(rule.thresholds?.[1]??0)}" /></td>
      <td class="right"><button class="btn secondary">Quitar</button></td>
    `;
    tr.querySelector('button').onclick = () => tr.remove();
    rulesTable.appendChild(tr);
  }
  function tableToRules(){
    const out = {};
    rulesTable.querySelectorAll('tr').forEach(tr => {
      const [nameEl, unitEl, lowEl, midEl] = tr.querySelectorAll('input');
      const name = (nameEl.value||'').toUpperCase().trim(); if (!name) return;
      const low = parseFloat(lowEl.value)||0, mid=parseFloat(midEl.value)||0;
      out[name] = { unit: (unitEl.value||'').trim(), thresholds:[low, mid] };
    });
    return out;
  }

  function applyPrefs(){
    const pf = prefs.get('ui:pozoFont', 18);
    const sf = prefs.get('ui:stockFont', 14);
    document.documentElement.style.setProperty('--pozo-font-size', pf + 'px');
    document.documentElement.style.setProperty('--stock-font-size', sf + 'px');

    saver.mode = prefs.get('saver:mode','rotate');
    saver.idleMinutes = prefs.get('saver:idle',2);
    saver.nightDim = prefs.get('saver:night',0.35);
    saver.rotateEvery = prefs.get('saver:rotateEvery',3);
    if (saver.rotTick){ clearInterval(saver.rotTick); saver.rotTick = null; }
    if (saver.mode === 'rotate'){ saver.rotTick = setInterval(() => { if (saverEl.classList.contains('on')) showSaver(); }, saver.rotateEvery*60000); }
  }

  /* ===== Init ===== */
  initializeDOM();
  applyPrefs();
  loadAndRender(true);
  setInterval(() => loadAndRender(false), REFRESH_SECONDS * 1000);

  /* Utils */
  function renderSaverClock(){ const el = document.querySelector('#saver .clock'); if (el) el.textContent = new Date().toLocaleString(); }
});
</script>
</body>
</html>
