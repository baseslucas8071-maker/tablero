<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visor de Estado - TV</title>
<style>
  :root{
    --bg:#071027;
    --card:#08203a;
    --muted:#cfe8ff;
    --accent:#00a3ff;
    --row-alt: #eaf5ff;
    --row-alt-2: #ffffff;
    --header-height: 88px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Segoe UI,Arial,sans-serif}
  .wrap{padding:18px;box-sizing:border-box;display:flex;flex-direction:column;height:100%}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  header h1{margin:0;font-size:34px;letter-spacing:0.6px}
  header .meta{opacity:0.9;font-size:14px;color:var(--muted)}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:#0b61a8;border:none;color:white;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.08)}
  .switch{display:flex;align-items:center;gap:8px;font-size:14px}
  main{flex:1;margin-top:14px;display:flex;gap:18px;align-items:stretch}
  .board{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px;box-sizing:border-box;overflow:hidden;display:flex;flex-direction:column}
  .table-wrap{flex:1;background:transparent;border-radius:8px;overflow:auto;position:relative}
  table{border-collapse:collapse;width:100%;min-width:1100px}
  th,td{border:1px solid rgba(255,255,255,0.06);padding:6px 8px;text-align:center}
  thead th{background:transparent}
  /* sticky headers: first header row sticks at top 0, second header below it */
  thead tr:first-child th{position:sticky;top:0;z-index:5;padding-top:10px;padding-bottom:10px;font-size:18px}
  thead tr:nth-child(2) th{position:sticky;top:44px;z-index:6;padding:6px 8px;background:rgba(0,0,0,0.15);font-weight:700}
  tbody td{height:36px;background:rgba(255,255,255,0.02);color:#e6f7ff}
  tbody tr.alt td{background:rgba(255,255,255,0.02)}
  /* column 0 (row id) */
  td.rowid{background:rgba(255,255,255,0.03);font-weight:700;color:#bfe8ff;position:sticky;left:0;z-index:4}
  thead th:first-child{position:sticky;left:0;top:0;z-index:10;background:linear-gradient(90deg, rgba(8,8,8,0.6), rgba(8,8,8,0.4));}
  thead tr:nth-child(2) th:first-child{top:44px}
  /* colors per pozo group */
  .pozo-1{background:linear-gradient(90deg,#ffd83a,#ffd83a); color:#002;}
  .pozo-2{background:linear-gradient(90deg,#7ad39a,#5fbf87); color:#002;}
  .pozo-3{background:linear-gradient(90deg,#74b3ff,#4686ff); color:#002;}
  .pozo-4{background:linear-gradient(90deg,#ff7b7b,#ff4c4c); color:#002;}
  .pozo-5{background:linear-gradient(90deg,#dfe6ea,#cfd9de); color:#002;}
  .pozo-6{background:linear-gradient(90deg,#e6f7ff,#d2efff); color:#002;text-transform:uppercase}
  /* highlight on change */
  .changed { animation: highlight 2s ease; box-shadow: 0 6px 18px rgba(0,160,220,0.12) inset; }
  @keyframes highlight {
    0% { background: rgba(255,255,0,0.45); transform: translateY(-4px); }
    100% { background: none; transform: translateY(0); }
  }
  footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-size:13px;color:var(--muted)}
  .indicators{display:flex;gap:12px;align-items:center}
  .ind{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:8px;font-weight:700}
  /* responsive smaller screens */
  @media(max-width:900px){
    header h1{font-size:20px}
    thead tr:first-child th{font-size:14px}
    thead tr:nth-child(2) th{font-size:12px}
    td,th{padding:6px 4px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Visor de Estado — Pozos</h1>
        <div class="meta">Kiosk / TV • Actualiza automáticamente</div>
      </div>
      <div class="controls">
        <div class="switch">
          <label style="font-size:13px;color:#cfe8ff">Mover filas actualizadas al inicio</label>
          <input id="moveUpdated" type="checkbox" checked />
        </div>
        <button class="btn" id="btnRefresh">Forzar actualización</button>
        <button class="btn secondary" id="btnPause">Pausar</button>
      </div>
    </header>

    <main>
      <div class="board">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-size:16px">Última actualización: <strong id="lastUpdate">-</strong></div>
          <div class="indicators">
            <div class="ind" id="totalCount">Total: 0</div>
            <div class="ind" id="alertCount">Alertas: 0</div>
          </div>
        </div>

        <div class="table-wrap" id="tableWrap">
          <table id="mainTable" aria-label="Visor">
            <thead>
              <tr id="hdrTop">
                <!-- first top-left empty cell -->
                <th style="width:90px">#</th>
                <!-- POZO top headers inserted dynamically -->
              </tr>
              <tr id="hdrSub">
                <th>&nbsp;</th>
                <!-- Subheaders (TPN / FRACTURADO) inserted dynamically -->
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- Rows injected here -->
            </tbody>
          </table>
        </div>

        <footer>
          <div class="meta">Fuente: status.json (GitHub Pages)</div>
          <div class="meta">Actualiza cada <span id="refreshSec">15</span>s</div>
        </footer>
      </div>
    </main>
  </div>

<script>
/*
  Visor configurable
  - JSON_URL: ruta al status.json
*/
const JSON_URL = 'status.json';
const REFRESH_SECONDS = 15;
const ROWS = 60;

let pozoNames = [
  "POZO #1", "POZO #2", "POZO #3", "POZO #4", "POZO #5", "POZO #6"
];

let paused = false;
let prevMap = {};
let latestDataMap = {};

// Ocultamos la opción de mover filas, ya que la nueva lógica no la necesita.
document.addEventListener('DOMContentLoaded', () => {
    const moveUpdatedSwitch = document.getElementById('moveUpdated')?.parentElement;
    if (moveUpdatedSwitch) {
        moveUpdatedSwitch.style.display = 'none';
    }
});

document.getElementById('refreshSec').innerText = REFRESH_SECONDS;
document.getElementById('btnRefresh').addEventListener('click', () => loadAndRender(true));
document.getElementById('btnPause').addEventListener('click', togglePause);

function togglePause() {
  paused = !paused;
  document.getElementById('btnPause').innerText = paused ? 'Reanudar' : 'Pausar';
}

function buildHeaders() {
  const hdrTop = document.getElementById('hdrTop');
  const hdrSub = document.getElementById('hdrSub');

  hdrTop.querySelectorAll('th.pozoTop').forEach(n => n.remove());
  hdrSub.querySelectorAll('th.pozoSub').forEach(n => n.remove());

  pozoNames.forEach((name, idx) => {
    const top = document.createElement('th');
    top.className = `pozo-${idx+1} pozoTop`;
    top.colSpan = 2;
    top.style.fontWeight = 800;
    top.style.fontSize = '16px';
    top.innerText = name;
    hdrTop.appendChild(top);

    const sub1 = document.createElement('th');
    sub1.className = 'pozoSub';
    sub1.innerText = 'TPN';
    const sub2 = document.createElement('th');
    sub2.className = 'pozoSub';
    sub2.innerText = 'FRACTURADO';
    hdrSub.appendChild(sub1);
    hdrSub.appendChild(sub2);
  });
}

function itemsArrayToMap(items) {
  const map = {};
  if (!Array.isArray(items)) return map;
  for (const it of items) {
    let key = it['fila'] || null;
    if (key) {
      map[String(key).trim()] = it;
    }
  }
  return map;
}

function renderTable(rowsToRender) {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  const totalConDatos = Object.values(latestDataMap).filter(obj => tieneDatosVisibles(obj)).length;
  let alertCount = 0;

  rowsToRender.forEach((rowId, rIndex) => {
    const tr = document.createElement('tr');
    if (rIndex % 2 === 0) tr.classList.add('alt');

    const tdId = document.createElement('td');
    tdId.className = 'rowid';
    tdId.innerText = rowId;
    tr.appendChild(tdId);

    const dataObj = latestDataMap[rowId] || {};

    pozoNames.forEach((_, pozoIndex) => {
      const pozoNum = pozoIndex + 1;
      const td1 = document.createElement('td');
      const val1 = dataObj['Pozo' + pozoNum] || '';
      td1.innerText = val1;
      tr.appendChild(td1);

      const td2 = document.createElement('td');
      const val2 = dataObj['Estado' + pozoNum] || '';
      td2.innerText = val2;
      tr.appendChild(td2);

      const alertVal = String(val2).toUpperCase();
      if (alertVal.includes('FRACT') || alertVal.includes('ALERT') || alertVal.includes('FAULT')) {
        alertCount++;
      }
    });

    tbody.appendChild(tr);
  });

  document.getElementById('totalCount').innerText = `Total: ${totalConDatos}`;
  document.getElementById('alertCount').innerText = `Alertas: ${alertCount}`;
}


function applyChangeHighlights(changedIds) {
  const tbody = document.getElementById('tbody');
  for (const rowId of changedIds) {
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const tr = rows.find(tr => tr.querySelector('td.rowid')?.innerText === rowId);
    if (tr) {
      tr.classList.add('changed');
      setTimeout(() => tr.classList.remove('changed'), 2200);
    }
  }
}

// ✅ NUEVA FUNCIÓN: Revisa si una fila tiene texto en sus columnas TPN o FRACTURADO.
function tieneDatosVisibles(dataObj) {
    if (!dataObj || !dataObj.fila.startsWith('#')) return false;
    for (let i = 1; i <= pozoNames.length; i++) {
        const pozoVal = dataObj['Pozo' + i];
        const estadoVal = dataObj['Estado' + i];
        if ((pozoVal && String(pozoVal).trim() !== '') || (estadoVal && String(estadoVal).trim() !== '')) {
            return true; // Si encuentra al menos un dato, la fila es válida.
        }
    }
    return false; // Si todas las columnas están vacías, la fila no se cuenta.
}

async function loadAndRender(force = false) {
  if (paused && !force) return;
  try {
    const res = await fetch(JSON_URL + '?_=' + Date.now(), { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();

    document.getElementById('lastUpdate').innerText = new Date().toLocaleString();

    if (json.items && Array.isArray(json.items)) {
      const headerData = json.items.find(item => item.fila === "");
      if (headerData) {
        const newPozoNames = [];
        for (let i = 1; i <= 6; i++) {
          const pozoKey = 'Pozo' + i;
          const estadoKey = 'Estado' + i;
          if (headerData[pozoKey] && headerData[estadoKey]) {
            newPozoNames.push(`${headerData[pozoKey]} ${headerData[estadoKey]}`);
          }
        }
        if (newPozoNames.length > 0 && JSON.stringify(pozoNames) !== JSON.stringify(newPozoNames)) {
          pozoNames = newPozoNames;
          buildHeaders();
        }
      }
    }

    const newMap = itemsArrayToMap(json.items || []);
    latestDataMap = newMap;

    const changed = [];
    for (const [rowId, obj] of Object.entries(newMap)) {
      const s = JSON.stringify(obj);
      if (prevMap[rowId] !== s) {
        changed.push(rowId);
      }
    }

    for (const [k, v] of Object.entries(newMap)) prevMap[k] = JSON.stringify(v);
    
    // ✅ FILTRO MEJORADO: Ahora usa la función tieneDatosVisibles.
    const todasLasFilasConDatos = Object.keys(latestDataMap)
        .filter(key => tieneDatosVisibles(latestDataMap[key]));

    todasLasFilasConDatos.sort((a, b) => {
        const numA = parseInt(a.slice(1));
        const numB = parseInt(b.slice(1));
        return numA - numB;
    });

    const filasAMostrar = todasLasFilasConDatos.slice(-9);

    renderTable(filasAMostrar);
    if (changed.length) applyChangeHighlights(changed);

  } catch (err) {
    console.error('Error cargando status.json:', err);
    document.getElementById('lastUpdate').innerHTML = `<span style="color:red;">Error al cargar datos. Reintentando...</span>`;
  }
}

buildHeaders();
renderTable([]); 

loadAndRender(true);
setInterval(() => loadAndRender(false), REFRESH_SECONDS * 1000);
</script>
</body>
</html>
