<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visor de Estado PAD</title>

<style>
  :root{
    --bg:#000;
    --card:#08203a; --muted:#cfe8ff;

    --header-h-1:48px; --header-h-2:44px;

    --pozo-font-size:20px; --stock-font-size:14px; --cell-font-size:19px;

    --w-id:54px; --w-seq:110px;

    --reel-gap:8px; --reel-pad:10px; --reel-num-size:20px; --reel-date-size:18px;

    --row-h:44px; --nudge-x:0px; --nudge-y:0px; --overscan:0px;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Segoe UI,Arial,sans-serif}
  .wrap{padding:calc(14px + var(--overscan));box-sizing:border-box;display:flex;flex-direction:column;height:100%;transform:translate(var(--nudge-x),var(--nudge-y));transition:transform .25s ease;}

  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  header h1{margin:0;font-size:28px;letter-spacing:.6px}
  header .meta{opacity:.9;font-size:13px;color:#9fd7ff}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{background:#0b61a8;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,.08)}
  .switch{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--muted);cursor:pointer}

  main{flex:1;margin-top:12px;display:flex;min-height:0}
  .board{flex:1;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border-radius:10px;padding:12px;box-sizing:border-box;display:flex;flex-direction:column}

  .table-container{flex:1;overflow:auto;border-radius:8px;position:relative;min-height:0}
  table{border-collapse:collapse;width:100%;min-width:1280px}
  th,td{border:1px solid rgba(255,255,255,.06);padding:8px 10px;text-align:center;white-space:nowrap}

  thead th{background:var(--bg);box-shadow:0 2px 0 rgba(0,0,0,.25)}
  thead tr:first-child th{position:sticky;top:0;z-index:11;height:var(--header-h-1)}
  thead tr:nth-child(2) th{position:sticky;top:var(--header-h-1);z-index:12;height:var(--header-h-2)}

  tbody td{height:var(--row-h);background:transparent;color:#e6f7ff;transition:background .15s ease}
  tbody tr.alt td{background:rgba(255,255,255,.03)}
  tbody tr:hover td{background:rgba(255,255,255,.06)}

  th.rowid,td.rowid{position:sticky;left:0;z-index:20;width:var(--w-id);min-width:var(--w-id);max-width:var(--w-id)}
  td.rowid{font-weight:800;color:#bfe8ff;background:#0c1833}

  th.seq,td.seq{width:var(--w-seq);min-width:var(--w-seq);max-width:var(--w-seq)}
  td.seq{font-weight:800;letter-spacing:.2px;background:rgba(0,255,160,.06)}
  .fh{line-height:1.1}
  .fh .d{color:#2fffd2;font-weight:900;display:inline-block}
  .fh .t{color:#ffb357;font-weight:900;display:inline-block}

  .pozoTop{font-size:var(--pozo-font-size);font-weight:800;letter-spacing:.6px;position:relative}
  .pozo-1{background:linear-gradient(90deg,#ffd83a,#ffd83a);color:#002}
  .pozo-2{background:linear-gradient(90deg,#7ad39a,#5fbf87);color:#002}
  .pozo-3{background:linear-gradient(90deg,#74b3ff,#4686ff);color:#002}
  .pozo-4{background:linear-gradient(90deg,#ff7b7b,#ff4c4c);color:#002}
  .pozo-5{background:linear-gradient(90deg,#ffffff,#f2f6f9);color:#002}
  .pozo-6{background:linear-gradient(90deg,#e8c3ff,#d79bf6);color:#201}

  td[data-col^="Pozo"], td[data-col^="Estado"]{font-size:var(--cell-font-size)}

  .pozoTop .badge{
    margin-left:8px;padding:2px 7px;border-radius:999px;font-size:12px;font-weight:900;line-height:1;color:#fff;
    background:rgba(0,0,0,.45);border:1px solid rgba(0,0,0,.55);
    box-shadow:0 0 0 1px rgba(255,255,255,.35),0 1px 6px rgba(0,0,0,.35);
    text-shadow:0 1px 1px rgba(0,0,0,.55);backdrop-filter:saturate(120%) blur(1px);-webkit-backdrop-filter:saturate(120%) blur(1px);
    vertical-align:middle
  }

  td.stop{background:rgba(255,60,60,.14)!important;color:#ffb3b3!important;font-weight:900;letter-spacing:.4px;text-shadow:0 0 6px rgba(255,60,60,.4)}

  .table-container::-webkit-scrollbar{height:10px;width:10px}
  .table-container::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:6px}

  .bar{display:flex;align-items:center;gap:14px;margin-bottom:10px;flex-wrap:nowrap;overflow-x:auto}

  .stockwrap{display:flex;align-items:center;gap:10px;flex:1 1 auto;min-width:0}
  .stocklabel{font-weight:800;color:#cfe8ff;opacity:.9}
  .stockbar{display:block;overflow-x:auto;overflow-y:hidden;white-space:nowrap;flex:1 1 auto}
  .pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);padding:8px 12px;border-radius:999px;font-size:var(--stock-font-size);color:#e9f6ff;font-weight:700;margin-right:8px}
  .pill .dot{width:8px;height:8px;border-radius:50%;box-shadow:0 0 8px rgba(255,255,255,.25)}
  .stock-theme-0{background:rgba(40,120,255,.18);border-color:rgba(40,120,255,.35)}
  .stock-theme-1{background:rgba(255,160,40,.18);border-color:rgba(255,160,40,.35)}
  .stock-theme-2{background:rgba(60,200,140,.18);border-color:rgba(60,200,140,.35)}
  .stock-theme-3{background:rgba(180,70,255,.18);border-color:rgba(180,70,255,.35)}
  .stock-theme-4{background:rgba(255,80,120,.18);border-color:rgba(255,80,120,.35)}
  .stock-theme-5{background:rgba(0,200,220,.18);border-color:rgba(0,0,0,.35)}
  .stock-theme-6{background:rgba(200,220,60,.18);border-color:rgba(200,220,60,.35)}
  .stock-theme-7{background:rgba(255,120,40,.18);border-color:rgba(255,120,40,.35)}

  /* ===== KPI CARDS ===== */
  .kpis{display:grid;grid-template-columns:repeat(3,minmax(120px,1fr)) 1.2fr 1.2fr;gap:10px;align-items:stretch}
  .kpi{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px;display:flex;flex-direction:column;justify-content:center}
  .kpi.wide{grid-column:auto / span 1}
  .kpi-label{font-size:12px;color:#bfe8ff;opacity:.9;font-weight:700;margin-bottom:2px}
  .kpi-value{font-size:26px;font-weight:900;letter-spacing:.3px}
  .kpi-green{color:#45ffb2}
  .kpi-amber{color:#ffcc66}
  .kpi-sub{font-size:18px;font-weight:800}
  .kpi-note{font-size:12px;color:#bfe8ff;opacity:.95;margin-top:4px}

  .indicators{display:flex;align-items:center;gap:14px;flex:0 0 auto;min-width:max-content}
  .reel{display:flex;align-items:center;gap:var(--reel-gap);overflow-x:auto}
  .reel-btn{width:28px;height:28px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05);color:#cfe8ff;font-weight:800;cursor:pointer}
  .reel-btn:disabled{opacity:.4;cursor:default}
  .date-chip{display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:132px;padding:var(--reel-pad);border-radius:10px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)}
  .date-chip.latest{background:linear-gradient(180deg,rgba(0,163,255,.18),rgba(0,163,255,.08));border-color:rgba(0,163,255,.35)}
  .date-chip .date{font-size:var(--reel-date-size);color:#bfe8ff}
  .date-chip .num{font-size:var(--reel-num-size);font-weight:900;line-height:1.1}

  footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-size:13px;color:#cfe8ff;gap:10px}
  #footerLeft{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

  #dimVeil{position:fixed;inset:0;pointer-events:none;background:#000;opacity:0;transition:opacity .4s ease;z-index:9996}

  #saver{position:fixed;inset:0;display:none;z-index:9997;
    background:radial-gradient(1200px 700px at var(--blob-x,40%) var(--blob-y,35%),rgba(0,163,255,.12),rgba(0,0,0,.85) 70%);
    backdrop-filter:blur(1px)
  }
  #saver .center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;font-weight:900;letter-spacing:.5px}
  #saver .ticker{position:absolute;left:0;right:0;bottom:5%;text-align:center;font-size:14px;color:#cfe8ff;opacity:.9}
  #saverStage{position:absolute;inset:0;overflow:hidden}

  .bImg{position:absolute;width:min(14vw,200px);height:auto;user-select:none;pointer-events:none;opacity:.95;filter:drop-shadow(0 10px 24px rgba(0,0,0,.35));}
  .fallImg{position:absolute;width:min(10vw,160px);height:auto;opacity:.92;filter:drop-shadow(0 10px 20px rgba(0,0,0,.35));}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:9998}
  .modal-card{width:min(900px,96vw);max-height:90vh;overflow:auto;background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .modal-body{display:flex;flex-direction:column;gap:16px}
  .modal-body section{padding:12px;border:1px solid rgba(255,255,255,.06);border-radius:10px;background:rgba(255,255,255,.03)}
  .modal-body h4{margin:0 0 8px 0;font-size:14px;color:#cfe8ff}
  .grid{display:grid;gap:16px}
  .g3{grid-template-columns:1fr 1fr 1fr}
  .g2{grid-template-columns:1fr 1fr}
  .full{grid-column:1/-1}
  .modal input[type="number"], .modal input[type="range"], .modal select{width:100%}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  .pill.small{padding:4px 8px;font-size:12px}

  #wellChooser{display:grid;grid-template-columns:repeat(6,minmax(100px,1fr));gap:10px}
  #wellChooser label{display:flex;align-items:center;gap:8px;font-weight:600;color:#cfe8ff}
  #wellChooser input{transform:scale(1.15)}

  html.is-tv .wrap{ transform:none !important; }
  html.is-tv #saver{ backdrop-filter:none; }
  html.is-tv .bImg, html.is-tv .fallImg{ filter:none; }
  html.is-tv thead th{ -webkit-transform:translateZ(0); transform:translateZ(0); }
</style>
</head>

<body>
<div id="dimVeil"></div>
<div id="saver">
  <div id="saverStage"></div>
  <div class="center"></div>
  <div class="ticker" id="saverTicker"></div>
</div>

<div class="wrap">
  <header>
    <div>
      <h1>Visor de Estado PAD</h1>
      <div class="meta">Actualiza automáticamente</div>
    </div>
    <div class="controls">
      <label class="switch">
        <input id="autoScroll" type="checkbox" />
        Auto-scroll (últimas <span id="autoN"></span>)
      </label>
      <button class="btn" id="btnRefresh">Forzar actualización</button>
      <button class="btn secondary" id="btnPause">Pausar</button>
      <button class="btn secondary" id="btnFull">Pantalla completa</button>
      <button class="btn secondary" id="btnSettings">Ajustes</button>
    </div>
  </header>

  <main>
    <div class="board">

      <!-- ===== KPIs + Reel ===== -->
      <div class="bar" style="flex-wrap:wrap">
        <div class="kpis" style="flex:1 1 680px">
          <div class="kpi"><div class="kpi-label">Etapas totales</div><div id="kpiTotal" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-label">Realizadas</div><div id="kpiDone" class="kpi-value kpi-green">0</div></div>
          <div class="kpi"><div class="kpi-label">Restantes</div><div id="kpiRemain" class="kpi-value kpi-amber">0</div></div>
          <div class="kpi">
            <div class="kpi-label">Promedio</div>
            <div id="kpiAvg" class="kpi-sub">—</div>
            <div id="kpiWindow" class="kpi-note">Ventana usada: —</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Fin estimado</div>
            <div id="kpiETA" class="kpi-sub">—</div>
            <div id="kpiETATime" class="kpi-note">—</div>
          </div>
        </div>

        <div class="indicators" style="margin-left:auto">
          <div id="datesReel" class="reel" aria-label="Fracturas por fecha (reel)"></div>
        </div>
      </div>

      <!-- ===== STOCK ===== -->
      <div class="bar">
        <div class="stockwrap">
          <div class="stocklabel">STOCK ACTUAL:</div>
          <div id="stockBar" class="stockbar"></div>
        </div>
      </div>

      <!-- ===== TABLA ===== -->
      <div class="table-container" id="tableContainer">
        <table id="mainTable">
          <thead>
            <tr id="hdrTop"><th class="rowid">#</th></tr>
            <tr id="hdrSub"><th class="rowid">&nbsp;</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <footer>
        <div id="footerLeft">
          <span>Última actualización: <strong id="lastUpdate">-</strong></span>
          <span id="delta" class="delta"></span>
          <span id="netStatus" class="pill">Conectando…</span>
        </div>
        <div class="meta">Actualiza cada <span id="refreshSec">15</span>s</div>
      </footer>
    </div>
  </main>
</div>

<!-- ===== Modal Ajustes ===== -->
<div id="settingsModal" class="modal" aria-modal="true" role="dialog" aria-label="Ajustes">
  <!-- … (sin cambios en el modal) … -->
  <!-- Mantengo el contenido tal cual lo enviaste para no alargar -->
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  /* ========= CONFIG ========= */
  var JSON_CANDIDATES=[
    'https://baseslucas8071-maker.github.io/tablero/status.json',
    'status.json'
  ];
  var JSON_URL=JSON_CANDIDATES[0];
  var REFRESH_SECONDS=15, ROWS=60, POZOS=6, LAST_N_TO_SHOW=7, REEL_SIZE=2;

  /* Ventana para promedio (días) */
  var AVG_WINDOW_DAYS = 7;

  /* Hora de corte del día operativo (0=medianoche; usar 6 si cerrás a las 06:00) */
  var DAY_CUTOFF_HOUR = 0;

  document.getElementById('autoN').textContent = LAST_N_TO_SHOW;

  var UA = navigator.userAgent || '';
  var IS_TV = /\b(Android TV|SMART-TV|HBBTV|BRAVIA|AFT|MiBOX|TCL)\b/i.test(UA) || /com\.tcl\.browser/i.test(UA);
  if (IS_TV) document.documentElement.classList.add('is-tv');

  var DEFAULT_VALUES_BASE = 'https://github.com/baseslucas8071-maker/tablero/blob/main/images/';

  /* ========= UTILES ========= */
  var prefs={
    get:function(k,d){ try{ var v=localStorage.getItem(k); return v!==null?JSON.parse(v):d; }catch(_){ return d; } },
    set:function(k,v){ try{ localStorage.setItem(k,JSON.stringify(v)); }catch(_){} }
  };
  var clamp=function(v,a,b){ return Math.min(b,Math.max(a,v)); };
  var pad2=function(n){ return String(n).padStart(2,'0'); };
  var fmt1=function(n){ return (Math.round(n*10)/10).toString().replace('.',','); };
  var fmtTime=function(d){ return pad2(d.getHours())+':'+pad2(d.getMinutes()); };

  var toRawURL=function(u){
    if(!u) return '';
    var m=u.match(/^https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.*)$/);
    return m ? ('https://raw.githubusercontent.com/'+m[1]+'/'+m[2]+'/'+m[3]+'/'+m[4]) : u;
  };
  var VALUES_IMAGES=function(base){
    var b=(base||DEFAULT_VALUES_BASE); var raw=(b.endsWith('/')?b:(b+'/')); var r=toRawURL(raw);
    return [1,2,3,4,5,6].map(function(i){ return r + i + '.png'; });
  };

  function canonicalizeName(raw){
    var s=(raw==null?'':String(raw)).toUpperCase();
    s=s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    s=s.replace(/\s*:\s*$/,'');
    s=s.replace(/ARENA\s*MALLA\s*/g,'ARENA ');
    s=s.replace(/\s+/g,' ').trim();
    s=s.replace(/^GASOIL$/,'GAS OIL');
    return s;
  }

  /* ========= ESTADO PERSISTENTE ========= */
  var STOCK_RULES=prefs.get('stock:rules',{
    [canonicalizeName('GAS OIL')]:{display:'GAS OIL',unit:'M3',low:50,mid:150},
    [canonicalizeName('ARENA #100')]:{display:'ARENA #100',unit:'Tn',low:100,mid:300},
    [canonicalizeName('ARENA #30/70')]:{display:'ARENA #30/70',unit:'Tn',low:300,mid:800},
    [canonicalizeName('GEL BOLSONES')]:{display:'GEL BOLSONES',unit:'ud',low:10,mid:25},
    [canonicalizeName('GEL TOTE')]:{display:'GEL TOTE',unit:'ud',low:5,mid:15},
  });

  var DISPLAY=prefs.get('display:cfg',{
    pozoFont:20, stockFont:16, cellFont:19,
    saver:{ mode:'valores-lluvia', rotateEveryMin:3, idleMinutes:2, gitBase:DEFAULT_VALUES_BASE },
    nightDim:{ enabled:true, startHour:1, endHour:6, dimLevel:0.65 },
    pixelShift:{ enabled:true, intervalMin:2, maxOffsetPx:2 },
    view:{ visibleWells:[1,2,3,4,5,6] }
  });
  if (!DISPLAY.view || !Array.isArray(DISPLAY.view.visibleWells)) {
    DISPLAY.view = { visibleWells:[1,2,3,4,5,6] };
    prefs.set('display:cfg', DISPLAY);
  }
  if (IS_TV) DISPLAY.pixelShift.enabled = false;

  /* ========= ESTADO RUNTIME ========= */
  var paused=prefs.get('ui:paused',false);
  var prevDataMap={}, latestDataMap={}, isFetching=false;
  var lastActivityTs=Date.now(); var stockCache=[];
  var shiftTimer=null, nightTimer=null, saverTO=null, rotator=null;
  var rafAnim=null; var sprites=[]; var testingTO=null;

  /* ========= DOM ========= */
  var tbody=document.getElementById('tbody');
  var hdrTop=document.getElementById('hdrTop'), hdrSub=document.getElementById('hdrSub');
  var tableContainer=document.getElementById('tableContainer');
  var autoScroll=document.getElementById('autoScroll');
  var lastUpdateEl=document.getElementById('lastUpdate'), deltaEl=document.getElementById('delta'), net=document.getElementById('netStatus');
  var stockBar=document.getElementById('stockBar');
  var btnRefresh=document.getElementById('btnRefresh'), btnPause=document.getElementById('btnPause'), btnFull=document.getElementById('btnFull'), btnSettings=document.getElementById('btnSettings');
  var datesReel=document.getElementById('datesReel');

  /* KPIs */
  var kpiTotal=document.getElementById('kpiTotal'),
      kpiDone=document.getElementById('kpiDone'),
      kpiRemain=document.getElementById('kpiRemain'),
      kpiAvg=document.getElementById('kpiAvg'),
      kpiWindow=document.getElementById('kpiWindow'),
      kpiETA=document.getElementById('kpiETA'),
      kpiETATime=document.getElementById('kpiETATime');

  /* ========= HEADER ACCIONES ========= */
  autoScroll.checked=prefs.get('ui:autoScroll',true);
  btnPause.innerText=paused?'Reanudar':'Pausar';
  document.getElementById('refreshSec').innerText=REFRESH_SECONDS;

  btnRefresh.onclick=function(){ forceRefresh(); };
  btnPause.onclick=function(){ paused=!paused;prefs.set('ui:paused',paused);btnPause.innerText=paused?'Reanudar':'Pausar'; };
  autoScroll.onchange=function(){ prefs.set('ui:autoScroll',autoScroll.checked); if(autoScroll.checked) requestAnimationFrame(function(){ scrollToLastWithData(LAST_N_TO_SHOW); }); };

  function enterFull(){ var el=document.documentElement; (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen||el.mozRequestFullScreen||function(){}).call(el); }
  function exitFull(){ (document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen||document.mozCancelFullScreen||function(){}).call(document); }
  btnFull.onclick=function(){ var fs=document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||document.mozFullScreenElement; fs?exitFull():enterFull(); };

  btnSettings.onclick=openSettings;

  /* ========= TABLA (DOM inicial) ========= */
  // … (se mantiene igual) …
  // Para ahorrar espacio dejo sin expandir las funciones DOM/stock/saver que no toqué
  // ——— INICIA BLOQUE OMITIDO ———
  /* -------------- pegá aquí todo lo que ya tenías sin cambios -------------- */
  // ——— FIN BLOQUE OMITIDO ———

  /* ========= FECHAS ========= */
  // (se mantienen tus utilidades parseDate/STOP/etc.)
  // ——— INICIA BLOQUE OMITIDO (tus parseadores) ———

  // ==== A PARTIR DE AQUÍ: PROMEDIO Y NUEVO ETA CON HORA ====

  /* ===== Promedio y ETA (regla de ventana única) ===========================
     Reglas:
     1) Fecha de inicio = primer día con etapas (por fecha válida).
     2) Período = desde inicio hasta AYER (hoy EXCLUIDO).
     3) Si hay ≤7 días disponibles: promedia TODOS esos días (días sin etapas cuentan 0).
     4) Si hay >7 días: usa SOLO los últimos 7 (hasta ayer), también contando 0.
  --------------------------------------------------------------------------- */
  function computeAverage(freq){
    var keys = Array.from(freq.keys()).sort(); // ASC
    if(keys.length === 0){
      return { avg: 0, usedDays: 0 };
    }
    function startOfDay(d){ var x=new Date(d); x.setHours(0,0,0,0); return x; }
    function fromNorm(s){ var a=s.split('-').map(Number); return new Date(a[0], a[1]-1, a[2]); }
    function toNorm(d){ return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); }

    var today = startOfDay(new Date());
    var yesterday = new Date(today); yesterday.setDate(yesterday.getDate()-1);

    var start = startOfDay(fromNorm(keys[0]));
    if(start > yesterday){ return { avg:0, usedDays:0 }; }

    var counts = [], d = new Date(start);
    while(d <= yesterday){
      var k = toNorm(d);
      var rec = freq.get(k);
      counts.push(rec ? rec.count : 0);
      d.setDate(d.getDate()+1);
    }
    var slice = counts.length > 7 ? counts.slice(counts.length - 7) : counts;
    var sum = slice.reduce(function(a,b){ return a+b; }, 0);
    var avg = slice.length ? (sum / slice.length) : 0;
    return { avg: avg, usedDays: slice.length };
  }

  /* ===== ETA con HORA (corrige “≈ 1 día” cuando entra hoy) ===== */
  function hoursLeftUntilCutoff(now, cutoffHour){
    var end = new Date(now);
    if(cutoffHour === 0){
      end.setHours(23,59,59,999);
    }else{
      if(now.getHours() < cutoffHour || (now.getHours()===cutoffHour && now.getMinutes()===0)){
        end.setHours(cutoffHour,0,0,0);
      }else{
        end.setDate(end.getDate()+1);
        end.setHours(cutoffHour,0,0,0);
      }
    }
    return (end - now) / 36e5; // horas
  }
  function estimateFinishWithTime(remaining, avgPerDay, cutoffHour){
    if(!isFinite(remaining) || remaining<=0) return { approx:'', dateLabel:new Date().toLocaleDateString('es-AR'), timeLabel:fmtTime(new Date()), target:new Date() };
    if(!isFinite(avgPerDay) || avgPerDay<=0) return { approx:'—', dateLabel:'', timeLabel:'', target:null };

    var now = new Date();
    var hoursNeeded = (remaining / avgPerDay) * 24;
    var hoursLeftToday = hoursLeftUntilCutoff(now, cutoffHour);

    var approx, daysNeeded;
    if(hoursNeeded <= hoursLeftToday){
      approx = '≈ hoy';
      daysNeeded = 0;
    }else{
      daysNeeded = Math.ceil(hoursNeeded / 24);
      approx = '≈ ' + daysNeeded + ' día' + (daysNeeded>1?'s':'');
    }

    var target = new Date(now.getTime() + hoursNeeded*3600*1000);
    var rounded = new Date(target);
    var m = rounded.getMinutes();
    rounded.setMinutes(Math.round(m/5)*5, 0, 0); // redondeo 5'

    return { approx:approx, dateLabel: rounded.toLocaleDateString('es-AR'), timeLabel: fmtTime(rounded), target: rounded };
  }

  /* ========= CARGA ========= */
  // … (todo tu código de fetch/render igual) …
  // En loadAndRender cambiamos solo la parte donde armás KPIs de promedio/ETA:

  async function forceRefresh(){ if(isFetching) return; btnRefresh.disabled=true; var t=btnRefresh.textContent; btnRefresh.textContent='Actualizando...'; await loadAndRender(true); btnRefresh.textContent=t; btnRefresh.disabled=false; }

  function computeFractureStats(conv){
    var f=new Map(); var tot=0;
    for(var i=0;i<conv.length;i++){
      var it=conv[i];
      if(!it.fila||!it.fila.trim()) continue;
      for(var p=1;p<=POZOS;p++){
        var pdt=parseDateValue(it['Estado'+p]);     // solo FECHA
        if(pdt){tot++; var cur=f.get(pdt.normalized); if(cur) cur.count++; else f.set(pdt.normalized,{display:pdt.display,count:1,normalized:pdt.normalized});}
      }
    }
    return {total:tot,freq:f};
  }

  async function loadAndRender(isForced){
    if(isForced!==true) isForced=false;
    if(paused && !isForced) return; if(isFetching) return; isFetching=true;
    try{
      var t0=performance.now();
      var json=await fetchJSON();
      var t1=performance.now();
      setNet('OK', true, Math.round(t1-t0)+'ms');

      document.getElementById('lastUpdate').innerText=(json.lastUpdate?new Date(json.lastUpdate):new Date()).toLocaleString();

      renderStock(json.stock||[]);
      var conv=transformItems(json.items||[]);
      var hdr=extractHeaderRows(conv); updateHeaderNames(hdr.top,hdr.sub);
      var map=itemsArrayToMap(conv);
      var changed=updateDOM(map).changedCellsTotal;
      deltaEl.textContent=changed>0?('• '+changed+' cambio(s)'):'';

      /* Reel y promedio (solo FECHAS) */
      var stats=computeFractureStats(conv);
      updateDatesArray(stats.freq);

      /* Totales / KPIs */
      var totals=computeTotals(conv);
      kpiTotal.textContent = totals.totalSlots;
      kpiDone.textContent  = totals.hechas;
      kpiRemain.textContent= totals.restantes;

      // Promedio (ventana única)
      var av = computeAverage(stats.freq);
      kpiAvg.textContent = (av.avg>0?fmt1(av.avg):'—') + (av.avg>0?' etapas/día':'');
      kpiWindow.textContent = 'Ventana usada: '+(av.usedDays||0)+' día(s)';

      // ETA con fecha + hora
      var eta = estimateFinishWithTime(totals.restantes, av.avg, DAY_CUTOFF_HOUR);
      if(eta && eta.target){
        kpiETA.innerHTML = eta.dateLabel + ' <span style="opacity:.9;color:#bfe8ff">(' + eta.approx + ')</span>';
        kpiETATime.textContent = '~ ' + eta.timeLabel;
      }else{
        kpiETA.textContent = '—';
        kpiETATime.textContent = '—';
      }

      paintBadgesPerPozo(remainingPerPozo(conv));

      if(changed>0){ lastActivityTs=Date.now(); hideSaver(); scheduleSaver(); }
      if(autoScroll.checked) requestAnimationFrame(function(){ scrollToLastWithData(LAST_N_TO_SHOW); });
      requestAnimationFrame(fitRowsToViewport);
    }catch(e){
      console.error(e);
      setNet('ERROR:', false, (e&&e.message?e.message:'')); 
      document.getElementById('lastUpdate').innerHTML='<span style="color:salmon">Error de conexión</span>';
      deltaEl.textContent='';
    }finally{ isFetching=false; }
  }

  // … (resto de funciones: autoscroll, badges, settings, saver, init, timers)
  // ——— INICIA BLOQUE OMITIDO (tu código existente) ———

  // INIT
  initializeDOM(); applyDisplay(); fitRowsToViewport(); applyWellVisibility();
  loadAndRender(true);
  setInterval(function(){ loadAndRender(false); }, REFRESH_SECONDS*1000);

  // listeners de resize/fullscreen (como ya tenías) …
});
</script>
</body>
</html>
