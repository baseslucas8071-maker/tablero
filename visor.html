<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visor de Estado - TV</title>
<style>
  :root {
    --bg: #071027;
    --card: #08203a;
    --muted: #cfe8ff;
    --accent: #00a3ff;
    --header-h-1: 48px;
    --header-h-2: 44px;

    /* ===== AJUSTES SOLICITADOS ===== */
    --w-id: 54px;   /* ancho columna Fila (#01) */
    --w-seq: 50px;  /* ancho columnas Secuencia */
    --pozo-font-size: 18px; /* tamaño del texto "POZO #n" (encabezado superior) */
    --stock-font-size: 14px; /* tamaño de texto de las píldoras de stock */
    --stock-pad-x: 12px;     /* padding horizontal de las píldoras de stock */
    --stock-pad-y: 8px;      /* padding vertical de las píldoras de stock */
  }

  html, body { height: 100%; margin: 0; background: var(--bg); color: #fff; font-family: Inter, Segoe UI, Arial, sans-serif; }
  .wrap { padding: 14px; box-sizing: border-box; display: flex; flex-direction: column; height: 100%; }
  header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  header h1 { margin: 0; font-size: 28px; letter-spacing: 0.6px; }
  header .meta { opacity: 0.9; font-size: 13px; color: var(--muted); }
  .controls { display: flex; gap: 8px; align-items: center; }
  .btn { background: #0b61a8; border: none; color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }
  .btn.secondary { background: transparent; border: 1px solid rgba(255, 255, 255, 0.08); }
  .switch { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--muted); cursor: pointer; }
  main { flex: 1; margin-top: 12px; display: flex; min-height: 0; }
  .board { flex: 1; background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01)); border-radius: 10px; padding: 12px; box-sizing: border-box; display: flex; flex-direction: column; }
  .table-container { flex: 1; overflow: auto; border-radius: 8px; position: relative; min-height: 0; }
  table { border-collapse: collapse; width: 100%; min-width: 1280px; }
  th, td { border: 1px solid rgba(255, 255, 255, 0.06); padding: 8px 10px; text-align: center; white-space: nowrap; }
  thead th { background: var(--bg); }
  thead tr:first-child th { position: sticky; top: 0; z-index: 11; height: var(--header-h-1); }
  thead tr:nth-child(2) th { position: sticky; top: var(--header-h-1); z-index: 12; height: var(--header-h-2); }
  tbody td { height: 44px; background: transparent; color: #e6f7ff; }
  tbody tr.alt td { background: rgba(255, 255, 255, 0.01); }

  /* Columna Fila (#01) angosta y sticky */
  th.rowid, td.rowid { position: sticky; left: 0; z-index: 20; width: var(--w-id); min-width: var(--w-id); max-width: var(--w-id); }
  td.rowid { font-weight: 800; color: #bfe8ff; background: #0c1833; }

  /* Secuencia: verde “fosforescente” y angosta */
  th.seq, td.seq { width: var(--w-seq); min-width: var(--w-seq); max-width: var(--w-seq); }
  td.seq {
    font-weight: 800;
    color: #00ff9c;
    letter-spacing: 0.4px;
    text-shadow: 0 0 6px rgba(0,255,160,0.7), 0 0 12px rgba(0,255,160,0.35);
    background: rgba(0,255,160,0.05);
  }

  thead th:first-child { position: sticky; left: 0; z-index: 21; }

  /* Colores de cabecera por pozo */
  .pozoTop { font-size: var(--pozo-font-size); font-weight: 800; letter-spacing: .6px; }
  .pozo-1{background:linear-gradient(90deg,#ffd83a,#ffd83a); color:#002;}
  .pozo-2{background:linear-gradient(90deg,#7ad39a,#5fbf87); color:#002;}
  .pozo-3{background:linear-gradient(90deg,#74b3ff,#4686ff); color:#002;}
  .pozo-4{background:linear-gradient(90deg,#ff7b7b,#ff4c4c); color:#002;}
  .pozo-5{background:linear-gradient(90deg,#dfe6ea,#cfd9de); color:#002;}
  .pozo-6{background:linear-gradient(90deg,#e6f7ff,#d2efff); color:#002;}

  .changed { animation: highlight 1.6s ease; box-shadow: 0 6px 18px rgba(0,160,220,0.10) inset; }
  @keyframes highlight { 0% { background: rgba(0,163,255,0.35);} 100% { background: none; } }

  .fetching-indicator { animation: pulse 1s infinite; }
  @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

  footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 13px; color: var(--muted); }
  .indicators { display: flex; gap: 12px; align-items: center; }
  .ind { background: rgba(255, 255, 255, 0.03); padding: 6px 10px; border-radius: 8px; font-weight: 700; }

  /* Scrollbar */
  .table-container::-webkit-scrollbar{height:10px;width:10px}
  .table-container::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:6px}

  /* Barra superior */
  .bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; gap:12px; flex-wrap:wrap; }

  /* Stock más grande (editá variables de arriba) */
  .stockbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .pill {
    background: rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.08);
    padding: var(--stock-pad-y) var(--stock-pad-x);
    border-radius:999px;
    font-size: var(--stock-font-size);
    color:#e9f6ff;
    font-weight: 700;
  }

  .delta { font-size:12px; color:#96d7ff; margin-left:8px; }

  @media(max-width:900px){
    header h1{font-size:18px}
    th,td{padding:6px 6px}
    .pill{font-size: calc(var(--stock-font-size) - 1px)}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Visor de Estado — Pozos</h1>
      <div class="meta">Kiosk / TV • Actualiza automáticamente</div>
    </div>
    <div class="controls">
      <label class="switch"><input id="autoScroll" type="checkbox" checked /> Auto-scroll (últimas 7)</label>
      <button class="btn" id="btnRefresh">Forzar actualización</button>
      <button class="btn secondary" id="btnPause">Pausar</button>
    </div>
  </header>
  <main>
    <div class="board">
      <div class="bar">
        <div id="updateContainer" style="font-size:14px">
          Última actualización: <strong id="lastUpdate">-</strong>
          <span id="delta" class="delta"></span>
        </div>
        <div id="stockBar" class="stockbar"></div>
        <div class="indicators">
          <div class="ind" id="totalCount">Total: 0</div>
          <div class="ind" id="alertCount">Alertas: 0</div>
        </div>
      </div>

      <div class="table-container" id="tableContainer">
        <table id="mainTable">
          <thead>
            <tr id="hdrTop"><th class="rowid">#</th></tr>
            <tr id="hdrSub"><th class="rowid">&nbsp;</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <footer>
        <div class="meta">Fuente: status.json (GitHub Pages)</div>
        <div class="meta">Actualiza cada <span id="refreshSec">15</span>s</div>
      </footer>
    </div>
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const JSON_URL = 'status.json';
  const REFRESH_SECONDS = 15;
  const ROWS = 60;
  const POZOS = 6;
  const LAST_N_TO_SHOW = 8;

  let paused = false;
  let prevDataMap = {};
  let latestDataMap = {};
  let isFetching = false;

  const tbody = document.getElementById('tbody');
  const hdrTop = document.getElementById('hdrTop');
  const hdrSub = document.getElementById('hdrSub');
  const tableContainer = document.getElementById('tableContainer');
  const autoScrollCheckbox = document.getElementById('autoScroll');
  const lastUpdateEl = document.getElementById('lastUpdate');
  const deltaEl = document.getElementById('delta');
  const stockBar = document.getElementById('stockBar');
  const btnRefresh = document.getElementById('btnRefresh');
  const btnPause = document.getElementById('btnPause');

  document.getElementById('refreshSec').innerText = REFRESH_SECONDS;
  btnRefresh.addEventListener('click', handleForceRefresh);
  btnPause.addEventListener('click', togglePause);
  autoScrollCheckbox.addEventListener('change', () => {
    if (autoScrollCheckbox.checked) requestAnimationFrame(() => scrollToLastWithData(LAST_N_TO_SHOW));
  });

  function togglePause() {
    paused = !paused;
    btnPause.innerText = paused ? 'Reanudar' : 'Pausar';
  }

  async function handleForceRefresh() {
    if (isFetching) return;
    const original = btnRefresh.innerText;
    btnRefresh.disabled = true;
    btnRefresh.innerText = 'Actualizando...';
    await loadAndRender(true);
    btnRefresh.innerText = original;
    btnRefresh.disabled = false;
  }

  function initializeDOM() {
    // Encabezados por pozo (SEQ, TPN, FRACTURADO)
    for (let i = 1; i <= POZOS; i++) {
      const thTop = document.createElement('th');
      thTop.className = `pozo-${i} pozoTop`;
      thTop.colSpan = 3;
      thTop.innerText = `POZO #${i}`;
      hdrTop.appendChild(thTop);

      const thSeq = document.createElement('th'); thSeq.className = 'seq'; thSeq.innerText = 'SEQ'; hdrSub.appendChild(thSeq);
      const thSub1 = document.createElement('th'); thSub1.innerText = 'TPN'; hdrSub.appendChild(thSub1);
      const thSub2 = document.createElement('th'); thSub2.innerText = 'FRACTURADO'; hdrSub.appendChild(thSub2);
    }

    // Filas
    tbody.innerHTML = '';
    const frag = document.createDocumentFragment();
    for (let i = 1; i <= ROWS; i++) {
      const id = '#' + String(i).padStart(2, '0');
      const tr = document.createElement('tr');
      tr.dataset.rowId = id;
      if (i % 2 === 0) tr.classList.add('alt');

      const tdId = document.createElement('td');
      tdId.className = 'rowid';
      tdId.innerText = id;
      tr.appendChild(tdId);

      for (let p = 1; p <= POZOS; p++) {
        const tdSeq = document.createElement('td'); tdSeq.dataset.col = `Seq${p}`; tdSeq.className = 'seq'; tr.appendChild(tdSeq);
        const td1  = document.createElement('td'); td1.dataset.col  = `Pozo${p}`; tr.appendChild(td1);
        const td2  = document.createElement('td'); td2.dataset.col  = `Estado${p}`; tr.appendChild(td2);
      }
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
  }

  /* ===== Adaptadores de JSON ===== */
  function transformItems(items) {
    if (!Array.isArray(items)) return [];
    return items.map((raw) => {
      const out = {};
      out.fila = (raw.Fila ?? raw.fila ?? '').toString();
      for (let i = 1; i <= POZOS; i++) {
        out['Seq'   + i] = (raw['SecuenciaPozo'   + i] ?? '').toString();
        out['Pozo'  + i] = (raw['TPNPozo'         + i] ?? '').toString();
        out['Estado'+ i] = (raw['FechaFracPozo'   + i] ?? '').toString();
      }
      return out;
    });
  }
  function extractHeaderRows(converted) {
    const headers = converted.filter(it => (it.fila || '').trim() === '');
    return { top: headers[0] || null, sub: headers[1] || null };
  }
  function itemsArrayToMap(converted) {
    const map = {};
    for (const it of converted) {
      const key = (it.fila || '').toString().trim();
      if (!key) continue;
      map[key] = it;
    }
    return map;
  }

  /* ===== Formateo de fecha en FRACTURADO (número Excel → d/m/yyyy) ===== */
  function formatExcelSerialToDMY(num) {
    // Base 1899-12-30 para corregir bug de Excel 1900
    const base = Date.UTC(1899, 11, 30);
    const ms = base + Math.round(num) * 86400000;
    const d = new Date(ms);
    // Usamos UTC para evitar desfasajes por timezone
    const day = d.getUTCDate();
    const month = d.getUTCMonth() + 1;
    const year = d.getUTCFullYear();
    return `${day}/${month}/${year}`;
  }
  function maybeFormatDate(val) {
    const s = (val ?? '').toString().trim();
    if (!s) return '';
    // Si es ISO (2025-08-26)
    if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
      const d = new Date(s);
      return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
    }
    // Si es número tipo Excel (45895…)
    if (/^-?\d+(\.\d+)?$/.test(s)) {
      const n = Number(s.replace(',', '.'));
      // rango típico de fechas modernas en Excel
      if (Number.isFinite(n) && n >= 40000 && n <= 60000) {
        return formatExcelSerialToDMY(n);
      }
    }
    return s; // texto normal ("FRACTURADO", "ALERT", etc.)
  }

  function updateHeaderNames(topRow, subRow) {
    if (!topRow && !subRow) return;

    const newNames = [];
    for (let i = 1; i <= POZOS; i++) {
      const pTop = (topRow && topRow['Pozo' + i]) ? String(topRow['Pozo' + i]).trim() : '';
      const eTop = (topRow && topRow['Estado' + i]) ? String(topRow['Estado' + i]).trim() : '';
      const pSub = (subRow && subRow['Pozo' + i]) ? String(subRow['Pozo' + i]).trim() : '';
      const eSub = (subRow && subRow['Estado' + i]) ? String(subRow['Estado' + i]).trim() : '';

      let topLabel = pTop || pSub || `POZO #${i}`;
      let topSuffix = eTop || '';
      if (!topSuffix && eSub && !/^TPN$/i.test(eSub)) topSuffix = eSub;

      const headerText = (topLabel + (topSuffix ? (' ' + topSuffix) : '')).trim();
      newNames.push(headerText);
    }

    const current = Array.from(hdrTop.querySelectorAll('th.pozoTop')).map(th => th.innerText);
    if (JSON.stringify(current) !== JSON.stringify(newNames)) {
      const ths = hdrTop.querySelectorAll('th.pozoTop');
      ths.forEach((th, idx) => { th.innerText = newNames[idx] || `POZO #${idx+1}`; });
    }

    // Sub-encabezados: 3 por pozo (SEQ, TPN, FRACTURADO)
    const subCells = hdrSub.querySelectorAll('th');
    for (let i = 1; i <= POZOS; i++) {
      const pSub = (subRow && subRow['Pozo' + i]) ? String(subRow['Pozo' + i]).trim() : 'TPN';
      const eSub = (subRow && subRow['Estado' + i]) ? String(subRow['Estado' + i]).trim() : 'FRACTURADO';
      const base = (i - 1) * 3 + 1; // +1 por la primera celda (#)
      if (subCells[base])     subCells[base].innerText     = 'SEQ';
      if (subCells[base + 1]) subCells[base + 1].innerText = pSub || 'TPN';
      if (subCells[base + 2]) subCells[base + 2].innerText = eSub || 'FRACTURADO';
    }
  }

  function hasVisibleData(dataObj) {
    if (!dataObj) return false;
    for (let i = 1; i <= POZOS; i++) {
      if ((dataObj['Seq' + i] && String(dataObj['Seq' + i]).trim() !== '') ||
          (dataObj['Pozo' + i] && String(dataObj['Pozo' + i]).trim() !== '') ||
          (dataObj['Estado' + i] && String(dataObj['Estado' + i]).trim() !== '')) return true;
    }
    return false;
  }

  function updateRowCells(rowId, newData) {
    const tr = tbody.querySelector(`tr[data-row-id="${rowId}"]`);
    if (!tr) return { changed: false, cells: 0 };
    let changedAny = false;
    let changedCells = 0;
    for (let p = 1; p <= POZOS; p++) {
      const tdSeq = tr.querySelector(`td[data-col="Seq${p}"]`);
      const td1  = tr.querySelector(`td[data-col="Pozo${p}"]`);
      const td2  = tr.querySelector(`td[data-col="Estado${p}"]`);

      const vSeq = (newData && newData['Seq' + p]) ? String(newData['Seq' + p]) : '';
      const v1   = (newData && newData['Pozo' + p]) ? String(newData['Pozo' + p]) : '';
      const v2   = (newData && newData['Estado' + p]) ? maybeFormatDate(newData['Estado' + p]) : '';

      if (tdSeq && tdSeq.innerText !== vSeq) { tdSeq.innerText = vSeq; changedAny = true; changedCells++; }
      if (td1   && td1.innerText   !== v1 ) { td1.innerText   = v1;  changedAny = true; changedCells++; }
      if (td2   && td2.innerText   !== v2 ) { td2.innerText   = v2;  changedAny = true; changedCells++; }
    }
    return { changed: changedAny, cells: changedCells };
  }

  function updateDOM(dataMap) {
    const changedRows = [];
    let totalWithData = 0;
    let alertCount = 0;
    let changedCellsTotal = 0;

    for (let i = 1; i <= ROWS; i++) {
      const id = '#' + String(i).padStart(2, '0');
      const newObj = dataMap[id] || {};
      const newString = JSON.stringify(newObj);
      const prevString = prevDataMap[id];

      if (hasVisibleData(newObj)) totalWithData++;
      for (let p = 1; p <= POZOS; p++) {
        const v1 = String(newObj['Estado' + p] || '').toUpperCase();
        const v2 = String(newObj['Pozo' + p]   || '').toUpperCase();
        if (v1.includes('FRACT') || v1.includes('ALERT') || v1.includes('FAULT') ||
            v2.includes('ALERT')) alertCount++;
      }

      if (prevString === undefined) {
        prevDataMap[id] = newString;
        latestDataMap[id] = newObj;
        const { cells } = updateRowCells(id, newObj);
        changedCellsTotal += cells;
        continue;
      }

      if (prevString !== newString) {
        const { changed, cells } = updateRowCells(id, newObj);
        if (changed) changedRows.push(id);
        changedCellsTotal += cells;
        prevDataMap[id] = newString;
        latestDataMap[id] = newObj;
      } else {
        latestDataMap[id] = newObj;
      }
    }

    document.getElementById('totalCount').innerText = `Total: ${totalWithData}`;
    document.getElementById('alertCount').innerText = `Alertas: ${alertCount}`;

    changedRows.forEach(id => {
      const tr = tbody.querySelector(`tr[data-row-id="${id}"]`);
      if (tr) {
        tr.classList.add('changed');
        setTimeout(() => tr.classList.remove('changed'), 1800);
      }
    });

    return { changedRows, changedCellsTotal };
  }

  function scrollToLastWithData(n = LAST_N_TO_SHOW) {
    if (!autoScrollCheckbox.checked) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const idxWithData = [];
    rows.forEach((tr, idx) => {
      const id = tr.dataset.rowId;
      if (hasVisibleData(latestDataMap[id])) idxWithData.push(idx);
    });
    if (idxWithData.length === 0) return;

    const startIdx = idxWithData[Math.max(0, idxWithData.length - n)];
    const startRow = rows[startIdx];
    if (!startRow) return;

    const headerHeight = hdrTop.offsetHeight + hdrSub.offsetHeight;
    const targetTop = startRow.offsetTop - headerHeight - 8;
    tableContainer.scrollTo({ top: Math.max(0, targetTop), behavior: 'smooth' });
  }

  function renderStock(stockArr = []) {
    stockBar.innerHTML = '';
    if (!Array.isArray(stockArr) || stockArr.length === 0) return;
    for (const s of stockArr) {
      const div = document.createElement('div');
      div.className = 'pill';
      const item = (s.ITEM ?? '').toString();
      const qty  = (s.STOCK ?? '').toString();
      div.textContent = `${item}: ${qty}`;
      stockBar.appendChild(div);
    }
  }

  async function loadAndRender(isForced = false) {
    if (paused && !isForced) return;
    if (isFetching) return;
    isFetching = true;
    document.getElementById('updateContainer').classList.add('fetching-indicator');

    try {
      const res = await fetch(`${JSON_URL}?_=${Date.now()}`, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();

      const lu = json.lastUpdate ? new Date(json.lastUpdate) : new Date();
      lastUpdateEl.innerText = lu.toLocaleString();

      renderStock(json.stock || []);

      const converted = transformItems(json.items || []);
      const { top, sub } = extractHeaderRows(converted);
      updateHeaderNames(top, sub);
      const dataMap = itemsArrayToMap(converted);

      const { changedRows, changedCellsTotal } = updateDOM(dataMap);
      deltaEl.textContent = changedCellsTotal > 0 ? `• ${changedCellsTotal} cambio(s)` : '';

      if (autoScrollCheckbox.checked && (changedRows.length > 0 || isForced)) {
        scrollToLastWithData(LAST_N_TO_SHOW);
      }

    } catch (err) {
      console.error('Error al cargar datos:', err);
      lastUpdateEl.innerHTML = `<span style="color:salmon">Error de conexión</span>`;
      deltaEl.textContent = '';
    } finally {
      setTimeout(() => document.getElementById('updateContainer').classList.remove('fetching-indicator'), 400);
      isFetching = false;
    }
  }

  // Init
  initializeDOM();
  loadAndRender(true);
  setInterval(() => loadAndRender(false), REFRESH_SECONDS * 1000);
});
</script>
</body>
</html>
