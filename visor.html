<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visor de Estado PAD</title>

<style>
  :root{
    --bg:#071027; --card:#08203a; --muted:#cfe8ff;

    /* Altos de encabezados stickies */
    --header-h-1:48px; --header-h-2:44px;

    /* Tamaños por defecto */
    --pozo-font-size:20px;       /* pedido: 20 */
    --stock-font-size:14px;      /* pedido: 14 */
    --cell-font-size:19px;       /* TPN/FRACTURADO pedido: 19 */

    /* Anchos fijos */
    --w-id:54px;
    --w-fh:92px;                 /* ancho "F/h TPN" (antes SEQ) */
    --w-pozo:120px;              /* ancho columna TPN */
    --w-estado:120px;            /* ancho columna FRACTURADO */

    /* Reel de fechas */
    --reel-gap:8px; --reel-pad:10px; --reel-num-size:20px; --reel-date-size:18px;

    /* Altura de fila calculada dinámicamente (fallback 44px) */
    --row-h:44px;

    /* Pixel-shift */
    --nudge-x:0px; --nudge-y:0px;

    /* Overscan para TVs que recortan bordes (ajustable) */
    --overscan:0px;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Segoe UI,Arial,sans-serif}
  .wrap{
    padding:calc(14px + var(--overscan));
    box-sizing:border-box;display:flex;flex-direction:column;height:100%;
    transform:translate(var(--nudge-x),var(--nudge-y));transition:transform .25s ease;
  }

  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  header h1{margin:0;font-size:28px;letter-spacing:.6px}
  header .meta{opacity:.9;font-size:13px;color:#9fd7ff}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{background:#0b61a8;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,.08)}
  .switch{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--muted);cursor:pointer}

  main{flex:1;margin-top:12px;display:flex;min-height:0}
  .board{flex:1;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border-radius:10px;padding:12px;box-sizing:border-box;display:flex;flex-direction:column}

  .table-container{flex:1;overflow:auto;border-radius:8px;position:relative;min-height:0}
  table{border-collapse:collapse;width:100%;min-width:1280px}
  th,td{border:1px solid rgba(255,255,255,.06);padding:8px 10px;text-align:center;white-space:nowrap}

  /* Encabezados stickies */
  thead th{background:var(--bg);box-shadow:0 2px 0 rgba(0,0,0,.25)}
  thead tr:first-child th{position:sticky;top:0;z-index:11;height:var(--header-h-1)}
  thead tr:nth-child(2) th{position:sticky;top:var(--header-h-1);z-index:12;height:var(--header-h-2)}

  /* Altura de filas */
  tbody td{height:var(--row-h);background:transparent;color:#e6f7ff;transition:background .15s ease}
  tbody tr.alt td{background:rgba(255,255,255,.01)}
  tbody tr:hover td{background:rgba(255,255,255,.03)}

  th.rowid,td.rowid{position:sticky;left:0;z-index:20;width:var(--w-id);min-width:var(--w-id);max-width:var(--w-id)}
  td.rowid{font-weight:800;color:#bfe8ff;background:#0c1833}

  /* Columna F/h TPN (ex SEQ) */
  th.fh,td.fh{width:var(--w-fh);min-width:var(--w-fh);max-width:var(--w-fh)}
  td.fh{font-weight:800;letter-spacing:.2px;background:rgba(0,255,160,.03)}
  .fhbox{display:inline-block;line-height:1.05}
  .fhbox .f{color:#00ff9c;text-shadow:0 0 6px rgba(0,255,160,.6),0 0 12px rgba(0,255,160,.25);font-weight:900}
  .fhbox .h{color:#ffb54d;text-shadow:0 0 6px rgba(255,181,77,.55),0 0 12px rgba(255,181,77,.25);font-weight:900}

  /* Columna TPN y FRACTURADO */
  th.pozo,td.pozo{width:var(--w-pozo);min-width:var(--w-pozo);max-width:var(--w-pozo)}
  th.estado,td.estado{width:var(--w-estado);min-width:var(--w-estado);max-width:var(--w-estado)}

  .pozoTop{font-size:var(--pozo-font-size);font-weight:800;letter-spacing:.6px;position:relative}
  .pozo-1{background:linear-gradient(90deg,#ffd83a,#ffd83a);color:#002}
  .pozo-2{background:linear-gradient(90deg,#7ad39a,#5fbf87);color:#002}
  .pozo-3{background:linear-gradient(90deg,#74b3ff,#4686ff);color:#002}
  .pozo-4{background:linear-gradient(90deg,#ff7b7b,#ff4c4c);color:#002}
  .pozo-5{background:linear-gradient(90deg,#ffffff,#f2f6f9);color:#002}
  .pozo-6{background:linear-gradient(90deg,#e8c3ff,#d79bf6);color:#201}

  td[data-col^="Pozo"], td[data-col^="Estado"]{font-size:var(--cell-font-size)}

  .pozoTop .badge{
    margin-left:8px;padding:2px 7px;border-radius:999px;font-size:12px;font-weight:900;line-height:1;color:#fff;
    background:rgba(0,0,0,.45);border:1px solid rgba(0,0,0,.55);
    box-shadow:0 0 0 1px rgba(255,255,255,.35),0 1px 6px rgba(0,0,0,.35);
    text-shadow:0 1px 1px rgba(0,0,0,.55);backdrop-filter:saturate(120%) blur(1px);-webkit-backdrop-filter:saturate(120%) blur(1px);
    vertical-align:middle
  }

  td.stop{background:rgba(255,60,60,.14)!important;color:#ffb3b3!important;font-weight:900;letter-spacing:.4px;text-shadow:0 0 6px rgba(255,60,60,.4)}

  .table-container::-webkit-scrollbar{height:10px;width:10px}
  .table-container::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:6px}

  .bar{display:flex;align-items:center;gap:14px;margin-bottom:10px;flex-wrap:nowrap;overflow-x:auto}

  .stockwrap{display:flex;align-items:center;gap:10px;flex:1 1 auto;min-width:0}
  .stocklabel{font-weight:800;color:#cfe8ff;opacity:.9}
  .stockbar{display:block;overflow-x:auto;overflow-y:hidden;white-space:nowrap;flex:1 1 auto}
  .pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);
        padding:8px 12px;border-radius:999px;font-size:var(--stock-font-size);color:#e9f6ff;font-weight:700;margin-right:8px}
  .pill .dot{width:8px;height:8px;border-radius:50%;box-shadow:0 0 8px rgba(255,255,255,.25)}

  .stock-theme-0{background:rgba(40,120,255,.18);border-color:rgba(40,120,255,.35)}
  .stock-theme-1{background:rgba(255,160,40,.18);border-color:rgba(255,160,40,.35)}
  .stock-theme-2{background:rgba(60,200,140,.18);border-color:rgba(60,200,140,.35)}
  .stock-theme-3{background:rgba(180,70,255,.18);border-color:rgba(180,70,255,.35)}
  .stock-theme-4{background:rgba(255,80,120,.18);border-color:rgba(255,80,120,.35)}
  .stock-theme-5{background:rgba(0,200,220,.18);border-color:rgba(0,200,220,.35)}
  .stock-theme-6{background:rgba(200,220,60,.18);border-color:rgba(200,220,60,.35)}
  .stock-theme-7{background:rgba(255,120,40,.18);border-color:rgba(255,120,40,.35)}

  .stock-low{box-shadow:inset 0 0 0 2px rgba(220,60,60,.65)}
  .stock-mid{box-shadow:inset 0 0 0 2px rgba(255,180,0,.65)}
  .stock-high{box-shadow:inset 0 0 0 2px rgba(40,200,120,.65)}
  .stock-low .dot{background:#ff6b6b}
  .stock-mid .dot{background:#ffcc66}
  .stock-high .dot{background:#4dffb3}

  .indicators{display:flex;align-items:center;gap:14px;flex:0 0 auto;min-width:max-content}
  .ind{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:8px;font-weight:700}

  .reel{display:flex;align-items:center;gap:var(--reel-gap);overflow-x:auto}
  .reel-btn{width:28px;height:28px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05);color:#cfe8ff;font-weight:800;cursor:pointer}
  .reel-btn:disabled{opacity:.4;cursor:default}
  .date-chip{display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:132px;padding:var(--reel-pad);
             border-radius:10px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)}
  .date-chip.latest{background:linear-gradient(180deg,rgba(0,163,255,.18),rgba(0,163,255,.08));border-color:rgba(0,163,255,.35)}
  .date-chip .date{font-size:var(--reel-date-size);color:#bfe8ff}
  .date-chip .num{font-size:var(--reel-num-size);font-weight:900;line-height:1.1}

  .subind{font-size:12px;color:#bfe8ff;margin-top:4px;font-weight:600;opacity:.95}
  #fractureTotal, #remainingStages { font-size:17px; }
  .status{padding:6px 12px;border-radius:999px;font-weight:800}

  footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-size:13px;color:#cfe8ff;gap:10px}
  #footerLeft{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

  /* Atenuación nocturna */
  #dimVeil{position:fixed;inset:0;pointer-events:none;background:#000;opacity:0;transition:opacity .4s ease;z-index:9996}

  /* Protector de pantalla */
  #saver{position:fixed;inset:0;display:none;z-index:9997;
    background:radial-gradient(1200px 700px at var(--blob-x,40%) var(--blob-y,35%),rgba(0,163,255,.12),rgba(0,0,0,.85) 70%);
    backdrop-filter:blur(1px)
  }
  #saver .center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;font-weight:900;letter-spacing:.5px}
  #saver .ticker{position:absolute;left:0;right:0;bottom:5%;text-align:center;font-size:14px;color:#cfe8ff;opacity:.9}
  #saverStage{position:absolute;inset:0;overflow:hidden}

  /* Imágenes rebotando */
  .bImg{position:absolute;width:min(14vw,200px);height:auto;user-select:none;pointer-events:none;opacity:.95;filter:drop-shadow(0 10px 24px rgba(0,0,0,.35));}

  /* Imágenes lluvia */
  .fallImg{position:absolute;width:min(10vw,160px);height:auto;opacity:.92;filter:drop-shadow(0 10px 20px rgba(0,0,0,.35));}

  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:9998}
  .modal-card{width:min(860px,96vw);max-height:90vh;overflow:auto;background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .modal-body{display:flex;flex-direction:column;gap:16px}
  .modal-body section{padding:12px;border:1px solid rgba(255,255,255,.06);border-radius:10px;background:rgba(255,255,255,.03)}
  .modal-body h4{margin:0 0 8px 0;font-size:14px;color:#cfe8ff}
  .grid{display:grid;gap:16px}
  .g3{grid-template-columns:1fr 1fr 1fr}
  .g2{grid-template-columns:1fr 1fr}
  .full{grid-column:1/-1}
  .modal input[type="number"], .modal input[type="range"], .modal select{width:100%}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}

  /* Reglas stock */
  .rules-head{display:grid;grid-template-columns:minmax(180px,2.3fr) minmax(80px,.8fr) minmax(110px,1fr) minmax(110px,1fr) auto;gap:12px;padding:8px 10px;color:#cfe8ff;opacity:.9}
  .rule-row{display:grid;grid-template-columns:minmax(180px,2.3fr) minmax(80px,.8fr) minmax(110px,1fr) minmax(110px,1fr) auto;gap:12px;padding:6px 10px;align-items:center}
  .rule-row input{width:100%}
  .pill.small{padding:4px 8px;font-size:12px}

  /* ============ MODO TV (Android TV / TCL) ============ */
  html.is-tv .wrap{ transform:none !important; }
  html.is-tv #saver{ backdrop-filter:none; }
  html.is-tv .bImg, html.is-tv .fallImg{ filter:none; }
  html.is-tv thead th{ -webkit-transform:translateZ(0); transform:translateZ(0); }
</style>
</head>

<body>
<div id="dimVeil"></div>
<div id="saver">
  <div id="saverStage"></div>
  <div class="center"><!-- Logo opcional --></div>
  <div class="ticker" id="saverTicker"></div>
</div>

<div class="wrap">
  <header>
    <div>
      <h1>Visor de Estado PAD</h1>
      <div class="meta">Actualiza automáticamente</div>
    </div>
    <div class="controls">
      <label class="switch"><input id="autoScroll" type="checkbox" /> Auto-scroll (últimas 7)</label>
      <button class="btn" id="btnRefresh">Forzar actualización</button>
      <button class="btn secondary" id="btnPause">Pausar</button>
      <button class="btn secondary" id="btnFull">Pantalla completa</button>
      <button class="btn secondary" id="btnSettings">Ajustes</button>
    </div>
  </header>

  <main>
    <div class="board">
      <div class="bar">
        <div class="stockwrap">
          <div class="stocklabel">STOCK ACTUAL:</div>
          <div id="stockBar" class="stockbar"></div>
        </div>
        <div class="indicators">
          <div class="ind">
            <div id="fractureTotal">Total fracturas: 0</div>
            <div id="remainingStages" class="subind">Etapas restantes: 0</div>
          </div>
          <div id="datesReel" class="reel" aria-label="Fracturas por fecha (reel)"></div>
        </div>
      </div>

      <div class="table-container" id="tableContainer">
        <table id="mainTable">
          <thead>
            <tr id="hdrTop"><th class="rowid">#</th></tr>
            <tr id="hdrSub"><th class="rowid">&nbsp;</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <footer>
        <div id="footerLeft">
          <span>Última actualización: <strong id="lastUpdate">-</strong></span>
          <span id="delta" class="delta"></span>
          <span id="netStatus" class="pill status">Conectando…</span>
        </div>
        <div class="meta">Actualiza cada <span id="refreshSec">15</span>s</div>
      </footer>
    </div>
  </main>
</div>

<!-- ===== Modal Ajustes ===== -->
<div id="settingsModal" class="modal" aria-modal="true" role="dialog" aria-label="Ajustes">
  <div class="modal-card">
    <div class="modal-head"><strong>Ajustes rápidos</strong></div>
    <div class="modal-body">
      <!-- fila 3 tamaños -->
      <section class="grid g3">
        <label>Tamaño “POZO #n”
          <input type="number" id="setPozoFont" min="12" max="40" step="1">
        </label>
        <label>Tamaño “STOCK”
          <input type="number" id="setStockFont" min="10" max="30" step="1">
        </label>
        <label>Tamaño datos (TPN/FRACTURADO)
          <input type="number" id="setCellFont" min="12" max="32" step="1">
        </label>
      </section>

      <!-- Protector -->
      <section>
        <h4>Protector de pantalla</h4>
        <div class="grid g3">
          <label>Modo
            <select id="setSaverMode">
              <option value="rotar">Rotar</option>
              <option value="blob">Luz ambiental</option>
              <option value="valores-rebotando">Valores rebotando</option>
              <option value="valores-lluvia">Lluvia de valores</option>
            </select>
          </label>
          <label>Minutos inactivo
            <input type="number" id="setSaverIdle" min="1" max="120" step="1">
          </label>
          <label>Rotar cada (min)
            <input type="number" id="setRotateEvery" min="1" max="60" step="1">
          </label>
          <div class="full" style="display:flex;gap:8px;align-items:center">
            <button class="btn secondary" id="btnTestSaver">Probar protector</button>
            <span class="pill small" id="saverStatus">—</span>
          </div>
        </div>
      </section>

      <!-- Atenuación nocturna -->
      <section>
        <h4>Atenuación nocturna</h4>
        <div class="grid g3">
          <label><input type="checkbox" id="setNightEnabled"> Activar</label>
          <label>Hora inicio <input type="number" id="setNightStart" min="0" max="23"></label>
          <label>Hora fin <input type="number" id="setNightEnd" min="0" max="23"></label>
          <label class="full">Brillo (20–100%) <input type="range" id="setNightDim" min="20" max="100"></label>
        </div>
      </section>

      <!-- Pixel-shift -->
      <section>
        <h4>Pixel-shift</h4>
        <div class="grid g3">
          <label><input type="checkbox" id="setShiftEnabled"> Activar</label>
          <label>Intervalo (min) <input type="number" id="setShiftEvery" min="1" max="60"></label>
          <label>Desplazamiento (px) <input type="number" id="setShiftPixels" min="0" max="10"></label>
        </div>
      </section>

      <!-- Reglas de stock -->
      <section>
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <h4>Reglas de stock <small style="opacity:.65">(umbral bajo/medio y unidad)</small></h4>
          <div>
            <button class="btn secondary" id="btnLoadDetected">Cargar ítems detectados</button>
            <button class="btn secondary" id="btnAddRule">Añadir regla</button>
          </div>
        </div>
        <div class="rules-head">
          <div>Ítem</div><div>Unidad</div><div>Bajo</div><div>Medio</div><div></div>
        </div>
        <div id="rulesBody"></div>
      </section>
    </div>

    <div class="modal-actions">
      <button class="btn secondary" id="btnCloseSettings">Cerrar</button>
      <button class="btn secondary" id="btnReset">Restablecer</button>
      <button class="btn" id="btnSaveSettings">Guardar</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ========= CONFIG BÁSICA ========= */
  const JSON_URL='status.json', REFRESH_SECONDS=15, ROWS=60, POZOS=6, LAST_N_TO_SHOW=8, REEL_SIZE=2;

  /* Detección de Android TV / TCL para activar modo seguro */
  const UA = navigator.userAgent || '';
  const IS_TV = /\b(Android TV|SMART-TV|HBBTV|BRAVIA|AFT|MiBOX|TCL)\b/i.test(UA) || /com\.tcl\.browser/i.test(UA);
  if (IS_TV) document.documentElement.classList.add('is-tv');

  /* Carpeta GitHub para “Valores” (1.png..6.png) */
  const DEFAULT_VALUES_BASE = 'https://github.com/baseslucas8071-maker/tablero/blob/main/images/';

  /* ========= UTILES ========= */
  const prefs={get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d;}catch{return d;}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
  const clamp=(v,a,b)=>Math.min(b,Math.max(a,v)); const pad2=n=>String(n).padStart(2,'0');

  /* Excel serial → fecha y hora */
  function excelSerialToDate(num){
    // Excel base 1899-12-30; parte entera = días; fracción = horas
    const day = Math.floor(num);
    const frac = num - day;
    const base = Date.UTC(1899,11,30);
    const ms = base + day*86400000 + Math.round(frac*86400000);
    return new Date(ms);
  }

  /* Parse robusto de fecha/hora */
  function parseDateTime(val){
    const s = (val??'').toString().trim();
    if(!s) return null;

    // 1) ISO: YYYY-MM-DD [HH:mm[:ss]]
    let m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?$/);
    if(m){
      const y=+m[1], mo=+m[2]-1, d=+m[3];
      const hh=m[4]!=null?+m[4]:0, mm=m[5]!=null?+m[5]:0, ss=m[6]!=null?+m[6]:0;
      const dt=new Date(y,mo,d,hh,mm,ss);
      return { date: `${pad2(d)}/${pad2(mo+1)}/${y}`, time: `${pad2(hh)}:${pad2(mm)}` };
    }

    // 2) Latam: DD/MM/YYYY [HH:mm[:ss]]
    m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
    if(m){
      const d=+m[1], mo=+m[2]-1, y=+m[3];
      const hh=m[4]!=null?+m[4]:0, mm=m[5]!=null?+m[5]:0;
      return { date: `${pad2(d)}/${pad2(mo+1)}/${y}`, time: `${pad2(hh)}:${pad2(mm)}` };
    }

    // 3) Excel serial (con fracción)
    if(/^-?\d+(\.\d+)?$/.test(s)){
      const n=Number(s.replace(',','.'));
      if(Number.isFinite(n) && n>=30000 && n<=80000){
        const d=excelSerialToDate(n);
        return { date: `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`, time: `${pad2(d.getHours())}:${pad2(d.getMinutes())}` };
      }
    }
    return null;
  }

  const toRawURL = u => {
    if(!u) return '';
    const m=u.match(/^https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.*)$/);
    return m ? `https://raw.githubusercontent.com/${m[1]}/${m[2]}/${m[3]}/${m[4]}` : u;
  };
  const VALUES_IMAGES = base=>{
    const b=(base||DEFAULT_VALUES_BASE); const raw=(b.endsWith('/')?b:(b+'/')); const r=toRawURL(raw);
    return [1,2,3,4,5,6].map(i=> r + i + '.png');
  };

  /* ========= NORMALIZACIÓN DE NOMBRES (stock) ========= */
  function canonicalizeName(raw){
    let s=(raw??'').toString().toUpperCase();
    s=s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    s=s.replace(/\s*:\s*$/,'');
    s=s.replace(/ARENA\s*MALLA\s*/g,'ARENA ');
    s=s.replace(/\s+/g,' ').trim();
    s=s.replace(/^GASOIL$/,'GAS OIL');
    return s;
  }

  /* ========= ESTADO PERSISTENTE ========= */
  let STOCK_RULES=prefs.get('stock:rules',{
    [canonicalizeName('GAS OIL')]:{display:'GAS OIL',unit:'M3',low:50,mid:150},
    [canonicalizeName('ARENA #100')]:{display:'ARENA #100',unit:'Tn',low:100,mid:300},
    [canonicalizeName('ARENA #30/70')]:{display:'ARENA #30/70',unit:'Tn',low:300,mid:800},
    [canonicalizeName('GEL BOLSONES')]:{display:'GEL BOLSONES',unit:'ud',low:10,mid:25},
    [canonicalizeName('GEL TOTE')]:{display:'GEL TOTE',unit:'ud',low:5,mid:15},
  });

  let DISPLAY=prefs.get('display:cfg',{
    pozoFont:20, stockFont:16, cellFont:19,
    saver:{ mode:'valores-lluvia', rotateEveryMin:3, idleMinutes:2, gitBase:DEFAULT_VALUES_BASE },
    nightDim:{ enabled:true, startHour:1, endHour:6, dimLevel:0.65 },
    pixelShift:{ enabled:true, intervalMin:2, maxOffsetPx:2 }
  });

  if (IS_TV) DISPLAY.pixelShift.enabled = false;

  /* ========= ESTADO RUNTIME ========= */
  let paused=prefs.get('ui:paused',false);
  let prevDataMap={}, latestDataMap={}, isFetching=false;
  let lastActivityTs=Date.now(); let stockCache=[];
  let shiftTimer=null, nightTimer=null, saverTO=null, rotator=null;
  let rafAnim=null; let sprites=[]; let testingTO=null;

  /* ========= DOM ========= */
  const tbody=document.getElementById('tbody');
  const hdrTop=document.getElementById('hdrTop'), hdrSub=document.getElementById('hdrSub');
  const tableContainer=document.getElementById('tableContainer');
  const autoScroll=document.getElementById('autoScroll');
  const lastUpdateEl=document.getElementById('lastUpdate'), deltaEl=document.getElementById('delta'), net=document.getElementById('netStatus');
  const stockBar=document.getElementById('stockBar');
  const btnRefresh=document.getElementById('btnRefresh'), btnPause=document.getElementById('btnPause'), btnFull=document.getElementById('btnFull'), btnSettings=document.getElementById('btnSettings');
  const fractureTotalEl=document.getElementById('fractureTotal'), datesReel=document.getElementById('datesReel'), remainingEl=document.getElementById('remainingStages');
  const dimVeil=document.getElementById('dimVeil'), saver=document.getElementById('saver'), saverTicker=document.getElementById('saverTicker'), saverStage=document.getElementById('saverStage');

  /* Modal */
  const modal=document.getElementById('settingsModal');
  const setPozoFont=document.getElementById('setPozoFont'), setStockFont=document.getElementById('setStockFont'), setCellFont=document.getElementById('setCellFont');
  const setSaverMode=document.getElementById('setSaverMode'), setRotateEvery=document.getElementById('setRotateEvery'), setSaverIdle=document.getElementById('setSaverIdle');
  const setNightEnabled=document.getElementById('setNightEnabled'), setNightStart=document.getElementById('setNightStart'), setNightEnd=document.getElementById('setNightEnd'), setNightDim=document.getElementById('setNightDim');
  const setShiftEnabled=document.getElementById('setShiftEnabled'), setShiftEvery=document.getElementById('setShiftEvery'), setShiftPixels=document.getElementById('setShiftPixels');
  const btnSave=document.getElementById('btnSaveSettings'), btnClose=document.getElementById('btnCloseSettings'), btnReset=document.getElementById('btnReset');
  const btnLoadDetected=document.getElementById('btnLoadDetected'), btnAddRule=document.getElementById('btnAddRule'), rulesBody=document.getElementById('rulesBody');
  const btnTestSaver=document.getElementById('btnTestSaver'), saverStatus=document.getElementById('saverStatus');

  /* ========= HEADER ACCIONES ========= */
  autoScroll.checked=prefs.get('ui:autoScroll',true);
  btnPause.innerText=paused?'Reanudar':'Pausar';
  document.getElementById('refreshSec').innerText=REFRESH_SECONDS;

  btnRefresh.onclick=()=>forceRefresh();
  btnPause.onclick=()=>{paused=!paused;prefs.set('ui:paused',paused);btnPause.innerText=paused?'Reanudar':'Pausar';};
  autoScroll.onchange=()=>{prefs.set('ui:autoScroll',autoScroll.checked); if(autoScroll.checked) requestAnimationFrame(()=>scrollToLastWithData(LAST_N_TO_SHOW));};

  function enterFull(){ const el=document.documentElement; (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen||el.mozRequestFullScreen)?.call(el); }
  function exitFull(){ (document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen||document.mozCancelFullScreen)?.call(document); }
  btnFull.onclick=()=>{ const fs=document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||document.mozFullScreenElement; fs?exitFull():enterFull(); };

  btnSettings.onclick=openSettings;
  btnClose.onclick=()=>modal.style.display='none';
  btnReset.onclick=()=>{localStorage.removeItem('stock:rules');localStorage.removeItem('display:cfg');location.reload();};
  btnSave.onclick=()=>{saveSettings(true); fitRowsToViewport();};
  btnLoadDetected.onclick=mergeDetectedItems;
  btnAddRule.onclick=()=>addRuleRow({display:'',unit:'',low:'',mid:''});
  btnTestSaver.addEventListener('click', (e) => {
    e.preventDefault(); e.stopImmediatePropagation();
    saveSettings(false); modal.style.display='none';
    setTimeout(()=>{ showSaver(true); },0);
    clearTimeout(testingTO); testingTO=setTimeout(hideSaver,12000);
  });

  /* ========= LISTENERS DE ACTIVIDAD ========= */
  const activityEvts=['mousemove','pointermove','touchmove','touchstart','click','wheel','keydown'];
  let lastInput={x:null,y:null,t:0};
  activityEvts.forEach(ev=>window.addEventListener(ev,markActivity,{passive:true}));

  function markActivity(e){
    const now=Date.now();
    if(e && ('mousemove pointermove touchmove'.includes(e.type))){
      const p = e.touches?.[0] || e;
      const x = p?.clientX ?? 0, y = p?.clientY ?? 0;
      if(lastInput.x!=null){
        const dx=Math.abs(x-lastInput.x), dy=Math.abs(y-lastInput.y), dt=now-lastInput.t;
        if(dx<4 && dy<4 && dt<350) return;
      }
      lastInput={x,y,t:now};
    }
    lastActivityTs=now; hideSaver(); scheduleSaver();
  }

  window.addEventListener('keydown',e=>{ if(e.key==='Escape'){modal.style.display='none'; hideSaver();}});

  /* ========= TABLA (construcción y tamaños) ========= */
  function initializeDOM(){
    for(let i=1;i<=POZOS;i++){
      const thTop=document.createElement('th'); thTop.className=`pozo-${i} pozoTop`; thTop.colSpan=3; thTop.innerText=`POZO #${i}`; hdrTop.appendChild(thTop);

      const thFH=document.createElement('th'); thFH.className='fh'; thFH.innerText='F/h TPN'; hdrSub.appendChild(thFH);
      const th1=document.createElement('th'); th1.className='pozo'; th1.innerText='TPN'; hdrSub.appendChild(th1);
      const th2=document.createElement('th'); th2.className='estado'; th2.innerText='FRACTURADO'; hdrSub.appendChild(th2);
    }
    const frag=document.createDocumentFragment();
    for(let i=1;i<=ROWS;i++){
      const id='#'+String(i).padStart(2,'0');
      const tr=document.createElement('tr'); tr.dataset.rowId=id; if(i%2===0) tr.classList.add('alt');
      const tdId=document.createElement('td'); tdId.className='rowid'; tdId.innerText=id; tr.appendChild(tdId);
      for(let p=1;p<=POZOS;p++){
        const tdFH=document.createElement('td'); tdFH.dataset.col=`Seq${p}`; tdFH.className='fh'; tr.appendChild(tdFH);
        const td1=document.createElement('td'); td1.dataset.col=`Pozo${p}`; td1.className='pozo'; tr.appendChild(td1);
        const td2=document.createElement('td'); td2.dataset.col=`Estado${p}`; td2.className='estado'; tr.appendChild(td2);
      }
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
    applyFontVars();
  }

  function applyFontVars(){
    document.documentElement.style.setProperty('--pozo-font-size', DISPLAY.pozoFont+'px');
    document.documentElement.style.setProperty('--stock-font-size', DISPLAY.stockFont+'px');
    document.documentElement.style.setProperty('--cell-font-size',  DISPLAY.cellFont+'px');
  }

  function fitRowsToViewport(){
    const vvH = window.visualViewport?.height || window.innerHeight;
    const headerRect = document.querySelector('header').getBoundingClientRect();
    const footerH = document.querySelector('footer').offsetHeight || 0;
    const available = Math.max(120, vvH - headerRect.height - 12 - footerH - 12);
    const headH = hdrTop.offsetHeight + hdrSub.offsetHeight;
    const inner = Math.max(60, available - headH);
    const target = Math.floor(inner / ROWS);
    const rowH = clamp(target, 26, 72);
    document.documentElement.style.setProperty('--row-h', rowH+'px');
  }

  /* ========= JSON / FECHAS ========= */
  function transformItems(items){
    if(!Array.isArray(items)) return [];
    return items.map(raw=>{
      const o={};
      o.fila=(raw.Fila??raw.fila??'').toString();
      for(let i=1;i<=POZOS;i++){
        o['Seq'+i]=(raw['SecuenciaPozo'+i]??'').toString();
        o['Pozo'+i]=(raw['TPNPozo'+i]??'').toString();
        o['Estado'+i]=(raw['FechaFracPozo'+i]??'').toString(); // puede traer fecha+hora
      }
      return o;
    });
  }

  const isStop=v=>String(v??'').trim().toUpperCase()==='STOP';
  const isFechaValida=v=>parseDateTime(v)!==null;

  function extractHeaderRows(c){const h=c.filter(it=>(it.fila||'').trim()===''); return {top:h[0]||null, sub:h[1]||null};}
  function itemsArrayToMap(c){const m={}; for(const it of c){const k=(it.fila||'').toString().trim(); if(!k) continue; m[k]=it;} return m;}

  /* ========= UI ENCABEZADOS / TABLA ========= */
  function updateHeaderNames(topRow, subRow){
    if(!topRow && !subRow) return;
    const n=[];
    for(let i=1;i<=POZOS;i++){
      const pTop=topRow?.['Pozo'+i]?.trim()||'', eTop=topRow?.['Estado'+i]?.trim()||'';
      const pSub=subRow?.['Pozo'+i]?.trim()||'', eSub=subRow?.['Estado'+i]?.trim()||'';
      let t=pTop||pSub||`POZO #${i}`; let s=eTop||'';
      if(!s && eSub && !/^TPN$/i.test(eSub)) s=eSub;
      n.push((t+(s?(' '+s):'' )).trim());
    }
    hdrTop.querySelectorAll('th.pozoTop').forEach((th,i)=>th.innerText=n[i]||`POZO #${i+1}`);
    const sub=hdrSub.querySelectorAll('th');
    for(let i=1;i<=POZOS;i++){
      const pSub=subRow?.['Pozo'+i]?.trim()||'TPN';
      const eSub=subRow?.['Estado'+i]?.trim()||'FRACTURADO';
      const b=(i-1)*3+1;
      if(sub[b])   sub[b].innerText='F/h TPN';
      if(sub[b+1]) sub[b+1].innerText=pSub;
      if(sub[b+2]) sub[b+2].innerText=eSub;
    }
  }

  function hasVisibleData(o){
    if(!o) return false;
    for(let i=1;i<=POZOS;i++){
      const t=(o['Pozo'+i]??'').toString().trim(), e=o['Estado'+i];
      if(t!=='' || (e && !isStop(e) && isFechaValida(e))) return true;
    }
    return false;
  }

  function renderFHCell(tdFH, seqValue, estadoRaw){
    const parsed = parseDateTime(estadoRaw);
    if(parsed){
      tdFH.innerHTML = `<span class="fhbox"><span class="f">${parsed.date}</span><br><span class="h">${parsed.time}</span></span>`;
    }else{
      // fallback (no fecha válida): mostramos la secuencia
      tdFH.textContent = (seqValue??'').toString();
    }
  }

  function updateRowCells(rowId,data){
    const tr=tbody.querySelector(`tr[data-row-id="${rowId}"]`);
    if(!tr) return{changed:false,cells:0};
    let ch=false,c=0;
    for(let p=1;p<=POZOS;p++){
      const tdFH=tr.querySelector(`td[data-col="Seq${p}"]`);
      const td1 =tr.querySelector(`td[data-col="Pozo${p}"]`);
      const td2 =tr.querySelector(`td[data-col="Estado${p}"]`);

      const vS=(data?.['Seq'+p])?String(data['Seq'+p]):'';
      const v1=(data?.['Pozo'+p])?String(data['Pozo'+p]):'';
      const raw=(data?.['Estado'+p])??'';

      // F/h TPN (fecha/hora formateada o secuencia)
      const beforeFH = tdFH?.innerHTML;
      renderFHCell(tdFH, vS, raw);
      if(tdFH && tdFH.innerHTML!==beforeFH){ ch=true; c++; }

      // TPN (texto)
      if(td1 && td1.textContent!==v1){ td1.textContent=v1; ch=true; c++; }

      // FRACTURADO (mostramos texto original o fecha legible)
      const prev2 = td2?.textContent ?? '';
      const pdt = parseDateTime(raw);
      const v2 = pdt ? `${pdt.date}` : (raw??'');
      if(td2 && prev2!==v2){ td2.textContent=v2; ch=true; c++; }

      if(td2){ td2.classList.toggle('stop', isStop(raw)||isStop(v2)); }
    }
    return{changed:ch,cells:c};
  }

  function updateDOM(map){
    let total=0;
    for(let i=1;i<=ROWS;i++){
      const id='#'+String(i).padStart(2,'0');
      const obj=map[id]||{};
      const s=JSON.stringify(obj);
      const prev=prevDataMap[id];
      if(prev===undefined){
        prevDataMap[id]=s; latestDataMap[id]=obj;
        const {cells}=updateRowCells(id,obj); total+=cells; continue;
      }
      if(prev!==s){
        const {cells}=updateRowCells(id,obj); total+=cells;
        prevDataMap[id]=s; latestDataMap[id]=obj;
      }else{
        latestDataMap[id]=obj;
      }
    }
    return {changedCellsTotal:total};
  }

  /* ========= STATS FRACTURAS ========= */
  let datesArr=[], reelStart=prefs.get('reel:start',0), userMovedReel=prefs.get('reel:moved',false);

  function computeFractureStats(conv){
    const f=new Map(); let tot=0;
    for(const it of conv){
      if(!it.fila?.trim()) continue;
      for(let i=1;i<=POZOS;i++){
        const p=parseDateTime(it['Estado'+i]);
        if(p){
          tot++;
          // normalizamos por fecha (día) únicamente
          const [d,mo,y] = p.date.split('/');
          const norm = `${y}-${pad2(+mo)}-${pad2(+d)}`;
          const cur=f.get(norm);
          cur?cur.count++:f.set(norm,{display:p.date,count:1,normalized:norm});
        }
      }
    }
    return {total:tot,freq:f};
  }

  function updateDatesArray(freq){
    datesArr=Array.from(freq.values()).sort((a,b)=>a.normalized.localeCompare(b.normalized));
    const max=Math.max(0,datesArr.length-REEL_SIZE);
    reelStart=userMovedReel?Math.min(reelStart,max):max;
    prefs.set('reel:start',reelStart);
    renderDatesReel();
  }

  function renderDatesReel(){
    const el=datesReel; el.innerHTML='';
    if(!datesArr.length){ const d=document.createElement('div'); d.className='pill'; d.textContent='Sin fechas'; el.appendChild(d); return; }
    const max=Math.max(0,datesArr.length-REEL_SIZE);
    const prev=document.createElement('button'); prev.className='reel-btn'; prev.textContent='‹'; prev.disabled=(reelStart===0);
    prev.onclick=()=>{reelStart=Math.max(0,reelStart-REEL_SIZE); userMovedReel=true; prefs.set('reel:moved',true); prefs.set('reel:start',reelStart); renderDatesReel();};
    el.appendChild(prev);
    for(let k=0;k<REEL_SIZE;k++){
      const idx=reelStart+k; if(idx>=datesArr.length) break;
      const d=datesArr[idx];
      const chip=document.createElement('div'); chip.className='date-chip'+(idx===datesArr.length-1?' latest':'');
      const dd=document.createElement('div'); dd.className='date'; dd.textContent=d.display;
      const nn=document.createElement('div'); nn.className='num'; nn.textContent=d.count;
      chip.append(dd,nn); el.appendChild(chip);
    }
    const next=document.createElement('button'); next.className='reel-btn'; next.textContent='›'; next.disabled=(reelStart>=max);
    next.onclick=()=>{reelStart=Math.min(max,reelStart+REEL_SIZE); userMovedReel=true; prefs.set('reel:moved',true); prefs.set('reel:start',reelStart); renderDatesReel();};
    el.appendChild(next);
  }

  /* ========= ETAPAS RESTANTES ========= */
  function computeRemainingStages(conv){
    const rows=conv.filter(it=>it.fila?.trim()).map(it=>{const m=it.fila.trim().match(/^#?(\d+)/);return {...it,_row:m?parseInt(m[1],10):NaN};}).filter(it=>Number.isFinite(it._row)).sort((a,b)=>a._row-b._row);
    let total=0;
    for(let p=1;p<=POZOS;p++){
      let stop=null;
      for(const r of rows){ const v=(r['Estado'+p]||'').toString().trim().toUpperCase(); if(v==='STOP'){stop=r._row; break;} }
      if(!stop) continue;
      for(const r of rows){ if(r._row>=stop) break; if((r['Estado'+p]||'').toString().trim()==='') total++; }
    }
    return total;
  }

  /* ========= STOCK ========= */
  function numFromString(s){ if(!s) return NaN; const m=s.toString().replace(',', '.').match(/-?\d+(\.\d+)?/); return m?parseFloat(m[0]):NaN; }
  function stockLevelClass(canon,val){ const rule=STOCK_RULES[canon]; if(!rule||!Number.isFinite(val)) return 'stock-mid'; if(val<rule.low) return 'stock-low'; if(val<=rule.mid) return 'stock-mid'; return 'stock-high'; }
  const themeMap=new Map();
  function renderStock(arr=[]){
    stockCache=Array.isArray(arr)?arr:[]; stockBar.innerHTML=''; let idx=0;
    for(const it of stockCache){
      const raw=(it.ITEM??'').toString();
      const canon=canonicalizeName(raw);
      if(!themeMap.has(canon)) themeMap.set(canon,(idx++)%8);
      const theme=`stock-theme-${themeMap.get(canon)}`;
      const valStr=(it.STOCK??'').toString();
      const val=numFromString(valStr);
      const cls=stockLevelClass(canon,val);
      const div=document.createElement('div'); div.className=`pill ${theme} ${cls}`;
      const dot=document.createElement('span'); dot.className='dot';
      const txt=document.createElement('span'); txt.textContent=`${raw}: ${valStr}`;
      div.append(dot,txt); stockBar.appendChild(div);
    }
  }

  /* ========= BADGES POR POZO ========= */
  function remainingPerPozo(conv){
    const rows=conv.filter(it=>it.fila?.trim()).map(it=>{const m=it.fila.trim().match(/^#?(\d+)/);return {...it,_row:m?parseInt(m[1],10):NaN};}).filter(it=>Number.isFinite(it._row)).sort((a,b)=>a._row-b._row);
    const res=Array(POZOS).fill(0);
    for(let p=1;p<=POZOS;p++){
      let stop=null;
      for(const r of rows){ const v=(r['Estado'+p]||'').toString().trim().toUpperCase(); if(v==='STOP'){stop=r._row; break;} }
      if(!stop) continue;
      for(const r of rows){ if(r._row>=stop) break; if((r['Estado'+p]||'').toString().trim()==='') res[p-1]++; }
    }
    return res;
  }
  function paintBadgesPerPozo(arr){
    document.querySelectorAll('#hdrTop th.pozoTop').forEach((th,i)=>{
      th.querySelectorAll('.badge').forEach(b=>b.remove());
      const val=arr[i]??0;
      if(val>0){ const b=document.createElement('span'); b.className='badge'; b.textContent=val; th.appendChild(b); }
    });
  }

  /* ========= PROTECCIONES: atenuación / shift / saver ========= */
  function inRangeHour(h,a,b){ return (a<=b)?(h>=a&&h<b):(h>=a||h<b); }
  function applyNightDim(){ if(!DISPLAY.nightDim.enabled){ dimVeil.style.opacity=0; return; } const h=new Date().getHours(); const on=inRangeHour(h,DISPLAY.nightDim.startHour,DISPLAY.nightDim.endHour); dimVeil.style.opacity = on ? String(1 - clamp(DISPLAY.nightDim.dimLevel,0.2,1)) : '0'; }
  function restartNight(){ clearInterval(nightTimer); applyNightDim(); nightTimer=setInterval(applyNightDim,5*60*1000); }
  function restartShift(){ clearInterval(shiftTimer); document.documentElement.style.setProperty('--nudge-x','0px'); document.documentElement.style.setProperty('--nudge-y','0px'); if(!DISPLAY.pixelShift.enabled) return; const ms=Math.max(1,DISPLAY.pixelShift.intervalMin)*60*1000; shiftTimer=setInterval(()=>{ const m=Math.max(0,DISPLAY.pixelShift.maxOffsetPx|0); const x=(Math.floor(Math.random()*(m*2+1))-m); const y=(Math.floor(Math.random()*(m*2+1))-m); document.documentElement.style.setProperty('--nudge-x',x+'px'); document.documentElement.style.setProperty('--nudge-y',y+'px'); },ms); }

  function buildSaverFrame(){ const x=30+Math.random()*40, y=25+Math.random()*40; saver.style.setProperty('--blob-x',x+'%'); saver.style.setProperty('--blob-y',y+'%'); saverTicker.textContent=new Date().toLocaleString()+'  —  (mover mouse/tecla para salir)'; }

  function clearSaver(){
    saverStage.innerHTML=''; sprites=[];
    cancelAnimationFrame(rafAnim); rafAnim=null;
    clearInterval(rotator); rotator=null;
  }

  function startBounce(images){
    clearSaver();
    const W=saverStage.clientWidth, H=saverStage.clientHeight;
    const n=Math.min(images.length,6);
    sprites=[];
    for(let i=0;i<n;i++){
      const img=document.createElement('img'); img.src=images

