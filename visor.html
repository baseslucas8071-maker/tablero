<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visor de Estado - TV</title>
<style>
  :root{
    --bg:#071027;
    --card:#08203a;
    --muted:#cfe8ff;
    --accent:#00a3ff;
    --row-alt: #0b2233;
    --row-alt-2: #071027;
    --header-height: 88px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Segoe UI,Arial,sans-serif}
  .wrap{padding:14px;box-sizing:border-box;display:flex;flex-direction:column;height:100%}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  header h1{margin:0;font-size:28px;letter-spacing:0.6px}
  header .meta{opacity:0.9;font-size:13px;color:var(--muted)}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:#0b61a8;border:none;color:white;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.08)}
  .switch{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--muted)}
  main{flex:1;margin-top:12px;display:flex;gap:18px;align-items:stretch}
  .board{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:12px;box-sizing:border-box;overflow:hidden;display:flex;flex-direction:column}
  .table-wrap{flex:1;background:transparent;border-radius:8px;overflow:auto;position:relative}
  /* Make the table as wide as needed and enable horizontal scroll if required */
  table{border-collapse:collapse;width:100%;min-width:1200px}
  th,td{border:1px solid rgba(255,255,255,0.06);padding:8px 10px;text-align:center}
  thead th{background:transparent}
  /* sticky headers inside the scrollable container: position sticky relative to .table-wrap */
  thead tr:first-child th{position:sticky;top:0;z-index:6;padding-top:12px;padding-bottom:12px;font-size:16px}
  thead tr:nth-child(2) th{position:sticky;top:44px;z-index:7;padding:8px 10px;background:rgba(0,0,0,0.15);font-weight:800}
  tbody td{height:44px;background:transparent;color:#e6f7ff}
  tbody tr.alt td{background:rgba(255,255,255,0.01)}
  td.rowid{background:rgba(255,255,255,0.03);font-weight:800;color:#bfe8ff;position:sticky;left:0;z-index:8}
  thead th:first-child{position:sticky;left:0;top:0;z-index:12;background:linear-gradient(90deg, rgba(8,8,8,0.6), rgba(8,8,8,0.4));}
  thead tr:nth-child(2) th:first-child{top:44px}
  .pozo-1{background:linear-gradient(90deg,#ffd83a,#ffd83a); color:#002;}
  .pozo-2{background:linear-gradient(90deg,#7ad39a,#5fbf87); color:#002;}
  .pozo-3{background:linear-gradient(90deg,#74b3ff,#4686ff); color:#002;}
  .pozo-4{background:linear-gradient(90deg,#ff7b7b,#ff4c4c); color:#002;}
  .pozo-5{background:linear-gradient(90deg,#dfe6ea,#cfd9de); color:#002;}
  .pozo-6{background:linear-gradient(90deg,#e6f7ff,#d2efff); color:#002;text-transform:uppercase}
  .changed { animation: highlight 1.8s ease; box-shadow: 0 6px 18px rgba(0,160,220,0.10) inset; }
  @keyframes highlight {
    0% { background: rgba(255,255,0,0.45); transform: translateY(-3px); }
    100% { background: none; transform: translateY(0); }
  }
  footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-size:13px;color:var(--muted)}
  .indicators{display:flex;gap:12px;align-items:center}
  .ind{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:8px;font-weight:700}
  /* Small screens */
  @media(max-width:900px){
    header h1{font-size:18px}
    th,td{padding:6px 6px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Visor de Estado — Pozos</h1>
        <div class="meta">Kiosk / TV • Actualiza automáticamente</div>
      </div>
      <div class="controls">
        <label class="switch"><input id="autoScroll" type="checkbox" checked /> Auto-scroll (últimas 9)</label>
        <button class="btn" id="btnRefresh">Forzar actualización</button>
        <button class="btn secondary" id="btnPause">Pausar</button>
      </div>
    </header>

    <main>
      <div class="board">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-size:14px">Última actualización: <strong id="lastUpdate">-</strong></div>
          <div class="indicators">
            <div class="ind" id="totalCount">Total: 0</div>
            <div class="ind" id="alertCount">Alertas: 0</div>
          </div>
        </div>

        <div class="table-wrap" id="tableWrap" tabindex="0">
          <table id="mainTable" aria-label="Visor">
            <thead>
              <tr id="hdrTop">
                <th style="width:90px">#</th>
                <!-- pozo headers insertados dinámicamente -->
              </tr>
              <tr id="hdrSub">
                <th>&nbsp;</th>
                <!-- subheaders (TPN / FRACTURADO) insertados dinámicamente -->
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- filas generadas dinámicamente -->
            </tbody>
          </table>
        </div>

        <footer>
          <div class="meta">Fuente: status.json (GitHub Pages)</div>
          <div class="meta">Actualiza cada <span id="refreshSec">15</span>s</div>
        </footer>
      </div>
    </main>
  </div>

<script>
/* CONFIGURACIÓN */
const JSON_URL = 'status.json';    // ruta del JSON
const REFRESH_SECONDS = 15;        // intervalo
const ROWS = 60;                   // #01..#60
const POZOS = 6;                   // número de pozos (cada uno = 2 columnas)

/* ESTADO */
let pozoNames = ["POZO #1 AAA","POZO #2 BBB","POZO #3 CCC","POZO #4 DDD","POZO #5 EEEE","POZO #6 FFF"];
let paused = false;
let prevMap = {};        // snapshot anterior por fila
let latestDataMap = {};  // mapa actual por fila

/* UI bindings */
document.getElementById('refreshSec').innerText = REFRESH_SECONDS;
document.getElementById('btnRefresh').addEventListener('click', ()=> loadAndRender(true));
document.getElementById('btnPause').addEventListener('click', togglePause);
const autoScrollCheckbox = document.getElementById('autoScroll');
const tableWrap = document.getElementById('tableWrap');
const tbody = document.getElementById('tbody');

function togglePause(){
  paused = !paused;
  document.getElementById('btnPause').innerText = paused ? 'Reanudar' : 'Pausar';
}

/* Construye los headers superior y subheaders */
function buildHeaders(){
  const hdrTop = document.getElementById('hdrTop');
  const hdrSub = document.getElementById('hdrSub');
  // limpiar existentes
  hdrTop.querySelectorAll('th.pozoTop').forEach(n=>n.remove());
  hdrSub.querySelectorAll('th.pozoSub').forEach(n=>n.remove());
  for(let i=0;i<POZOS;i++){
    const idx = i+1;
    const name = pozoNames[i] || `POZO #${idx}`;
    const thTop = document.createElement('th');
    thTop.className = `pozo-${idx} pozoTop`;
    thTop.colSpan = 2;
    thTop.innerText = name;
    hdrTop.appendChild(thTop);

    const sub1 = document.createElement('th');
    sub1.className = 'pozoSub';
    sub1.innerText = 'TPN';
    const sub2 = document.createElement('th');
    sub2.className = 'pozoSub';
    sub2.innerText = 'FRACTURADO';
    hdrSub.appendChild(sub1);
    hdrSub.appendChild(sub2);
  }
}

/* Convierte array de items a map por 'fila' */
function itemsArrayToMap(items){
  const map = {};
  if(!Array.isArray(items)) return map;
  for(const it of items){
    const key = (it.fila||'').toString().trim();
    if(key) map[key] = it;
  }
  return map;
}

/* Comprueba si la fila tiene algún dato visible */
function tieneDatosVisibles(dataObj){
  if(!dataObj) return false;
  for(let i=1;i<=POZOS;i++){
    const p = dataObj['Pozo'+i];
    const e = dataObj['Estado'+i];
    if((p && String(p).trim()!=='') || (e && String(e).trim()!=='')) return true;
  }
  return false;
}

/* Renderiza TODAS las filas (#01..#60) en el tbody */
function renderAllRows(){
  tbody.innerHTML = '';
  for(let i=1;i<=ROWS;i++){
    const id = '#' + String(i).padStart(2,'0');
    const tr = document.createElement('tr');
    if(i%2===0) tr.classList.add('alt');

    const tdId = document.createElement('td');
    tdId.className = 'rowid';
    tdId.innerText = id;
    tr.appendChild(tdId);

    const data = latestDataMap[id] || {};
    for(let po=1;po<=POZOS;po++){
      const td1 = document.createElement('td');
      td1.innerText = data['Pozo'+po] || '';
      tr.appendChild(td1);
      const td2 = document.createElement('td');
      td2.innerText = data['Estado'+po] || '';
      tr.appendChild(td2);
    }

    tbody.appendChild(tr);
  }
}

/* Resalta filas que cambiaron */
function applyChangeHighlights(changedIds){
  if(!changedIds || changedIds.length===0) return;
  const rows = Array.from(tbody.querySelectorAll('tr'));
  changedIds.forEach(id=>{
    const tr = rows.find(r => r.querySelector('td.rowid')?.innerText === id);
    if(tr){
      tr.classList.add('changed');
      setTimeout(()=> tr.classList.remove('changed'), 2000);
    }
  });
}

/* Hace scroll para que la primera fila de las últimas N esté visible */
function scrollToShowLastN(n){
  if(!autoScrollCheckbox.checked) return;
  // buscar las filas con datos, ordenadas por número
  const allIds = [];
  for(let i=1;i<=ROWS;i++) allIds.push('#'+String(i).padStart(2,'0'));
  const withData = allIds.filter(id => tieneDatosVisibles(latestDataMap[id]));
  if(withData.length===0) return;
  const lastN = withData.slice(-n); // últimas N por índice
  const firstToShow = lastN[0]; // mantener orden ascendente
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const tr = rows.find(r => r.querySelector('td.rowid')?.innerText === firstToShow);
  if(!tr) return;
  // calcular desplazamiento relativo al contenedor
  const container = tableWrap;
  const containerRect = container.getBoundingClientRect();
  const trRect = tr.getBoundingClientRect();
  const offset = trRect.top - containerRect.top;
  // desplazar suavemente para que la fila quede algo centrada (menos el encabezado sticky)
  const headerHeight = container.querySelector('thead').offsetHeight;
  container.scrollTop = container.scrollTop + offset - headerHeight - 8;
}

/* Actualiza contadores y llama al render */
function updateCounters(){
  const totalConDatos = Object.keys(latestDataMap).filter(k => tieneDatosVisibles(latestDataMap[k])).length;
  let alertCount = 0;
  for(const k of Object.keys(latestDataMap)){
    for(let p=1;p<=POZOS;p++){
      const val = String(latestDataMap[k]['Estado'+p] || '').toUpperCase();
      if(val.includes('FRACT') || val.includes('ALERT') || val.includes('FAULT')) alertCount++;
    }
  }
  document.getElementById('totalCount').innerText = `Total: ${totalConDatos}`;
  document.getElementById('alertCount').innerText = `Alertas: ${alertCount}`;
}

/* Carga JSON, actualiza latestDataMap, renderiza y hace scroll si corresponde */
async function loadAndRender(force=false){
  if(paused && !force) return;
  try{
    const res = await fetch(JSON_URL + '?_=' + Date.now(), {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    // si JSON trae encabezados (fila == "" ), actualizamos nombres de pozo
    if(Array.isArray(json.items)){
      const header = json.items.find(it => (it.fila||'').toString().trim()==='');
      if(header){
        const newNames = [];
        for(let i=1;i<=POZOS;i++){
          const p = header['Pozo'+i] || '';
          const e = header['Estado'+i] || '';
          newNames.push( (p? p : `POZO #${i}`) + (e? (' ' + e) : '') );
        }
        if(JSON.stringify(newNames) !== JSON.stringify(pozoNames)){
          pozoNames = newNames;
          buildHeaders();
        }
      }
    }
    // construir mapa
    const newMap = itemsArrayToMap(json.items || []);
    // detectar cambios
    const changed = [];
    for(const i=1;i<=ROWS;i++){
      const id = '#'+String(i).padStart(2,'0');
      const newObj = newMap[id] || {};
      const s = JSON.stringify(newObj);
      if(prevMap[id] !== s && prevMap[id] !== undefined){ // si prevMap undefined = primer run -> no highlight
        changed.push(id);
      }
      prevMap[id] = s;
    }
    latestDataMap = newMap;
    // renderizamos todo
    renderAllRows();
    updateCounters();
    // aplicar highlight
    applyChangeHighlights(changed);
    // si hay auto-scroll -> mostrar últimas 9 filas con datos
    if(autoScrollCheckbox.checked && !paused){
      scrollToShowLastN(9);
    }
    // actualizar fecha
    const last = json.lastUpdate || new Date().toISOString();
    document.getElementById('lastUpdate').innerText = new Date(last).toLocaleString();
  }catch(err){
    console.error('Error cargando status.json:', err);
    document.getElementById('lastUpdate').innerHTML = `<span style="color:salmon">Error al cargar datos</span>`;
  }
}

/* Init */
buildHeaders();
renderAllRows();
loadAndRender(true);
setInterval(()=> loadAndRender(false), REFRESH_SECONDS * 1000);

</script>
</body>
</html>
