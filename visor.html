<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visor Estado Pozos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }
    h1 {
      text-align: center;
      padding: 20px;
      background: #004080;
      color: white;
      margin: 0;
    }
    #table-container {
      height: 500px;
      overflow-y: auto;
      background: white;
      margin: 20px auto;
      padding: 10px;
      border-radius: 8px;
      width: 95%;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead {
      background: #004080;
      color: white;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    tbody tr:nth-child(even) {
      background: #f9f9f9;
    }
    tbody tr:hover {
      background: #dbe9ff;
    }
  </style>
</head>
<body>
  <h1>Visor de Estado de Pozos</h1>
  <div id="table-container">
    <table>
      <thead>
        <tr id="table-header"></tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

<script>
  const tableBody = document.getElementById("table-body");
  const tableHeader = document.getElementById("table-header");
  const tableContainer = document.getElementById("table-container");

  let lastDataString = "";
  let isLoading = false;
  let userScrolledManually = false;

  // Detecta si el usuario movió el scroll
  function isUserAtBottom(margin = 60) {
    return (tableContainer.scrollHeight - (tableContainer.scrollTop + tableContainer.clientHeight)) <= margin;
  }
  tableContainer.addEventListener('scroll', () => {
    userScrolledManually = !isUserAtBottom(40);
  });

  // Función para renderizar la tabla
  function renderTable(items) {
    if (!items || items.length === 0) return;

    // Encabezados
    tableHeader.innerHTML = "";
    Object.keys(items[0]).forEach(key => {
      const th = document.createElement("th");
      th.textContent = key;
      tableHeader.appendChild(th);
    });

    // Filas
    tableBody.innerHTML = "";
    items.forEach(obj => {
      const tr = document.createElement("tr");
      Object.values(obj).forEach(val => {
        const td = document.createElement("td");
        td.textContent = val;
        tr.appendChild(td);
      });
      tableBody.appendChild(tr);
    });
  }

  // Auto-scroll para mostrar última fila + 7 anteriores
  function scrollToLastRows(n = 8) {
    const rows = tableBody.querySelectorAll("tr");
    if (rows.length === 0) return;

    const targetIndex = Math.max(0, rows.length - n);
    const targetRow = rows[targetIndex];

    tableContainer.scrollTop = targetRow.offsetTop;
  }

  // Cargar datos del backend
  async function loadAndRender(isForced = false) {
    if (isLoading) return;
    isLoading = true;

    try {
      const res = await fetch('/api/data');
      const data = await res.json();

      if (!data.items || !Array.isArray(data.items)) {
        console.error("El JSON recibido no contiene 'items' válidos");
        return;
      }

      // Verificar cambios
      const dataString = JSON.stringify(data.items);
      if (!isForced && dataString === lastDataString) return;
      lastDataString = dataString;

      // Renderizar
      renderTable(data.items);

      // Auto-scroll solo si usuario no tocó scroll
      if (!userScrolledManually) {
        scrollToLastRows(8);
      }
    } catch (err) {
      console.error("Error cargando datos:", err);
    } finally {
      isLoading = false;
    }
  }

  // Refresco cada 5 seg
  setInterval(() => loadAndRender(false), 5000);

  // Cargar inicial
  loadAndRender(true);
</script>
</body>
</html>

