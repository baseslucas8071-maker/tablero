<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visor de Estado - TV</title>
<style>
  :root {
    --bg: #071027;
    --card: #08203a;
    --muted: #cfe8ff;
    --accent: #00a3ff;
    --header-h-1: 48px;
    --header-h-2: 44px;
  }
  html, body { height: 100%; margin: 0; background: var(--bg); color: #fff; font-family: Inter, Segoe UI, Arial, sans-serif; }
  .wrap { padding: 14px; box-sizing: border-box; display: flex; flex-direction: column; height: 100%; }
  header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  header h1 { margin: 0; font-size: 28px; letter-spacing: 0.6px; }
  header .meta { opacity: 0.9; font-size: 13px; color: var(--muted); }
  .controls { display: flex; gap: 8px; align-items: center; }
  .btn { background: #0b61a8; border: none; color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }
  .btn.secondary { background: transparent; border: 1px solid rgba(255, 255, 255, 0.08); }
  .switch { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--muted); cursor: pointer; }
  main { flex: 1; margin-top: 12px; display: flex; min-height: 0; }
  .board { flex: 1; background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01)); border-radius: 10px; padding: 12px; box-sizing: border-box; display: flex; flex-direction: column; }
  
  .table-container { flex: 1; overflow: auto; border-radius: 8px; position: relative; min-height: 0; }
  table { border-collapse: collapse; width: 100%; min-width: 1200px; }
  th, td { border: 1px solid rgba(255, 255, 255, 0.06); padding: 8px 10px; text-align: center; white-space: nowrap; }
  
  thead th { background: var(--bg); }
  thead tr:first-child th { position: sticky; top: 0; z-index: 11; height: var(--header-h-1); }
  thead tr:nth-child(2) th { position: sticky; top: var(--header-h-1); z-index: 12; height: var(--header-h-2); }
  
  tbody td { height: 44px; background: transparent; color: #e6f7ff; }
  tbody tr.alt td { background: rgba(255, 255, 255, 0.01); }
  
  td.rowid { position: sticky; left: 0; z-index: 5; font-weight: 800; color: #bfe8ff; background: #0c1833; }
  thead th:first-child { position: sticky; left: 0; z-index: 15; }
  
  .pozo-1{background:linear-gradient(90deg,#ffd83a,#ffd83a); color:#002;}
  .pozo-2{background:linear-gradient(90deg,#7ad39a,#5fbf87); color:#002;}
  .pozo-3{background:linear-gradient(90deg,#74b3ff,#4686ff); color:#002;}
  .pozo-4{background:linear-gradient(90deg,#ff7b7b,#ff4c4c); color:#002;}
  .pozo-5{background:linear-gradient(90deg,#dfe6ea,#cfd9de); color:#002;}
  .pozo-6{background:linear-gradient(90deg,#e6f7ff,#d2efff); color:#002;}

  .changed { animation: highlight 1.8s ease; }
  @keyframes highlight {
    0%, 20% { background: rgba(0, 163, 255, 0.4); }
    100% { background: none; }
  }

  /* ✅ Indicador visual para saber que el refresco está funcionando */
  .fetching-indicator { animation: pulse 1s; }
  @keyframes pulse {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
  }

  footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 13px; color: var(--muted); }
  .indicators { display: flex; gap: 12px; align-items: center; }
  .ind { background: rgba(255, 255, 255, 0.03); padding: 6px 10px; border-radius: 8px; font-weight: 700; }
  .table-container::-webkit-scrollbar{height:10px;width:10px}
  .table-container::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:6px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Visor de Estado — Pozos</h1>
        <div class="meta">Kiosk / TV • Actualiza automáticamente</div>
      </div>
      <div class="controls">
        <label class="switch"><input id="autoScroll" type="checkbox" checked /> Auto-scroll (últimas 7)</label>
        <button class="btn" id="btnRefresh">Forzar actualización</button>
        <button class="btn secondary" id="btnPause">Pausar</button>
      </div>
    </header>
    <main>
      <div class="board">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div id="updateContainer" style="font-size:14px">Última actualización: <strong id="lastUpdate">-</strong></div>
          <div class="indicators">
            <div class="ind" id="totalCount">Total: 0</div>
            <div class="ind" id="alertCount">Alertas: 0</div>
          </div>
        </div>
        <div class="table-container" id="tableContainer">
          <table id="mainTable">
            <thead>
              <tr id="hdrTop"><th style="width:90px">#</th></tr>
              <tr id="hdrSub"><th>&nbsp;</th></tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <footer>
          <div class="meta">Fuente: status.json (GitHub Pages)</div>
          <div class="meta">Actualiza cada <span id="refreshSec">15</span>s</div>
        </footer>
      </div>
    </main>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const JSON_URL = 'status.json';
    const REFRESH_SECONDS = 15;
    const ROWS = 60;
    const POZOS = 6;
    const LAST_N_TO_SHOW = 7;

    let pozoNames = Array.from({ length: POZOS }, (_, i) => `POZO #${i + 1}`);
    let paused = false;
    let prevDataMap = {};

    const tbody = document.getElementById('tbody');
    const hdrTop = document.getElementById('hdrTop');
    const hdrSub = document.getElementById('hdrSub');
    const tableContainer = document.getElementById('tableContainer');
    const autoScrollCheckbox = document.getElementById('autoScroll');
    const updateContainer = document.getElementById('updateContainer');

    document.getElementById('refreshSec').innerText = REFRESH_SECONDS;
    document.getElementById('btnRefresh').addEventListener('click', () => loadAndRender(true));
    document.getElementById('btnPause').addEventListener('click', togglePause);
    
    function togglePause() {
        paused = !paused;
        document.getElementById('btnPause').innerText = paused ? 'Reanudar' : 'Pausar';
    }

    function initializeDOM() {
        for (let i = 1; i <= POZOS; i++) {
            const thTop = document.createElement('th');
            thTop.className = `pozo-${i} pozoTop`;
            thTop.colSpan = 2;
            thTop.innerText = `POZO #${i}`;
            hdrTop.appendChild(thTop);

            const thSub1 = document.createElement('th');
            thSub1.innerText = 'TPN';
            hdrSub.appendChild(thSub1);
            const thSub2 = document.createElement('th');
            thSub2.innerText = 'FRACTURADO';
            hdrSub.appendChild(thSub2);
        }

        for (let i = 1; i <= ROWS; i++) {
            const id = '#' + String(i).padStart(2, '0');
            const tr = document.createElement('tr');
            tr.dataset.rowId = id;
            if (i % 2 === 0) tr.classList.add('alt');

            const tdId = document.createElement('td');
            tdId.className = 'rowid';
            tdId.innerText = id;
            tr.appendChild(tdId);

            for (let p = 1; p <= POZOS; p++) {
                const td1 = document.createElement('td');
                td1.dataset.col = `Pozo${p}`;
                tr.appendChild(td1);
                const td2 = document.createElement('td');
                td2.dataset.col = `Estado${p}`;
                tr.appendChild(td2);
            }
            tbody.appendChild(tr);
        }
    }

    function itemsArrayToMap(items) {
        const map = {};
        if (!Array.isArray(items)) return map;
        for (const it of items) {
            if (it.hasOwnProperty('fila')) {
                const key = (it.fila || '').toString().trim();
                map[key] = it;
            }
        }
        return map;
    }

    function hasVisibleData(dataObj) {
        if (!dataObj) return false;
        for (let i = 1; i <= POZOS; i++) {
            if ((dataObj['Pozo' + i] && String(dataObj['Pozo' + i]).trim() !== '') || (dataObj['Estado' + i] && String(dataObj['Estado' + i]).trim() !== '')) return true;
        }
        return false;
    }
    
    // ✅ FUNCIÓN CORREGIDA: Ahora es más segura y solo actualiza si el dato parece un nombre de pozo.
    function updateHeaderNames(headerObj) {
        if (!headerObj) return;
        const newNames = [];
        let needsUpdate = false;
        for (let i = 1; i <= POZOS; i++) {
            const p = headerObj['Pozo' + i] || '';
            const e = headerObj['Estado' + i] || '';
            
            // Solo combinamos si 'p' realmente parece un nombre de pozo
            let finalName = pozoNames[i-1]; // Empezamos con el nombre actual
            if (p.toUpperCase().startsWith('POZO')) {
                finalName = (p + (e ? ' ' + e : '')).trim();
            }
            newNames.push(finalName);
            if(finalName !== pozoNames[i-1]) needsUpdate = true;
        }

        if (needsUpdate) {
            pozoNames = newNames;
            hdrTop.querySelectorAll('th.pozoTop').forEach((th, idx) => {
                if (newNames[idx]) th.innerText = newNames[idx];
            });
        }
    }

    function updateDOM(dataMap) {
        const allChangedRows = new Set();
        let totalWithData = 0;
        let alertCount = 0;

        for (let i = 1; i <= ROWS; i++) {
            const id = '#' + String(i).padStart(2, '0');
            const tr = tbody.querySelector(`tr[data-row-id="${id}"]`);
            if (!tr) continue;

            const newData = dataMap[id] || {};
            const prevDataString = prevDataMap[id] || '{}';
            const newDataString = JSON.stringify(newData);

            if (hasVisibleData(newData)) totalWithData++;
            
            if (newDataString !== prevDataString) {
                allChangedRows.add(tr);
                for (let p = 1; p <= POZOS; p++) {
                    tr.querySelector(`td[data-col="Pozo${p}"]`).innerText = newData['Pozo' + p] || '';
                    tr.querySelector(`td[data-col="Estado${p}"]`).innerText = newData['Estado' + p] || '';
                }
                prevDataMap[id] = newDataString;
            }

            for (let p = 1; p <= POZOS; p++) {
                const v = String(newData['Estado' + p] || '').toUpperCase();
                if (v.includes('FRACT') || v.includes('ALERT') || v.includes('FAULT')) alertCount++;
            }
        }
        
        document.getElementById('totalCount').innerText = `Total: ${totalWithData}`;
        document.getElementById('alertCount').innerText = `Alertas: ${alertCount}`;

        allChangedRows.forEach(tr => {
            tr.classList.add('changed');
            setTimeout(() => tr.classList.remove('changed'), 1800);
        });
    }

    function autoScrollView() {
        if (!autoScrollCheckbox.checked) return;

        const rowsWithData = Array.from(tbody.querySelectorAll('tr'))
            .filter(tr => hasVisibleData(prevDataMap[tr.dataset.rowId] ? JSON.parse(prevDataMap[tr.dataset.rowId]) : null));

        if (rowsWithData.length === 0) return;

        const lastNRows = rowsWithData.slice(-LAST_N_TO_SHOW);
        const targetRow = lastNRows[0];

        if (targetRow) {
            const headerHeight = hdrTop.offsetHeight + hdrSub.offsetHeight;
            const targetPosition = targetRow.offsetTop - headerHeight - 10;
            tableContainer.scrollTo({ top: targetPosition, behavior: 'smooth' });
        }
    }

    async function loadAndRender(isForced = false) {
        if (paused && !isForced) return;
        
        // ✅ Añadimos el indicador visual de que la actualización está en curso
        updateContainer.classList.add('fetching-indicator');

        try {
            const res = await fetch(`${JSON_URL}?_=${Date.now()}`, { cache: 'no-store' });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();
            
            document.getElementById('lastUpdate').innerText = new Date(json.lastUpdate || Date.now()).toLocaleString();
            
            const dataMap = itemsArrayToMap(json.items || []);
            const headerRow = dataMap[""];
            if (headerRow) updateHeaderNames(headerRow);
            
            updateDOM(dataMap);
            autoScrollView();

        } catch (err) {
            console.error('Error al cargar datos:', err);
            document.getElementById('lastUpdate').innerHTML = `<span style="color:salmon">Error de conexión</span>`;
        } finally {
            // ✅ Quitamos el indicador visual al terminar
            setTimeout(() => {
                updateContainer.classList.remove('fetching-indicator');
            }, 500);
        }
    }

    initializeDOM();
    loadAndRender(true);
    setInterval(() => loadAndRender(false), REFRESH_SECONDS * 1000);
});
</script>
</body>
</html>
