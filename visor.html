<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visor de Estado PAD</title>
<style>
  :root{
    --bg:#071027;
    --card:#08203a;
    --muted:#cfe8ff;
    --header-h-1:48px;
    --header-h-2:44px;

    /* tamaños por defecto (pedidos) */
    --pozo-font-size:20px;
    --stock-font-size:16px;
    --cell-font-size:16px;      /* TPN/FRACTURADO */

    --w-id:54px;
    --w-seq:50px;

    /* mini-reel */
    --reel-gap:8px; --reel-pad:10px; --reel-num-size:20px; --reel-date-size:12px;

    /* pixel-shift */
    --nudge-x:0px; --nudge-y:0px;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Segoe UI,Arial,sans-serif}
  .wrap{padding:14px;box-sizing:border-box;display:flex;flex-direction:column;height:100%;
        transform:translate(var(--nudge-x),var(--nudge-y));transition:transform .25s ease;}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  header h1{margin:0;font-size:28px;letter-spacing:.6px}
  header .meta{opacity:.9;font-size:13px;color:#9fd7ff}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{background:#0b61a8;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,.08)}
  .switch{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--muted);cursor:pointer}

  main{flex:1;margin-top:12px;display:flex;min-height:0}
  .board{flex:1;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
         border-radius:10px;padding:12px;box-sizing:border-box;display:flex;flex-direction:column}

  .table-container{flex:1;overflow:auto;border-radius:8px;position:relative;min-height:0}
  table{border-collapse:collapse;width:100%;min-width:1280px}
  th,td{border:1px solid rgba(255,255,255,.06);padding:8px 10px;text-align:center;white-space:nowrap}
  thead th{background:var(--bg);box-shadow:0 2px 0 rgba(0,0,0,.25)}
  thead tr:first-child th{position:sticky;top:0;z-index:11;height:var(--header-h-1)}
  thead tr:nth-child(2) th{position:sticky;top:var(--header-h-1);z-index:12;height:var(--header-h-2)}
  tbody td{height:44px;background:transparent;color:#e6f7ff;transition:background .15s ease}
  tbody tr.alt td{background:rgba(255,255,255,.01)}
  tbody tr:hover td{background:rgba(255,255,255,.03)}

  th.rowid,td.rowid{position:sticky;left:0;z-index:20;width:var(--w-id);min-width:var(--w-id);max-width:var(--w-id)}
  td.rowid{font-weight:800;color:#bfe8ff;background:#0c1833}

  th.seq,td.seq{width:var(--w-seq);min-width:var(--w-seq);max-width:var(--w-seq)}
  td.seq{font-weight:800;color:#00ff9c;letter-spacing:.4px;text-shadow:0 0 6px rgba(0,255,160,.7),0 0 12px rgba(0,255,160,.35);background:rgba(0,255,160,.05)}

  .pozoTop{font-size:var(--pozo-font-size);font-weight:800;letter-spacing:.6px;position:relative}
  .pozo-1{background:linear-gradient(90deg,#ffd83a,#ffd83a);color:#002}
  .pozo-2{background:linear-gradient(90deg,#7ad39a,#5fbf87);color:#002}
  .pozo-3{background:linear-gradient(90deg,#74b3ff,#4686ff);color:#002}
  .pozo-4{background:linear-gradient(90deg,#ff7b7b,#ff4c4c);color:#002}
  .pozo-5{background:linear-gradient(90deg,#ffffff,#f2f6f9);color:#002}
  .pozo-6{background:linear-gradient(90deg,#e8c3ff,#d79bf6);color:#201}

  /* tamaño datos TPN/FRACTURADO */
  td[data-col^="Pozo"], td[data-col^="Estado"]{font-size:var(--cell-font-size)}

  .pozoTop .badge{
    margin-left:8px;padding:2px 7px;border-radius:999px;font-size:12px;font-weight:900;line-height:1;color:#fff;
    background:rgba(0,0,0,.45);border:1px solid rgba(0,0,0,.55);
    box-shadow:0 0 0 1px rgba(255,255,255,.35),0 1px 6px rgba(0,0,0,.35);
    text-shadow:0 1px 1px rgba(0,0,0,.55);backdrop-filter:saturate(120%) blur(1px);-webkit-backdrop-filter:saturate(120%) blur(1px);
    vertical-align:middle
  }

  td.stop{background:rgba(255,60,60,.14)!important;color:#ffb3b3!important;font-weight:900;letter-spacing:.4px;text-shadow:0 0 6px rgba(255,60,60,.4)}

  .table-container::-webkit-scrollbar{height:10px;width:10px}
  .table-container::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:6px}

  .bar{display:flex;align-items:center;gap:14px;margin-bottom:10px;flex-wrap:nowrap;overflow-x:auto}

  .stockwrap{display:flex;align-items:center;gap:10px;flex:1 1 auto;min-width:0}
  .stocklabel{font-weight:800;color:#cfe8ff;opacity:.9}
  .stockbar{display:block;overflow-x:auto;overflow-y:hidden;white-space:nowrap;flex:1 1 auto}
  .pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);
        padding:8px 12px;border-radius:999px;font-size:var(--stock-font-size);color:#e9f6ff;font-weight:700;margin-right:8px}
  .pill .dot{width:8px;height:8px;border-radius:50%;box-shadow:0 0 8px rgba(255,255,255,.25)}

  .stock-theme-0{background:rgba(40,120,255,.18);border-color:rgba(40,120,255,.35)}
  .stock-theme-1{background:rgba(255,160,40,.18);border-color:rgba(255,160,40,.35)}
  .stock-theme-2{background:rgba(60,200,140,.18);border-color:rgba(60,200,140,.35)}
  .stock-theme-3{background:rgba(180,70,255,.18);border-color:rgba(180,70,255,.35)}
  .stock-theme-4{background:rgba(255,80,120,.18);border-color:rgba(255,80,120,.35)}
  .stock-theme-5{background:rgba(0,200,220,.18);border-color:rgba(0,200,220,.35)}
  .stock-theme-6{background:rgba(200,220,60,.18);border-color:rgba(200,220,60,.35)}
  .stock-theme-7{background:rgba(255,120,40,.18);border-color:rgba(255,120,40,.35)}

  .stock-low{box-shadow:inset 0 0 0 2px rgba(220,60,60,.65)}
  .stock-mid{box-shadow:inset 0 0 0 2px rgba(255,180,0,.65)}
  .stock-high{box-shadow:inset 0 0 0 2px rgba(40,200,120,.65)}
  .stock-low .dot{background:#ff6b6b}
  .stock-mid .dot{background:#ffcc66}
  .stock-high .dot{background:#4dffb3}

  .indicators{display:flex;align-items:center;gap:14px;flex:0 0 auto;min-width:max-content}
  .ind{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:8px;font-weight:700}

  .reel{display:flex;align-items:center;gap:var(--reel-gap);overflow-x:auto}
  .reel-btn{width:28px;height:28px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05);color:#cfe8ff;font-weight:800;cursor:pointer}
  .reel-btn:disabled{opacity:.4;cursor:default}
  .date-chip{display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:132px;padding:var(--reel-pad);
             border-radius:10px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)}
  .date-chip.latest{background:linear-gradient(180deg,rgba(0,163,255,.18),rgba(0,163,255,.08));border-color:rgba(0,163,255,.35)}
  .date-chip .date{font-size:var(--reel-date-size);color:#bfe8ff}
  .date-chip .num{font-size:var(--reel-num-size);font-weight:900;line-height:1.1}

  .subind{font-size:12px;color:#bfe8ff;margin-top:4px;font-weight:600;opacity:.95}
  .status{padding:6px 12px;border-radius:999px;font-weight:800}

  footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-size:13px;color:var(--muted);gap:10px}
  #footerLeft{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

  /* dimmer nocturno */
  #dimVeil{position:fixed;inset:0;pointer-events:none;background:#000;opacity:0;transition:opacity .4s ease;z-index:9996}

  /* screensaver */
  #saver{position:fixed;inset:0;display:none;z-index:9997;background:radial-gradient(1200px 700px at var(--blob-x,40%) var(--blob-y,35%),rgba(0,163,255,.12),rgba(0,0,0,.85) 70%);backdrop-filter:blur(1px)}
  #saver .center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;font-weight:900;letter-spacing:.5px}
  #saver .logo{width:min(22vw,260px);opacity:.9;animation:float 8s ease-in-out infinite alternate}
  @keyframes float{from{transform:translate(-50%,-50%) translate(-12px,6px)}to{transform:translate(-50%,-50%) translate(12px,-6px)}}
  #saver .ticker{position:absolute;left:0;right:0;bottom:5%;text-align:center;font-size:14px;color:#cfe8ff;opacity:.9}

  /* Modal Ajustes */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:9998}
  .modal-card{width:min(920px,96vw);max-height:90vh;overflow:auto;background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:14px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .modal-body{display:flex;flex-direction:column;gap:14px}
  .modal-body section{padding:10px;border:1px solid rgba(255,255,255,.06);border-radius:10px;background:rgba(255,255,255,.03)}
  .modal-body h4{margin:0 0 8px 0;font-size:14px;color:#cfe8ff}
  .modal .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .modal input[type="number"],.modal input[type="range"],.modal select{width:100%}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}

  /* Reglas de stock: tabla flexible sin desbordes */
  .rules-head{display:grid;grid-template-columns:minmax(160px,2.2fr) minmax(70px,.8fr) minmax(110px,1fr) minmax(110px,1fr) auto;gap:8px;padding:8px 10px;color:#cfe8ff;opacity:.9}
  .rule-row{display:grid;grid-template-columns:minmax(160px,2.2fr) minmax(70px,.8fr) minmax(110px,1fr) minmax(110px,1fr) auto;gap:8px;padding:6px 10px;align-items:center}
  .rule-row input{width:100%}
  .pill.small{padding:4px 8px;font-size:12px}
</style>
</head>
<body>
<div id="dimVeil"></div>
<div id="saver">
  <div class="center">
    <!-- Pon tu logo en /logo.png | si no existe, se muestra texto -->
    <img class="logo" id="logoImg" alt="logo" src="logo.png" onerror="this.remove()">
    <div id="logoFallback" style="font-size:42px;display:none">Pluspetrol</div>
  </div>
  <div class="ticker" id="saverTicker"></div>
</div>

<div class="wrap">
  <header>
    <div>
      <h1>Visor de Estado PAD</h1>
      <div class="meta">Actualiza automáticamente</div>
    </div>
    <div class="controls">
      <label class="switch"><input id="autoScroll" type="checkbox" /> Auto-scroll (últimas 7)</label>
      <button class="btn" id="btnRefresh">Forzar actualización</button>
      <button class="btn secondary" id="btnPause">Pausar</button>
      <button class="btn secondary" id="btnFull">Pantalla completa</button>
      <button class="btn secondary" id="btnSettings">Ajustes</button>
    </div>
  </header>

  <main>
    <div class="board">
      <div class="bar">
        <div class="stockwrap">
          <div class="stocklabel">STOCK ACTUAL:</div>
          <div id="stockBar" class="stockbar"></div>
        </div>
        <div class="indicators">
          <div class="ind" id="fractureBox">
            <div id="fractureTotal">Total fracturas: 0</div>
            <div id="remainingStages" class="subind">Etapas restantes: 0</div>
          </div>
          <div id="datesReel" class="reel" aria-label="Fracturas por fecha (reel)"></div>
        </div>
      </div>

      <div class="table-container" id="tableContainer">
        <table id="mainTable">
          <thead>
            <tr id="hdrTop"><th class="rowid">#</th></tr>
            <tr id="hdrSub"><th class="rowid">&nbsp;</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <footer>
        <div id="footerLeft">
          <span>Última actualización: <strong id="lastUpdate">-</strong></span>
          <span id="delta" class="delta"></span>
          <span id="netStatus" class="pill status">Conectando…</span>
        </div>
        <div class="meta">Actualiza cada <span id="refreshSec">15</span>s</div>
      </footer>
    </div>
  </main>
</div>

<!-- ===== Modal Ajustes ===== -->
<div id="settingsModal" class="modal" aria-modal="true" role="dialog" aria-label="Ajustes">
  <div class="modal-card">
    <div class="modal-head">
      <strong>Ajustes rápidos</strong>
    </div>

    <div class="modal-body">
      <section class="grid">
        <label>Tamaño “POZO #n”
          <input type="number" id="setPozoFont" min="12" max="40" step="1">
        </label>
        <label>Tamaño “STOCK”
          <input type="number" id="setStockFont" min="10" max="30" step="1">
        </label>
        <label>Tamaño datos (TPN/FRACTURADO)
          <input type="number" id="setCellFont" min="12" max="32" step="1">
        </label>
        <label>Minutos inactivo
          <input type="number" id="setSaverIdle" min="1" max="120" step="1">
        </label>
        <label>Protector de pantalla
          <select id="setSaverMode">
            <option value="rotar">Rotar todos</option>
            <option value="logo">Logo flotante</option>
            <option value="blob">Luz ambiental</option>
          </select>
        </label>
        <label>Rotar cada (min)
          <input type="number" id="setRotateEvery" min="1" max="60" step="1">
        </label>
        <div style="grid-column:1/-1;display:flex;gap:8px;align-items:center">
          <button class="btn secondary" id="btnTestSaver">Probar protector</button>
          <span class="pill small" id="saverStatus">—</span>
        </div>
      </section>

      <section class="grid">
        <h4 style="grid-column:1/-1;margin:0">Atenuación nocturna (anti burn-in)</h4>
        <label><input type="checkbox" id="setNightEnabled"> Activar</label>
        <label>Hora inicio <input type="number" id="setNightStart" min="0" max="23"></label>
        <label>Hora fin <input type="number" id="setNightEnd" min="0" max="23"></label>
        <label>Brillo (20–100%) <input type="range" id="setNightDim" min="20" max="100"></label>
      </section>

      <section class="grid">
        <h4 style="grid-column:1/-1;margin:0">Pixel-shift</h4>
        <label><input type="checkbox" id="setShiftEnabled"> Activar</label>
        <label>Intervalo (min) <input type="number" id="setShiftEvery" min="1" max="60"></label>
        <label>Desplazamiento (px) <input type="number" id="setShiftPixels" min="0" max="10"></label>
      </section>

      <section>
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <h4>Reglas de stock <small style="opacity:.65">(umbral bajo/medio y unidad)</small></h4>
          <div>
            <button class="btn secondary" id="btnLoadDetected">Cargar ítems detectados</button>
            <button class="btn secondary" id="btnAddRule">Añadir regla</button>
          </div>
        </div>

        <div class="rules-head">
          <div>Ítem</div><div>Unidad</div><div>Bajo</div><div>Medio</div><div></div>
        </div>
        <div id="rulesBody"></div>
      </section>
    </div>

    <div class="modal-actions">
      <button class="btn secondary" id="btnCloseSettings">Cerrar</button>
      <button class="btn secondary" id="btnReset">Restablecer</button>
      <button class="btn" id="btnSaveSettings">Guardar</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ===== Constantes base ===== */
  const JSON_URL = 'status.json';
  const REFRESH_SECONDS = 15;
  const ROWS = 60, POZOS = 6, LAST_N_TO_SHOW = 8, REEL_SIZE = 2;

  /* ===== Utilidades ===== */
  const prefs = {
    get:(k,def)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? def;}catch{return def;} },
    set:(k,v)=> localStorage.setItem(k,JSON.stringify(v))
  };
  const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));
  const pad2=n=>String(n).padStart(2,'0');

  /* ===== Normalizador de nombres de stock =====
     unifica variantes para matchear reglas aunque cambie el texto del JSON */
  function canonicalizeName(raw){
    let s = (raw??'').toString().toUpperCase();
    s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); // sin acentos
    s = s.replace(/\s*:\s*$/,'');                         // quita ':' al final
    s = s.replace(/ARENA\s*MALLA\s*/g,'ARENA ');          // ARENA MALLA -> ARENA
    s = s.replace(/\s+/g,' ').trim();
    // corregimos algunos alias comunes
    s = s.replace(/^GASOIL$/,'GAS OIL');
    return s;
  }

  /* ===== Reglas de stock (por nombre canónico) ===== */
  let STOCK_RULES = prefs.get('stock:rules', {
    [canonicalizeName('GAS OIL')]:            { display:'GAS OIL',            unit:'M3', low:50,  mid:150 },
    [canonicalizeName('ARENA #100')]:         { display:'ARENA #100',         unit:'Tn', low:100, mid:300 },
    [canonicalizeName('ARENA #30/70')]:       { display:'ARENA #30/70',       unit:'Tn', low:300, mid:800 },
    [canonicalizeName('GEL BOLSONES')]:       { display:'GEL BOLSONES',       unit:'ud', low:10,  mid:25  },
    [canonicalizeName('GEL TOTE')]:           { display:'GEL TOTE',           unit:'ud', low:5,   mid:15  },
  });

  /* ===== Ajustes de pantalla / protector ===== */
  const DISPLAY = prefs.get('display:cfg', {
    pozoFont: 20,
    stockFont: 16,
    cellFont: 16,           // TPN/FRACTURADO (por defecto +2 vs antes)
    saver: {
      mode: 'rotar',        // rotar | logo | blob
      rotateEveryMin: 3,
      idleMinutes: 2
    },
    nightDim: { enabled:true, startHour:1, endHour:6, dimLevel:0.65 }, // 65% brillo (0.65)
    pixelShift: { enabled:true, intervalMin:2, maxOffsetPx:2 }
  });

  /* ===== Estado ===== */
  let paused = prefs.get('ui:paused', false);
  let prevDataMap = {}, latestDataMap = {};
  let isFetching = false;
  let lastActivityTs = Date.now();
  let stockCache = [];               // última lista de stock del JSON
  let rotateTimer=null, saverTO=null, shiftTimer=null, nightTimer=null;

  /* ===== DOM ===== */
  const tbody = document.getElementById('tbody');
  const hdrTop = document.getElementById('hdrTop');
  const hdrSub = document.getElementById('hdrSub');
  const tableContainer = document.getElementById('tableContainer');
  const autoScroll = document.getElementById('autoScroll');
  const lastUpdateEl = document.getElementById('lastUpdate');
  const deltaEl = document.getElementById('delta');
  const net = document.getElementById('netStatus');
  const stockBar = document.getElementById('stockBar');
  const btnRefresh = document.getElementById('btnRefresh');
  const btnPause = document.getElementById('btnPause');
  const btnFull = document.getElementById('btnFull');
  const btnSettings = document.getElementById('btnSettings');
  const fractureTotalEl = document.getElementById('fractureTotal');
  const datesReel = document.getElementById('datesReel');
  const remainingEl = document.getElementById('remainingStages');
  const dimVeil = document.getElementById('dimVeil');
  const saver = document.getElementById('saver');
  const logoImg = document.getElementById('logoImg');
  const logoFallback = document.getElementById('logoFallback');
  const saverTicker = document.getElementById('saverTicker');

  /* ===== Modal ===== */
  const modal = document.getElementById('settingsModal');
  const setPozoFont = document.getElementById('setPozoFont');
  const setStockFont= document.getElementById('setStockFont');
  const setCellFont = document.getElementById('setCellFont');
  const setSaverIdle= document.getElementById('setSaverIdle');
  const setSaverMode= document.getElementById('setSaverMode');
  const setRotateEvery=document.getElementById('setRotateEvery');
  const setNightEnabled=document.getElementById('setNightEnabled');
  const setNightStart=document.getElementById('setNightStart');
  const setNightEnd=document.getElementById('setNightEnd');
  const setNightDim=document.getElementById('setNightDim');
  const setShiftEnabled=document.getElementById('setShiftEnabled');
  const setShiftEvery=document.getElementById('setShiftEvery');
  const setShiftPixels=document.getElementById('setShiftPixels');
  const btnSave = document.getElementById('btnSaveSettings');
  const btnClose= document.getElementById('btnCloseSettings');
  const btnReset= document.getElementById('btnReset');
  const btnLoadDetected=document.getElementById('btnLoadDetected');
  const btnAddRule=document.getElementById('btnAddRule');
  const rulesBody=document.getElementById('rulesBody');
  const btnTestSaver=document.getElementById('btnTestSaver');
  const saverStatus=document.getElementById('saverStatus');

  /* ===== Accesos y atajos ===== */
  autoScroll.checked = prefs.get('ui:autoScroll', true);
  btnPause.innerText = paused ? 'Reanudar' : 'Pausar';
  document.getElementById('refreshSec').innerText = REFRESH_SECONDS;

  btnRefresh.onclick = () => forceRefresh();
  btnPause.onclick = () => { paused=!paused; prefs.set('ui:paused',paused); btnPause.innerText=paused?'Reanudar':'Pausar'; };
  autoScroll.onchange = () => { prefs.set('ui:autoScroll',autoScroll.checked); if(autoScroll.checked) requestAnimationFrame(()=>scrollToLastWithData(LAST_N_TO_SHOW)); };
  btnFull.onclick = () => { !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen(); };
  btnSettings.onclick = openSettings;
  btnClose.onclick = () => modal.style.display='none';
  btnReset.onclick = () => { localStorage.removeItem('stock:rules'); localStorage.removeItem('display:cfg'); location.reload(); };
  btnSave.onclick = saveSettings;
  btnLoadDetected.onclick = mergeDetectedItems;
  btnAddRule.onclick = () => addRuleRow({display:'',unit:'',low:'',mid:''});
  btnTestSaver.onclick = () => { showSaver(true); setTimeout(hideSaver, 10000); };

  window.addEventListener('keydown',e=>{
    const k=e.key.toLowerCase();
    if(k==='r') forceRefresh();
    if(k==='p'){ btnPause.click(); }
    if(e.key==='Escape'){ modal.style.display='none'; hideSaver(); }
    if(e.key==='ArrowLeft') datesReel.querySelector('.reel-btn:not(:disabled)')?.click();
    if(e.key==='ArrowRight') datesReel.querySelectorAll('.reel-btn')?.[1]?.click();
    markActivity();
  });
  ['mousemove','touchstart','click','wheel','keydown'].forEach(ev=>window.addEventListener(ev,markActivity));

  function markActivity(){ lastActivityTs = Date.now(); hideSaver(); scheduleSaver(); }

  /* ===== Construcción tabla ===== */
  function initializeDOM(){
    for(let i=1;i<=POZOS;i++){
      const thTop=document.createElement('th'); thTop.className=`pozo-${i} pozoTop`; thTop.colSpan=3; thTop.innerText=`POZO #${i}`; hdrTop.appendChild(thTop);
      const thSeq=document.createElement('th'); thSeq.className='seq'; thSeq.innerText='SEQ'; hdrSub.appendChild(thSeq);
      const th1=document.createElement('th'); th1.innerText='TPN'; hdrSub.appendChild(th1);
      const th2=document.createElement('th'); th2.innerText='FRACTURADO'; hdrSub.appendChild(th2);
    }
    const frag=document.createDocumentFragment();
    for(let i=1;i<=ROWS;i++){
      const id='#'+String(i).padStart(2,'0');
      const tr=document.createElement('tr'); tr.dataset.rowId=id;
      if(i%2===0) tr.classList.add('alt');
      const tdId=document.createElement('td'); tdId.className='rowid'; tdId.innerText=id; tr.appendChild(tdId);
      for(let p=1;p<=POZOS;p++){
        const tdSeq=document.createElement('td'); tdSeq.dataset.col=`Seq${p}`; tdSeq.className='seq'; tr.appendChild(tdSeq);
        const td1=document.createElement('td'); td1.dataset.col=`Pozo${p}`; tr.appendChild(td1);
        const td2=document.createElement('td'); td2.dataset.col=`Estado${p}`; tr.appendChild(td2);
      }
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);

    // aplicar tamaños iniciales
    applyFontVars();
  }

  function applyFontVars(){
    document.documentElement.style.setProperty('--pozo-font-size', DISPLAY.pozoFont+'px');
    document.documentElement.style.setProperty('--stock-font-size', DISPLAY.stockFont+'px');
    document.documentElement.style.setProperty('--cell-font-size',  DISPLAY.cellFont+'px');
  }

  /* ========= Adaptadores JSON / fechas ========= */
  function transformItems(items){
    if(!Array.isArray(items)) return [];
    return items.map(raw=>{
      const out={}; out.fila=(raw.Fila??raw.fila??'').toString();
      for(let i=1;i<=POZOS;i++){
        out['Seq'+i]=(raw['SecuenciaPozo'+i]??'').toString();
        out['Pozo'+i]=(raw['TPNPozo'+i]??'').toString();
        out['Estado'+i]=(raw['FechaFracPozo'+i]??'').toString();
      } return out;
    });
  }
  const excelSerialToYMD=num=>{const base=Date.UTC(1899,11,30);const ms=base+Math.round(num)*86400000;const d=new Date(ms);return{y:d.getUTCFullYear(),m:d.getUTCMonth()+1,d:d.getUTCDate()}};
  function parseDateValue(val){
    const s=(val??'').toString().trim(); if(!s) return null;
    let m=s.match(/^(\d{4})-(\d{2})-(\d{2})/); if(m){const y=+m[1],mo=+m[2],d=+m[3]; return {display:`${d}/${mo}/${y}`, normalized:`${y}-${pad2(mo)}-${pad2(d)}`};}
    m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); if(m){const d=+m[1],mo=+m[2],y=+m[3]; return {display:`${d}/${mo}/${y}`, normalized:`${y}-${pad2(mo)}-${pad2(d)}`};}
    if(/^-?\d+(\.\d+)?$/.test(s)){const n=Number(s.replace(',','.')); if(Number.isFinite(n)&&n>=30000&&n<=70000){const {y,m:mo,d}=excelSerialToYMD(n); return {display:`${d}/${mo}/${y}`, normalized:`${y}-${pad2(mo)}-${pad2(d)}`};}}
    return null;
  }
  const maybeFormatDate=val=>{const p=parseDateValue(val); return p?p.display:(val??'');}
  const isStop=val=>String(val??'').trim().toUpperCase()==='STOP';
  const isFechaValida=val=>parseDateValue(val)!==null;

  function extractHeaderRows(converted){ const headers=converted.filter(it=>(it.fila||'').trim()===''); return {top:headers[0]||null, sub:headers[1]||null}; }
  function itemsArrayToMap(converted){ const m={}; for(const it of converted){const k=(it.fila||'').toString().trim(); if(!k) continue; m[k]=it;} return m; }

  /* ========= Encabezados/tabla ========= */
  function updateHeaderNames(topRow, subRow){
    if(!topRow && !subRow) return;
    const names=[];
    for(let i=1;i<=POZOS;i++){
      const pTop=topRow?.['Pozo'+i]?.trim()||'', eTop=topRow?.['Estado'+i]?.trim()||'';
      const pSub=subRow?.['Pozo'+i]?.trim()||'', eSub=subRow?.['Estado'+i]?.trim()||'';
      let topLabel=pTop||pSub||`POZO #${i}`; let suffix=eTop||''; if(!suffix && eSub && !/^TPN$/i.test(eSub)) suffix=eSub;
      names.push((topLabel+(suffix?(' '+suffix):'' )).trim());
    }
    hdrTop.querySelectorAll('th.pozoTop').forEach((th,i)=> th.innerText = names[i]||`POZO #${i+1}`);
    const sub=hdrSub.querySelectorAll('th');
    for(let i=1;i<=POZOS;i++){
      const pSub=subRow?.['Pozo'+i]?.trim()||'TPN';
      const eSub=subRow?.['Estado'+i]?.trim()||'FRACTURADO';
      const base=(i-1)*3+1;
      if(sub[base]) sub[base].innerText='SEQ';
      if(sub[base+1]) sub[base+1].innerText=pSub||'TPN';
      if(sub[base+2]) sub[base+2].innerText=eSub||'FRACTURADO';
    }
  }

  function hasVisibleData(obj){
    if(!obj) return false;
    for(let i=1;i<=POZOS;i++){
      const tpn=String(obj['Pozo'+i]??'').trim();
      const est=obj['Estado'+i];
      if(tpn!=='' || (est && !isStop(est) && isFechaValida(est))) return true;
    }
    return false;
  }

  function updateRowCells(rowId,newData){
    const tr=tbody.querySelector(`tr[data-row-id="${rowId}"]`); if(!tr) return {changed:false,cells:0};
    let changed=false, cells=0;
    for(let p=1;p<=POZOS;p++){
      const tdSeq=tr.querySelector(`td[data-col="Seq${p}"]`);
      const td1= tr.querySelector(`td[data-col="Pozo${p}"]`);
      const td2= tr.querySelector(`td[data-col="Estado${p}"]`);
      const vSeq=(newData?.['Seq'+p])?String(newData['Seq'+p]):'';
      const v1  =(newData?.['Pozo'+p])?String(newData['Pozo'+p]):'';
      const v2raw=(newData?.['Estado'+p])??''; const v2=maybeFormatDate(v2raw);
      if(tdSeq && tdSeq.innerText!==vSeq){tdSeq.innerText=vSeq; changed=true; cells++;}
      if(td1  && td1.innerText!==v1 ){td1.innerText=v1; changed=true; cells++;}
      if(td2  && td2.innerText!==v2 ){td2.innerText=v2; changed=true; cells++;}
      if(td2){ td2.classList.toggle('stop', isStop(v2raw)||isStop(v2)); }
    }
    return {changed,cells};
  }

  function updateDOM(dataMap){
    const changedRows=[]; let changedCellsTotal=0;
    for(let i=1;i<=ROWS;i++){
      const id='#'+String(i).padStart(2,'0'); const obj=dataMap[id]||{}; const s=JSON.stringify(obj); const prev=prevDataMap[id];
      if(prev===undefined){ prevDataMap[id]=s; latestDataMap[id]=obj; const {cells}=updateRowCells(id,obj); changedCellsTotal+=cells; continue; }
      if(prev!==s){ const {changed,cells}=updateRowCells(id,obj); if(changed) changedRows.push(id); changedCellsTotal+=cells; prevDataMap[id]=s; latestDataMap[id]=obj; }
      else { latestDataMap[id]=obj; }
    }
    return {changedRows,changedCellsTotal};
  }

  /* ========= Stats de fracturas ========= */
  let datesArr=[], reelStart=prefs.get('reel:start',0), userMovedReel=prefs.get('reel:moved',false);

  function computeFractureStats(converted){
    const freq=new Map(); let total=0;
    for(const it of converted){
      if(!it.fila?.trim()) continue;
      for(let i=1;i<=POZOS;i++){
        const p=parseDateValue(it['Estado'+i]);
        if(p){ total++; const cur=freq.get(p.normalized); cur?cur.count++:freq.set(p.normalized,{display:p.display,count:1,normalized:p.normalized}); }
      }
    }
    return {total,freq};
  }
  const renderFractureTotal = t => fractureTotalEl.textContent=`Total fracturas: ${t}`;

  function updateDatesArray(freq){
    datesArr=Array.from(freq.values()).sort((a,b)=>a.normalized.localeCompare(b.normalized));
    const maxStart=Math.max(0,datesArr.length-REEL_SIZE);
    reelStart = userMovedReel ? Math.min(reelStart,maxStart) : maxStart;
    prefs.set('reel:start',reelStart); renderDatesReel();
  }

  function renderDatesReel(){
    datesReel.innerHTML='';
    if(!datesArr.length){ const d=document.createElement('div'); d.className='pill'; d.textContent='Sin fechas'; datesReel.appendChild(d); return; }
    const maxStart=Math.max(0,datesArr.length-REEL_SIZE);
    const btnPrev=document.createElement('button'); btnPrev.className='reel-btn'; btnPrev.textContent='‹'; btnPrev.disabled=(reelStart===0);
    btnPrev.onclick=()=>{reelStart=Math.max(0,reelStart-REEL_SIZE); userMovedReel=true; prefs.set('reel:moved',true); prefs.set('reel:start',reelStart); renderDatesReel(); };
    datesReel.appendChild(btnPrev);
    for(let k=0;k<REEL_SIZE;k++){ const idx=reelStart+k; if(idx>=datesArr.length) break; const d=datesArr[idx];
      const chip=document.createElement('div'); chip.className='date-chip'+(idx===datesArr.length-1?' latest':''); 
      const dd=document.createElement('div'); dd.className='date'; dd.textContent=d.display;
      const nn=document.createElement('div'); nn.className='num'; nn.textContent=d.count; chip.append(dd,nn); datesReel.appendChild(chip);
    }
    const btnNext=document.createElement('button'); btnNext.className='reel-btn'; btnNext.textContent='›'; btnNext.disabled=(reelStart>=maxStart);
    btnNext.onclick=()=>{reelStart=Math.min(maxStart,reelStart+REEL_SIZE); userMovedReel=true; prefs.set('reel:moved',true); prefs.set('reel:start',reelStart); renderDatesReel(); };
    datesReel.appendChild(btnNext);
  }

  /* ========= Etapas restantes ========= */
  function computeRemainingStages(converted){
    const rows=converted.filter(it=>it.fila?.trim()).map(it=>{
      const m=it.fila.trim().match(/^#?(\d+)/); return {...it,_row:m?parseInt(m[1],10):NaN};
    }).filter(it=>Number.isFinite(it._row)).sort((a,b)=>a._row-b._row);
    let total=0;
    for(let p=1;p<=POZOS;p++){
      let stopRow=null;
      for(const r of rows){ const v=(r['Estado'+p]||'').toString().trim().toUpperCase(); if(v==='STOP'){stopRow=r._row; break;} }
      if(!stopRow) continue;
      for(const r of rows){ if(r._row>=stopRow) break; if((r['Estado'+p]||'').toString().trim()==='') total++; }
    }
    return total;
  }
  const renderRemaining = n => remainingEl.textContent=`Etapas restantes: ${n}`;

  /* ========= Stock / semáforo ========= */
  function stockLevelClass(canonName, numericValue){
    const rule = STOCK_RULES[canonName];
    if(!rule || !Number.isFinite(numericValue)) return 'stock-mid';
    if(numericValue < rule.low) return 'stock-low';
    if(numericValue <= rule.mid) return 'stock-mid';
    return 'stock-high';
  }
  function numFromString(s){ if(!s) return NaN; const m=s.toString().replace(',', '.').match(/-?\d+(\.\d+)?/); return m?parseFloat(m[0]):NaN; }
  const themeMap=new Map();
  function renderStock(arr=[]){
    stockCache = Array.isArray(arr) ? arr : [];
    stockBar.innerHTML='';
    let idx=0;
    for(const it of stockCache){
      const rawName=(it.ITEM??'').toString();
      const canon=canonicalizeName(rawName);
      if(!themeMap.has(canon)) themeMap.set(canon, (idx++)%8);
      const theme=`stock-theme-${themeMap.get(canon)}`;
      const valStr=(it.STOCK??'').toString();
      const val=numFromString(valStr);
      const cls=stockLevelClass(canon,val);

      const div=document.createElement('div'); div.className=`pill ${theme} ${cls}`;
      const dot=document.createElement('span'); dot.className='dot';
      const txt=document.createElement('span'); txt.textContent = `${rawName}: ${valStr}`;
      div.append(dot,txt); stockBar.appendChild(div);
    }
  }

  /* ========= Badges por pozo ========= */
  function remainingPerPozo(converted){
    const rows=converted.filter(it=>it.fila?.trim()).map(it=>{
      const m=it.fila.trim().match(/^#?(\d+)/); return {...it,_row:m?parseInt(m[1],10):NaN};
    }).filter(it=>Number.isFinite(it._row)).sort((a,b)=>a._row-b._row);
    const res=Array(POZOS).fill(0);
    for(let p=1;p<=POZOS;p++){
      let stopRow=null;
      for(const r of rows){ const v=(r['Estado'+p]||'').toString().trim().toUpperCase(); if(v==='STOP'){stopRow=r._row; break;} }
      if(!stopRow) continue;
      for(const r of rows){ if(r._row>=stopRow) break; if((r['Estado'+p]||'').toString().trim()==='') res[p-1]++; }
    }
    return res;
  }
  function paintBadgesPerPozo(arr){
    document.querySelectorAll('#hdrTop th.pozoTop').forEach((th,i)=>{
      th.querySelectorAll('.badge').forEach(b=>b.remove());
      const val=arr[i]??0; if(val>0){ const b=document.createElement('span'); b.className='badge'; b.textContent=val; th.appendChild(b); }
    });
  }

  /* ========= Saver / dimmer / pixel-shift ========= */
  function inRangeHour(h,start,end){ return (start<=end)?(h>=start && h<end):(h>=start || h<end); }
  function applyNightDim(){
    if(!DISPLAY.nightDim.enabled){ dimVeil.style.opacity=0; return; }
    const h=new Date().getHours();
    const active=inRangeHour(h, DISPLAY.nightDim.startHour, DISPLAY.nightDim.endHour);
    dimVeil.style.opacity = active ? String(1 - clamp(DISPLAY.nightDim.dimLevel,0.2,1)) : '0';
  }
  function restartNight(){ clearInterval(nightTimer); applyNightDim(); nightTimer=setInterval(applyNightDim, 5*60*1000); }

  function restartShift(){
    clearInterval(shiftTimer);
    document.documentElement.style.setProperty('--nudge-x','0px');
    document.documentElement.style.setProperty('--nudge-y','0px');
    if(!DISPLAY.pixelShift.enabled) return;
    const ms=Math.max(1,DISPLAY.pixelShift.intervalMin)*60*1000;
    shiftTimer=setInterval(()=>{
      const m=Math.max(0,DISPLAY.pixelShift.maxOffsetPx|0);
      const x=(Math.floor(Math.random()*(m*2+1))-m);
      const y=(Math.floor(Math.random()*(m*2+1))-m);
      document.documentElement.style.setProperty('--nudge-x',x+'px');
      document.documentElement.style.setProperty('--nudge-y',y+'px');
    },ms);
  }

  function buildSaverFrame(){
    // fondo “blob”
    const x=30+Math.random()*40, y=25+Math.random()*40;
    saver.style.setProperty('--blob-x',x+'%'); saver.style.setProperty('--blob-y',y+'%');
    // ticker simple con reloj
    saverTicker.textContent = new Date().toLocaleString();
    // fallback de logo
    if(!logoImg || logoImg.naturalWidth===0){ logoFallback.style.display='block'; } else { logoFallback.style.display='none'; }
  }
  function showSaver(force=false){
    const idleMs = DISPLAY.saver.idleMinutes*60*1000;
    if(!force && (Date.now()-lastActivityTs)<idleMs) return;
    buildSaverFrame();
    saver.style.display='block';
    saverStatus.textContent='Mostrando';
    // rotación de modo simple (blob/logo) si está en “rotar”
    clearInterval(rotateTimer);
    if(DISPLAY.saver.mode==='rotar'){
      let m=0; const modes=['logo','blob'];
      rotateTimer = setInterval(()=>{ m=(m+1)%modes.length; switchSaverMode(modes[m]); }, Math.max(1,DISPLAY.saver.rotateEveryMin)*60*1000);
    }
  }
  function hideSaver(){ saver.style.display='none'; saverStatus.textContent='—'; clearInterval(rotateTimer); }
  function switchSaverMode(mode){
    // ahora usamos solo fondo “blob” + logo flotante; el “modo” controla visibilidad del logo
    if(mode==='logo'){ if(logoImg) logoImg.style.display=''; else logoFallback.style.display='block'; }
    if(mode==='blob'){ if(logoImg) logoImg.style.display='none'; logoFallback.style.display='none'; }
  }
  function scheduleSaver(){
    clearTimeout(saverTO);
    const idleMs = Math.max(1,DISPLAY.saver.idleMinutes)*60*1000;
    const wait = Math.max(0, idleMs - (Date.now()-lastActivityTs));
    saverTO = setTimeout(()=> showSaver(false), wait + 50);
  }

  /* ========= Carga de datos ========= */
  async function forceRefresh(){ if(isFetching) return; btnRefresh.disabled=true; const t=btnRefresh.textContent; btnRefresh.textContent='Actualizando...'; await loadAndRender(true); btnRefresh.textContent=t; btnRefresh.disabled=false; }

  async function loadAndRender(isForced=false){
    if(paused && !isForced) return; if(isFetching) return; isFetching=true;
    try{
      const t0=performance.now(); const res=await fetch(`${JSON_URL}?_=${Date.now()}`,{cache:'no-store'}); const t1=performance.now();
      if(!res.ok) throw new Error('HTTP '+res.status);
      net.textContent=`OK ${Math.round(t1-t0)}ms`; net.style.background='rgba(0,180,60,.2)'; net.style.borderColor='rgba(0,180,60,.35)';

      const json=await res.json();
      lastUpdateEl.innerText = (json.lastUpdate?new Date(json.lastUpdate):new Date()).toLocaleString();

      renderStock(json.stock||[]);
      const converted=transformItems(json.items||[]);
      const {top,sub}=extractHeaderRows(converted); updateHeaderNames(top,sub);
      const dataMap=itemsArrayToMap(converted);

      const {changedRows,changedCellsTotal}=updateDOM(dataMap);
      deltaEl.textContent = changedCellsTotal>0 ? `• ${changedCellsTotal} cambio(s)` : '';

      const stats=computeFractureStats(converted); renderFractureTotal(stats.total); updateDatesArray(stats.freq);
      const remaining=computeRemainingStages(converted); renderRemaining(remaining);
      const perPozo=remainingPerPozo(converted); paintBadgesPerPozo(perPozo);

      if(changedCellsTotal>0){ lastActivityTs=Date.now(); scheduleSaver(); } // actividad real
      if(autoScroll.checked){ requestAnimationFrame(()=>scrollToLastWithData(LAST_N_TO_SHOW)); }
    }catch(err){
      console.error(err); lastUpdateEl.innerHTML='<span style="color:salmon">Error de conexión</span>';
      deltaEl.textContent=''; net.textContent='ERROR'; net.style.background='rgba(220,60,60,.25)'; net.style.borderColor='rgba(220,60,60,.4)';
    }finally{ isFetching=false; }
  }

  function scrollToLastWithData(n=LAST_N_TO_SHOW){
    if(!autoScroll.checked) return;
    const rows=[...tbody.querySelectorAll('tr')]; const idx=[];
    rows.forEach((tr,i)=>{ const id=tr.dataset.rowId; if(hasVisibleData(latestDataMap[id])) idx.push(i); });
    if(!idx.length) return;
    const startIdx=idx[Math.max(0,idx.length-n)]; const startRow=rows[startIdx]; if(!startRow) return;
    const headerH = hdrTop.offsetHeight + hdrSub.offsetHeight;
    tableContainer.scrollTo({ top: Math.max(0, startRow.offsetTop - headerH - 8), behavior:'smooth' });
  }

  /* ========= Modal: cargar / guardar ========= */
  function openSettings(){
    setPozoFont.value = DISPLAY.pozoFont;
    setStockFont.value= DISPLAY.stockFont;
    setCellFont.value = DISPLAY.cellFont;
    setSaverIdle.value= DISPLAY.saver.idleMinutes;
    setSaverMode.value= DISPLAY.saver.mode;
    setRotateEvery.value= DISPLAY.saver.rotateEveryMin;

    setNightEnabled.checked = !!DISPLAY.nightDim.enabled;
    setNightStart.value = DISPLAY.nightDim.startHour;
    setNightEnd.value   = DISPLAY.nightDim.endHour;
    setNightDim.value   = Math.round((DISPLAY.nightDim.dimLevel||0.65)*100);

    setShiftEnabled.checked = !!DISPLAY.pixelShift.enabled;
    setShiftEvery.value  = DISPLAY.pixelShift.intervalMin;
    setShiftPixels.value = DISPLAY.pixelShift.maxOffsetPx;

    drawRulesTable();
    modal.style.display='flex';
  }

  function saveSettings(){
    DISPLAY.pozoFont = clamp(+setPozoFont.value||20,12,40);
    DISPLAY.stockFont= clamp(+setStockFont.value||16,10,30);
    DISPLAY.cellFont = clamp(+setCellFont.value||16,12,32);
    DISPLAY.saver.idleMinutes = clamp(+setSaverIdle.value||2,1,120);
    DISPLAY.saver.mode  = setSaverMode.value;
    DISPLAY.saver.rotateEveryMin = clamp(+setRotateEvery.value||3,1,60);

    DISPLAY.nightDim.enabled = setNightEnabled.checked;
    DISPLAY.nightDim.startHour = clamp(+setNightStart.value||1,0,23);
    DISPLAY.nightDim.endHour   = clamp(+setNightEnd.value||6,0,23);
    DISPLAY.nightDim.dimLevel  = clamp((+setNightDim.value||65)/100,0.2,1);

    DISPLAY.pixelShift.enabled = setShiftEnabled.checked;
    DISPLAY.pixelShift.intervalMin = clamp(+setShiftEvery.value||2,1,60);
    DISPLAY.pixelShift.maxOffsetPx = clamp(+setShiftPixels.value||2,0,10);

    // Reglas desde los inputs
    const rows=[...rulesBody.querySelectorAll('.rule-row')];
    const next={};
    for(const r of rows){
      const name=r.querySelector('[data-f=name]').value;
      const unit=r.querySelector('[data-f=unit]').value;
      const low =+r.querySelector('[data-f=low]').value;
      const mid =+r.querySelector('[data-f=mid]').value;
      if(!name) continue;
      const canon=canonicalizeName(name);
      next[canon] = { display:name.trim(), unit:(unit||'').trim(), low:Number.isFinite(low)?low:0, mid:Number.isFinite(mid)?mid:0 };
    }
    STOCK_RULES = next;

    prefs.set('display:cfg', DISPLAY);
    prefs.set('stock:rules', STOCK_RULES);

    applyFontVars();
    restartNight();
    restartShift();
    scheduleSaver();

    modal.style.display='none';
    // re-render stock con nuevas reglas
    renderStock(stockCache);
  }

  function drawRulesTable(){
    rulesBody.innerHTML='';
    for(const [canon,rule] of Object.entries(STOCK_RULES)){
      addRuleRow(rule, canon);
    }
  }
  function addRuleRow(rule={}, canonKey=null){
    const row=document.createElement('div'); row.className='rule-row';
    row.innerHTML=`
      <input data-f="name"  value="${rule.display??''}" placeholder="Nombre visible">
      <input data-f="unit"  value="${rule.unit??''}"   placeholder="ud/Tn/M3">
      <input data-f="low"   value="${rule.low??''}"    type="number" step="any">
      <input data-f="mid"   value="${rule.mid??''}"    type="number" step="any">
      <button class="btn secondary" type="button">Quitar</button>
    `;
    row.querySelector('button').onclick=()=>row.remove();
    if(canonKey) row.dataset.key=canonKey;
    rulesBody.appendChild(row);
  }

  function mergeDetectedItems(){
    // deduce ítems del último stock cargado; agrega los que no existan (por nombre canónico)
    const detected = new Map(Object.entries(STOCK_RULES)); // copia actual
    for(const it of stockCache){
      const canon = canonicalizeName(it.ITEM);
      if(!detected.has(canon)){
        detected.set(canon, { display: (it.ITEM||'').toString(), unit: '', low: 0, mid: 0 });
      }
    }
    // vuelca al UI (sin duplicar filas)
    STOCK_RULES = Object.fromEntries(detected.entries());
    drawRulesTable();
  }

  /* ===== Init ===== */
  function applyDisplayToDOM(){
    applyFontVars();
    restartNight(); restartShift(); scheduleSaver();
  }

  initializeDOM();
  applyDisplayToDOM();
  loadAndRender(true);
  setInterval(()=>loadAndRender(false), REFRESH_SECONDS*1000);

  // si no hay logo, mostramos fallback
  if(!logoImg || !logoImg.complete || logoImg.naturalWidth===0){ logoFallback.style.display='block'; }
});
</script>
</body>
</html>

