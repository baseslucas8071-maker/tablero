<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Visor móvil de etapas</title>
  <style>
    :root{
      --bg:#000; --card:#0b0b0b; --muted:#cfe8ff; --ok:#1ad598; --warn:#ffc857; --bad:#ff6b6b; --ink:#e8f0ff;
      --accent:#47a3ff; --soft:#111; --ring:#2d2d2d; --shadow: 0 6px 20px rgba(0,0,0,.55);
    }
    html,body{height:100%; margin:0; background:#000; color:var(--ink); font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;}
    .wrap{min-height:100%; display:flex; flex-direction:column;}
    header{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, #000, rgba(0,0,0,.85)); border-bottom:1px solid #1a1a1a;}
    .bar{display:flex; align-items:center; gap:10px; padding:12px 14px}
    .title{font-size:18px; font-weight:700; letter-spacing:.2px}
    .sub{font-size:12px; opacity:.8}
    .grow{flex:1}
    button, .chip{appearance:none; border:1px solid var(--ring); background:var(--soft); color:var(--ink); border-radius:12px; padding:8px 12px; font:inherit; font-weight:600}
    button:active{transform:scale(.98)}
    .chip{border-radius:999px; font-size:12px; padding:6px 10px;}
    .toolbar{display:flex; gap:8px}

    .tabs{display:flex; gap:8px; padding:8px 14px; border-bottom:1px solid #1a1a1a}
    .tab{flex:1; text-align:center; padding:10px 0; border-radius:12px; background:var(--soft); border:1px solid var(--ring); cursor:pointer; font-weight:700;}
    .tab.active{background:#121212; border-color:#2b466f; color:#dff0ff}

    main{padding:14px; display:grid; gap:12px}
    .card{background:var(--card); border:1px solid #161616; border-radius:16px; box-shadow:var(--shadow)}
    .card.pad{padding:14px}

    .kpis{display:grid; grid-template-columns:repeat(3, 1fr); gap:10px}
    .kpi{background:#090909; border:1px solid #161616; border-radius:12px; padding:10px}
    .kpi .label{font-size:14px; opacity:.8}
    .kpi .value{font-size:26px; font-weight:800; margin-top:2px}
    .kpi.ok .value{color:var(--ok)}
    .kpi.warn .value{color:var(--warn)}
    .kpi.bad .value{color:var(--bad)}

    .speed{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .speed .box{background:#090909; border:1px solid #161616; border-radius:12px; padding:10px}
    .speed .h{font-size:11px; opacity:.8; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .speed .v{font-size:18px; font-weight:800; margin-top:2px}

    .pozo{display:grid; gap:8px; cursor:pointer}
    .pozo:hover{outline:1px solid #1f3e66}

    .pozo-title{display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-radius:10px; background:#101010}
    .pozo-title .name{font-weight:900; letter-spacing:.3px; font-size:18px}
    .meta{display:flex; gap:8px}
    .badge{font-size:13px; background:#090909; border:1px solid #222; padding:5px 10px; border-radius:999px; font-weight:700}
    .pozo[class*="color-"] .pozo-title .badge{ background:rgba(0,0,0,.28); border-color:rgba(0,0,0,.35); color:#fff }

    .row{display:flex; align-items:center; gap:14px}
    .progress{height:12px; background:#090909; border:1px solid #222; border-radius:999px; overflow:hidden; flex:1}
    .progress > i{display:block; height:100%; background:linear-gradient(90deg, #47a3ff, #60dbfb)}
    .pct{width:58px; text-align:right; font-size:14px; font-weight:800}

    .list{display:grid; gap:10px}
    .item{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:12px; border:1px solid #161616; background:#0a0a0a}
    .item .left{display:flex; flex-direction:column}
    .item .left .h{font-weight:700}
    .item .right{font-weight:800}

    .muted{opacity:.75}
    .tiny{font-size:11px}

    .backbar{display:flex; align-items:center; gap:10px; padding:8px 14px}
    .backbar .t{font-weight:900; font-size:18px}
    .back{border-radius:10px}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .summary{display:grid; gap:8px}
    .kv{display:flex; align-items:center; justify-content:space-between; background:#0a0a0a; border:1px solid #161616; padding:10px 12px; border-radius:12px}
    canvas{width:100%; height:220px; display:block}

    footer.nav{position:sticky; bottom:0; background:linear-gradient(0deg, #000, rgba(0,0,0,.85)); border-top:1px solid #1a1a1a;}
    .nav-inner{display:flex; gap:8px; padding:10px 14px}
    .nav-inner button{flex:1}

    /* Modal Overlay */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:100; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity .2s}
    .overlay.open{opacity:1; pointer-events:all}
    .modal-box{background:#111; border:1px solid #222; width:90%; max-width:400px; border-radius:16px; padding:16px; box-shadow:0 20px 50px rgba(0,0,0,.8); transform:translateY(20px); transition:transform .2s}
    .overlay.open .modal-box{transform:translateY(0)}
    .modal-head{font-weight:800; font-size:18px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center}
    .form-row{display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; padding:10px; background:#080808; border-radius:8px; border:1px solid #1a1a1a}
    .form-row input[type="number"]{width:60px; background:#222; border:1px solid #333; color:#fff; padding:6px; border-radius:6px; font-weight:700; text-align:center}
    .form-row input[type="checkbox"]{transform:scale(1.3)}

    /* Paleta por pozo (1..6) */
    .color-1{ --c-bg:linear-gradient(90deg,#ffd83a,#ffd83a); --c-fg:#001; }
    .color-2{ --c-bg:linear-gradient(90deg,#7ad39a,#5fbf87); --c-fg:#001; }
    .color-3{ --c-bg:linear-gradient(90deg,#74b3ff,#4686ff); --c-fg:#001; }
    .color-4{ --c-bg:linear-gradient(90deg,#ff7b7b,#ff4c4c); --c-fg:#001; }
    .color-5{ --c-bg:linear-gradient(90deg,#ffffff,#f2f6f9); --c-fg:#001; }
    .color-6{ --c-bg:linear-gradient(90deg,#e8c3ff,#d79bf6); --c-fg:#201; }
    .pozo.color-1 .pozo-title,
    .pozo.color-2 .pozo-title,
    .pozo.color-3 .pozo-title,
    .pozo.color-4 .pozo-title,
    .pozo.color-5 .pozo-title,
    .pozo.color-6 .pozo-title{ background:var(--c-bg); color:var(--c-fg); }
    #detailBar[class*="color-"] .t{ background:var(--c-bg); color:var(--c-fg); padding:6px 10px; border-radius:10px; }

    @media (min-width:720px){ main{max-width:720px; margin:0 auto} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="bar">
        <div>
          <div class="title">Visor móvil – Etapas</div>
        </div>
        <div class="grow"></div>
        <div class="toolbar">
          <button id="btnRefresh" title="Actualizar">↻</button>
          <button id="btnCfg" title="Ajustes">⚙️</button>
          <button id="btnInst">?</button>
        </div>
      </div>
      <div class="tabs" id="mainTabs">
        <div class="tab active" data-view="pozos">Por pozo</div>
        <div class="tab" data-view="dias">Por día</div>
      </div>
      <div class="backbar" id="detailBar" style="display:none">
        <button class="back" id="btnBack">← Volver</button>
        <div class="t" id="detailTitle">Pozo</div>
      </div>
    </header>

    <main>
      <section class="card pad" id="topCard">
        <div class="kpis">
          <div class="kpi" id="kpiTotales"><div class="label">Etapas totales</div><div class="value">—</div></div>
          <div class="kpi ok" id="kpiRealizadas"><div class="label">Realizadas</div><div class="value">—</div></div>
          <div class="kpi warn" id="kpiRestantes"><div class="label">Restantes</div><div class="value">—</div></div>
        </div>
        <div class="speed" id="speedRow">
          <div class="box">
            <div class="h">Promedio (Real)</div>
            <div class="v" id="avgPace">—</div>
            <div class="tiny muted" id="avgFoot">—</div>
          </div>
          <div class="box">
            <div class="h">Fin estimado</div>
            <div class="v" id="etaFinish">—</div>
            <div class="tiny muted" id="etaTime">—</div>
          </div>
        </div>
        <div class="tiny muted" id="lastUpdate" style="margin-top:8px">—</div>
      </section>

      <section id="viewPozos" class="pozos"></section>

      <section id="viewDias" class="dias" style="display:none">
        <section class="card pad">
          <canvas id="daysChart" width="700" height="280" aria-label="Etapas por día (total PAD)"></canvas>
        </section>
        <section id="daysListBox" class="card pad"></section>
      </section>

      <section id="viewDetail" style="display:none; gap:12px">
        <section class="card pad">
          <canvas id="pozoChart" width="700" height="280" aria-label="Gráfica por día del pozo"></canvas>
        </section>
        <section class="card pad">
          <div class="grid2">
            <div class="summary">
              <div class="kv"><span>Total</span><strong id="dTot">—</strong></div>
              <div class="kv"><span>Hechas</span><strong id="dDone">—</strong></div>
              <div class="kv"><span>Restantes</span><strong id="dLeft">—</strong></div>
              <div class="kv"><span>Avance</span><strong id="dPct">—</strong></div>
              <div class="kv"><span>Primera</span><strong id="dFirst">—</strong></div>
              <div class="kv"><span>Última</span><strong id="dLast">—</strong></div>
            </div>
            <div>
              <div class="list" id="dList"></div>
            </div>
          </div>
        </section>
      </section>
    </main>

    <footer class="nav">
      <div class="nav-inner">
        <button id="btnShare">Compartir</button>
        <button id="btnHelp">Ayuda</button>
      </div>
    </footer>
  </div>

  <div class="overlay" id="modalSettings">
    <div class="modal-box">
      <div class="modal-head">
        Ajustes
        <button id="btnCloseCfg" class="chip">✕</button>
      </div>
      <div class="form-row">
        <span>Velocidad Fija (Manual)</span>
        <input type="checkbox" id="cfgUseManual">
      </div>
      <div class="form-row">
        <span>Etapas por día</span>
        <input type="number" id="cfgManualVal" min="1" max="100" step="0.1">
      </div>
      <small class="muted" style="display:block; margin-bottom:12px">
        Si se activa, el tiempo restante se calcula usando este valor fijo. El promedio histórico se muestra igual.
      </small>
      <div style="text-align:right">
        <button id="btnSaveCfg" style="background:var(--accent); color:#000; border:none">Guardar</button>
      </div>
    </div>
  </div>

<script>
"use strict";

/* ========= CONFIG ========= */
const CONFIG = {
  DATA_URL: 'status.json',
  MAX_ETAPAS: 62, // Actualizado a 62
  DAY_CUTOFF_HOUR: 0 
};

// Preferencias locales
let PREFS = JSON.parse(localStorage.getItem('mobile_prefs')) || {
  useManual: true,
  manualSpeed: 10
};

/* ========= HELPERS ========= */
const $  = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt = n => new Intl.NumberFormat('es-AR').format(n);

function pad2(n){ return String(n).padStart(2,'0'); }
function fmtDate(d){ return d.toLocaleDateString('es-AR'); }
function fmtTime(d){ return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }

function isStop(v){ return String(v).trim().toUpperCase() === 'STOP'; }
function isAbortCancel(v){
  const s = String(v).trim().toUpperCase();
  return s === 'ABORTADA' || s === 'CANCELADA';
}

function excelSerialToDate(x){
  const n = Number(x);
  if(!isFinite(n)) return null;
  const ms = (n - 25569) * 86400 * 1000;
  const d = new Date(ms);
  return isNaN(d) ? null : d;
}
function isExcelSerial(v){
  const n = Number(String(v).trim());
  return isFinite(n) && n >= 20000 && n <= 80000;
}

function isValidDateCell(v){
  const s = String(v).trim();
  if(!s) return false;
  if(isExcelSerial(s)) return true;
  if(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/.test(s)) return true;
  if(/^(\d{1,2})-(\d{1,2})-(\d{4})$/.test(s)) return true;
  if(/^(\d{4})-(\d{2})-(\d{2})$/.test(s)) return true;
  return false;
}
function parseToYMD(v){
  const s = String(v).trim();
  if(isExcelSerial(s)){
    const d = excelSerialToDate(s);
    if(!d) return null;
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth()+1).padStart(2,'0');
    const dd= String(d.getUTCDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }
  let d,m,y;
  let m1 = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/);
  if(m1){ d=+m1[1]; m=+m1[2]; y=+m1[3]; if(y<100) y+=2000; return `${y.toString().padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
  let m2 = s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
  if(m2){ d=+m2[1]; m=+m2[2]; y=+m2[3]; return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
  let m3 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m3){ return s; }
  return null;
}

/* ========= EXTRACCIÓN ========= */
let gByPozo = null;
let gStats  = null;
let gNames  = null;
let gDaysLabels = [];
let gDaysValues = [];
let gDaysArrDesc = [];

function extractFracturadoColumns(rows){
  const byPozo = {};
  if(!rows || !rows.length){ return byPozo; }
  const keys = Object.keys(rows[0] || {});
  const fechaCols = keys.filter(k => /^FechaFracPozo\d+$/i.test(k));
  if (!fechaCols.length) return byPozo;

  const namesMap = {};
  const nameRow = rows[0] || {};
  for (const fk of fechaCols){
    const n = fk.match(/(\d+)/)[1];
    const val = String(nameRow[fk] ?? "").trim();
    if(val && val.toUpperCase() !== "X"){ namesMap[`pozo-${n}`] = val; }
  }

  const dataRows = rows.map(r => ({...r, _fila:String(r.Fila||'').trim()})).filter(r => /^#?\d+$/i.test(r._fila));

  for (const fk of fechaCols){
    const n = fk.match(/(\d+)/)[1];
    const pk = `pozo-${n}`;
    if(!(pk in namesMap)) continue;
    const seqKey = keys.find(k => new RegExp(`^SecuenciaPozo${n}$`, 'i').test(k));
    byPozo[pk] = dataRows.map(r => ({
      fecha: r[fk] ?? "",
      sec:   seqKey ? (r[seqKey] ?? "") : ""
    }));
  }
  byPozo.__names = namesMap;
  return byPozo;
}

function computeStats(byPozo){
  const stats = {};
  for(const [pozo, serieObjs] of Object.entries(byPozo)){
    if(pozo === "__names") continue;
    const stopIdx = serieObjs.findIndex(o => isStop(o.fecha));
    const totalCells = (stopIdx >= 0) ? stopIdx : Math.min(serieObjs.length, CONFIG.MAX_ETAPAS);
    const considered = serieObjs.slice(0, totalCells);
    const realizadas = considered.filter(o => isValidDateCell(o.fecha) || isAbortCancel(o.fecha)).length;
    const restantes  = Math.max(0, totalCells - realizadas);
    stats[pozo] = { total: totalCells, realizadas, restantes, serie: considered };
  }
  return stats;
}

function aggregateByDay(byPozo){
  const map = new Map();
  for (const [key, serie] of Object.entries(byPozo)){
    if (key === "__names") continue;
    for (const o of serie){
      if (isValidDateCell(o.fecha)){
        const ymd = parseToYMD(o.fecha);
        if (ymd) map.set(ymd, (map.get(ymd)||0) + 1);
      } else if (isStop(o.fecha)){ break; }
    }
  }
  return Array.from(map.entries()).sort((a,b)=> a[0] < b[0] ? 1 : -1);
}

function computeAvgSinceStartCap7(daysArrDesc){
  const map = new Map(daysArrDesc);
  const allDaysAsc = Array.from(map.keys()).sort();
  if (allDaysAsc.length === 0) return { avg:0, usedDays:0 };

  const startYMD = allDaysAsc[0];
  const tz = 'America/Argentina/Buenos_Aires';
  const now = new Date();
  const tzNow = new Date(now.toLocaleString('en-US', { timeZone: tz }));
  const yesterday = new Date(tzNow.getFullYear(), tzNow.getMonth(), tzNow.getDate()-1);
  const endYMD = `${yesterday.getFullYear()}-${String(yesterday.getMonth()+1).padStart(2,'0')}-${String(yesterday.getDate()).padStart(2,'0')}`;

  if (startYMD > endYMD) return { avg:0, usedDays:0 };

  const s = new Date(startYMD+'T00:00:00');
  const e = new Date(endYMD+'T00:00:00');
  const daysBetween = Math.floor((e - s) / 86400000) + 1;

  let winStart = new Date(s);
  let winLen   = daysBetween;
  if (daysBetween > 7){
    winStart = new Date(e); winStart.setDate(e.getDate() - 6);
    winLen = 7;
  }

  const values = [];
  for (let i=0;i<winLen;i++){
    const d = new Date(winStart); d.setDate(winStart.getDate()+i);
    const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    values.push(map.get(ymd) || 0);
  }
  const sum = values.reduce((a,b)=>a+b,0);
  const avg = sum / (values.length || 1);
  return { avg, usedDays: values.length };
}

function hoursLeftUntilCutoff(now = new Date(), corteHora = 0) {
  const end = new Date(now);
  if (corteHora === 0) { end.setHours(23,59,59,999); } 
  else {
    if (now.getHours() < corteHora || (now.getHours() === corteHora && now.getMinutes() === 0)) { end.setHours(corteHora,0,0,0); } 
    else { end.setDate(end.getDate() + 1); end.setHours(corteHora,0,0,0); }
  }
  return (end - now) / 36e5;
}

function estimateFinishWithTime(remaining, avgPerDay, now = new Date(), corteHora = 0) {
  if (!isFinite(remaining) || remaining <= 0) {
    return { approx:"", dateLabel: fmtDate(now), timeLabel: fmtTime(now), target: now };
  }
  if (!isFinite(avgPerDay) || avgPerDay <= 0) {
    return { approx:"—", dateLabel:"", timeLabel:"", target:null };
  }
  const hoursNeeded = (remaining / avgPerDay) * 24;
  const hoursLeftToday = hoursLeftUntilCutoff(now, corteHora);
  let approx, daysNeeded;
  if (hoursNeeded <= hoursLeftToday) {
    approx = "≈ hoy"; daysNeeded = 0;
  } else {
    daysNeeded = Math.ceil(hoursNeeded / 24);
    approx = `≈ ${daysNeeded} día${daysNeeded > 1 ? "s" : ""}`;
  }
  const target = new Date(now.getTime() + hoursNeeded * 3600 * 1000);
  const roundTo = 5; 
  const m = target.getMinutes();
  const rounded = new Date(target);
  rounded.setMinutes(Math.round(m / roundTo) * roundTo, 0, 0);
  return { approx, dateLabel: fmtDate(target), timeLabel: fmtTime(rounded), target: rounded };
}

/* ========= RENDER & LOGIC ========= */
function renderKPIs(stats){
  const all = Object.values(stats);
  const totales = all.reduce((a,b)=>a+b.total,0);
  const hechas  = all.reduce((a,b)=>a+b.realizadas,0);
  const rest    = all.reduce((a,b)=>a+b.restantes,0);
  $('#kpiTotales .value').textContent = fmt(totales);
  $('#kpiRealizadas .value').textContent= fmt(hechas);
  $('#kpiRestantes .value').textContent = fmt(rest);
  return {totales, hechas, rest};
}

function renderSpeed(avgReal, etaObj, usedDays, isManual, manualVal){
  // Promedio (Siempre Real)
  $('#avgPace').textContent = (avgReal && avgReal>0) ? `${avgReal.toFixed(1)} etapas/día` : '—';
  $('#avgFoot').textContent = `Ventana usada: ${usedDays} día(s).`;

  // ETA (Puede ser Manual)
  if (etaObj && etaObj.target){
    $('#etaFinish').innerHTML = `${etaObj.dateLabel} <span class="muted">(${etaObj.approx})</span>`;
    $('#etaTime').textContent = `~ ${etaObj.timeLabel}`;
    
    // Nota visual si es manual
    if(isManual){
        $('#etaTime').innerHTML += ` <span style="color:var(--warn); display:block; font-size:10px; margin-top:2px">(Base: ${manualVal} et/día)</span>`;
    }
  } else {
    $('#etaFinish').textContent = '—';
    $('#etaTime').textContent = '—';
  }
}

function recomputeAndRender(){
  const totals = renderKPIs(gStats);

  // 1. Promedio Real
  const { avg: histAvg, usedDays } = computeAvgSinceStartCap7(gDaysArrDesc);

  // 2. Velocidad para ETA (Fija vs Real)
  let calcSpeed = histAvg;
  let isManual = false;
  
  if(PREFS.useManual && PREFS.manualSpeed > 0){
      calcSpeed = PREFS.manualSpeed;
      isManual = true;
  }

  // 3. Calculo
  const etaObj = estimateFinishWithTime(totals.rest, calcSpeed, new Date(), CONFIG.DAY_CUTOFF_HOUR);

  renderSpeed(histAvg, etaObj, usedDays, isManual, PREFS.manualSpeed);
  renderDias(gDaysArrDesc);
}

/* ... (Funciones de renderizado de pozos y detalle igual que antes) ... */
const pozoIndex = (key)=> { const m = key.match(/pozo-(\d+)/i); return m ? parseInt(m[1],10) : 0; };
function renderPozos(stats, names){
  const cont = $('#viewPozos'); cont.innerHTML = '';
  const entries = Object.entries(stats).sort((a,b)=> a[0].localeCompare(b[0]));
  for(const [pozo, s] of entries){
    const pct = s.total>0 ? Math.round((s.realizadas/s.total)*100) : 0;
    const title = (names[pozo] || pozo.toUpperCase().replace('-', ' '));
    const idx = pozoIndex(pozo);
    const el = document.createElement('section');
    el.className = `card pad pozo color-${idx}`;
    el.setAttribute('data-key', pozo);
    el.innerHTML = `
      <div class="pozo-title">
        <div class="name">${title}</div>
        <div class="meta"><span class="badge">Tot: ${s.total}</span><span class="badge">Hechas: ${s.realizadas}</span><span class="badge">Rest: ${s.restantes}</span></div>
      </div>
      <div class="row"><div class="progress"><i style="width:${pct}%"></i></div><div class="pct">${pct}%</div></div>
    `;
    el.addEventListener('click', ()=> openDetail(pozo));
    cont.appendChild(el);
  }
}
function renderDias(daysArr){
  const recent = daysArr.slice(0, 20).reverse();
  gDaysLabels = recent.map(d=>d[0]); gDaysValues = recent.map(d=>d[1]);
  if ($('#viewDias').style.display !== 'none') { drawBarChart($('#daysChart'), gDaysLabels, gDaysValues); }
  const box = $('#daysListBox'); box.innerHTML = '';
  const list = document.createElement('div'); list.className='list'; box.appendChild(list);
  if(daysArr.length===0){
    const empty = document.createElement('div'); empty.className='muted'; empty.textContent = 'Sin datos recientes.'; box.appendChild(empty);
  } else {
    const todayYMD = new Date().toISOString().slice(0,10);
    for(const [ymd, count] of daysArr){
      const d = new Date(ymd+'T00:00:00');
      const ddmmyy = d.toLocaleDateString('es-AR', { timeZone:'America/Argentina/Buenos_Aires' });
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div class="left"><div class="h">${ddmmyy}</div><div class="tiny muted">${ymd===todayYMD?'Hoy':'—'}</div></div><div class="right">${fmt(count)}</div>`;
      list.appendChild(it);
    }
  }
}
function dailyCountsForSerie(serie){
  const map = new Map();
  for (const o of serie){
    if (isValidDateCell(o.fecha)){ const ymd = parseToYMD(o.fecha); if (ymd) map.set(ymd, (map.get(ymd)||0)+1); }
    else if (isStop(o.fecha)) break;
  }
  return Array.from(map.entries()).sort((a,b)=> a[0].localeCompare(b[0]));
}
function drawBarChart(canvas, labels, values){
  const ctx = canvas.getContext('2d'); const DPR = window.devicePixelRatio || 1;
  const parentW = canvas.parentElement ? canvas.parentElement.clientWidth : 0;
  const cssW = canvas.clientWidth || parentW || 700; const cssH = canvas.clientHeight || 220;
  const w = Math.max(50, Math.round(cssW * DPR)); const h = Math.max(50, Math.round(cssH * DPR));
  if (canvas.width !== w)  canvas.width = w; if (canvas.height !== h) canvas.height = h;
  ctx.setTransform(DPR,0,0,DPR,0,0);
  const ymdToDisp = ymd => { const m = ymd.match(/^(\d{4})-(\d{2})-(\d{2})$/); return m ? `${m[3]}/${m[2]}` : ymd; };
  ctx.clearRect(0,0,cssW,cssH); ctx.fillStyle = '#0a0a0a'; ctx.fillRect(0,0,cssW,cssH);
  const P = {l: 12, r: 8, t: 8, b: 40}; const W = Math.max(10, cssW - P.l - P.r); const H = Math.max(10, cssH - P.t - P.b);
  const maxV = Math.max(1, ...values); const count = Math.max(1, values.length);
  const stepX = W / count; const barW  = Math.max(8, Math.floor(stepX - 6));
  ctx.strokeStyle = '#1e1e1e'; ctx.lineWidth = 1; ctx.beginPath();
  for (let y=0; y<=4; y++){ const yy = P.t + H - (H * y / 4); ctx.moveTo(P.l, yy); ctx.lineTo(P.l+W, yy); } ctx.stroke();
  ctx.font = '11px Inter, system-ui, sans-serif'; ctx.textAlign = 'center';
  for (let i=0;i<count;i++){
    const v = values[i] || 0; const hBar = Math.round(H * v / maxV);
    const x = P.l + i*stepX + (stepX - barW)/2; const y = P.t + H - hBar;
    const grad = ctx.createLinearGradient(0,y,0,y+hBar); grad.addColorStop(0, '#47a3ff'); grad.addColorStop(1, '#60dbfb');
    ctx.fillStyle = grad; ctx.fillRect(x, y, barW, hBar);
    const cx = x + barW/2; const inside = hBar > 18;
    ctx.fillStyle = inside ? '#0b0b0b' : '#cfe8ff'; const ty = inside ? (y + 12) : (y - 4);
    ctx.fillText(String(v), cx, ty);
  }
  ctx.fillStyle = '#cfe8ff';
  for (let i=0;i<count;i++){
    const lbl = ymdToDisp(labels[i] || ''); const x = P.l + i*stepX + stepX/2; const y = P.t + H + 18;
    ctx.save(); ctx.translate(x, y); ctx.rotate(-Math.PI/4); ctx.textAlign = 'right'; ctx.fillText(lbl, 0, 0); ctx.restore();
  }
}
function renderDetail(pozoKey){
  const serie = gStats[pozoKey].serie; const name  = gNames[pozoKey] || pozoKey.toUpperCase().replace('-', ' ');
  $('#detailTitle').textContent = name;
  const idx = pozoIndex(pozoKey); const bar = $('#detailBar');
  bar.classList.remove('color-1','color-2','color-3','color-4','color-5','color-6');
  if (idx>=1 && idx<=6) bar.classList.add(`color-${idx}`);
  const s = gStats[pozoKey]; const pct = s.total>0 ? Math.round(100*s.realizadas/s.total) : 0;
  $('#dTot').textContent = fmt(s.total); $('#dDone').textContent = fmt(s.realizadas); $('#dLeft').textContent = fmt(s.restantes); $('#dPct').textContent = pct + '%';
  const fechas = serie.filter(o=>isValidDateCell(o.fecha)).map(o=>parseToYMD(o.fecha));
  const first = fechas.length ? new Date(fechas[0]+'T00:00:00') : null;
  const last  = fechas.length ? new Date(fechas[fechas.length-1]+'T00:00:00') : null;
  $('#dFirst').textContent = first ? first.toLocaleDateString('es-AR') : '—';
  $('#dLast').textContent  = last  ? last.toLocaleDateString('es-AR')  : '—';
  const list = $('#dList'); list.innerHTML = ''; let idxEt = 0;
  for (const o of serie){
    if (isStop(o.fecha)) break;
    idxEt++; let dateDisp = "—"; let sub = "";
    if (isValidDateCell(o.fecha)){ const ymd = parseToYMD(o.fecha); sub = ymd; dateDisp = new Date(ymd+'T00:00:00').toLocaleDateString('es-AR'); }
    else if(isAbortCancel(o.fecha)){ dateDisp = o.fecha; }
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<div class="left"><div class="h">Etapa ${idxEt}</div><div class="tiny muted">${sub}</div></div><div class="right">${dateDisp}</div>`;
    list.appendChild(el);
  }
  let daily = dailyCountsForSerie(serie);
  if (daily.length > 14) daily = daily.slice(daily.length-14);
  const labels = daily.map(d=>d[0]); const values = daily.map(d=>d[1]);
  drawBarChart($('#pozoChart'), labels, values);
}

function openDetail(pozoKey){ $('#mainTabs').style.display='none'; $('#topCard').style.display='none'; $('#viewPozos').style.display='none'; $('#viewDias').style.display='none'; $('#detailBar').style.display=''; $('#viewDetail').style.display='grid'; renderDetail(pozoKey); location.hash = pozoKey; }
function closeDetail(){ $('#detailBar').classList.remove('color-1','color-2','color-3','color-4','color-5','color-6'); $('#detailBar').style.display='none'; $('#viewDetail').style.display='none'; $('#mainTabs').style.display=''; $('#topCard').style.display=''; const active = document.querySelector('.tab.active')?.dataset.view || 'pozos'; $('#viewPozos').style.display = active==='pozos' ? '' : 'none'; $('#viewDias').style.display = active==='dias' ? '' : 'none'; history.replaceState(null, '', location.pathname + location.search); }
$('#btnBack').addEventListener('click', closeDetail);

async function fetchData(){ const res = await fetch(`${CONFIG.DATA_URL}?v=${Date.now()}`, { cache:'no-store' }); if(!res.ok){ throw new Error('HTTP '+res.status); } return await res.json(); }

async function load(){
  try{
    const data = await fetchData();
    const rows = data.items || data.rows || data || [];
    const byPozo = extractFracturadoColumns(rows);
    const names  = byPozo.__names || {};
    const stats  = computeStats(byPozo);
    const dias   = aggregateByDay(byPozo);
    gByPozo = byPozo; gStats = stats; gNames = names; gDaysArrDesc = dias;
    const lu = (data.meta?.lastUpdate) || data.lastUpdate || new Date().toISOString();
    const dtAR = new Date(lu).toLocaleString('es-AR', { timeZone:'America/Argentina/Buenos_Aires' });
    $('#lastUpdate').textContent = `Actualizado: ${dtAR}`;
    renderPozos(stats, names);
    recomputeAndRender();
    const hash = (location.hash||'').replace('#','').trim(); if (hash && stats[hash]) openDetail(hash);
  }catch(err){ console.error(err); alert('Error: '+err.message); }
}

/* Settings Logic */
const elModal = $('#modalSettings');
const elUseManual = $('#cfgUseManual');
const elManualVal = $('#cfgManualVal');

function openSettings(){
  elUseManual.checked = PREFS.useManual;
  elManualVal.value = PREFS.manualSpeed;
  elModal.classList.add('open');
}
function closeSettings(){ elModal.classList.remove('open'); }
function saveSettings(){
  PREFS.useManual = elUseManual.checked;
  PREFS.manualSpeed = Number(elManualVal.value) || 10;
  localStorage.setItem('mobile_prefs', JSON.stringify(PREFS));
  closeSettings();
  recomputeAndRender();
}

$('#btnCfg').addEventListener('click', openSettings);
$('#btnCloseCfg').addEventListener('click', closeSettings);
$('#btnSaveCfg').addEventListener('click', saveSettings);

/* UI Tabs */
$$('.tab').forEach(t => t.addEventListener('click', ()=> {
  const view = t.dataset.view; $$('.tab').forEach(x=> x.classList.toggle('active', x===t));
  $('#viewPozos').style.display = view==='pozos' ? '' : 'none';
  $('#viewDias').style.display  = view==='dias'  ? '' : 'none';
  if (view === 'dias') { requestAnimationFrame(()=> { drawBarChart(document.getElementById('daysChart'), gDaysLabels, gDaysValues); }); }
}));
$('#btnRefresh').addEventListener('click', load);
$('#btnHelp').addEventListener('click', ()=>{ alert('Tocá un pozo para ver detalles. Usá ⚙️ para configurar el cálculo de ETA.'); });
$('#btnInst').addEventListener('click', ()=>{ alert('Versión móvil v1.2\n\nEl ETA puede usar velocidad fija (10 et/día) o real. Configúralo en ⚙️.'); });
$('#btnShare').addEventListener('click', async ()=>{ try{ await navigator.share({ title:'Visor móvil', url: location.href }); }catch(_){} });
window.addEventListener('resize', () => { const diasVisible = $('#viewDias').style.display !== 'none'; if (diasVisible && gDaysLabels.length) { drawBarChart(document.getElementById('daysChart'), gDaysLabels, gDaysValues); } });

load();
</script>
</body>
</html>
