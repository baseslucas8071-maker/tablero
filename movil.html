<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Visor móvil de etapas</title>
  <style>
    :root{
      --bg:#000; --card:#0b0b0b; --muted:#cfe8ff; --ok:#1ad598; --warn:#ffc857; --bad:#ff6b6b; --ink:#e8f0ff;
      --accent:#47a3ff; --soft:#111; --ring:#2d2d2d; --shadow: 0 6px 20px rgba(0,0,0,.55);
    }
    html,body{height:100%; margin:0; background:#000; color:var(--ink); font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;}
    .wrap{min-height:100%; display:flex; flex-direction:column;}
    header{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, #000, rgba(0,0,0,.85)); border-bottom:1px solid #1a1a1a;}
    .bar{display:flex; align-items:center; gap:10px; padding:12px 14px;}
    .title{font-size:18px; font-weight:700; letter-spacing:.2px}
    .sub{font-size:12px; opacity:.8}
    .grow{flex:1}
    button, .chip{appearance:none; border:1px solid var(--ring); background:var(--soft); color:var(--ink); border-radius:12px; padding:8px 12px; font:inherit; font-weight:600}
    button:active{transform:scale(.98)}
    .chip{border-radius:999px; font-size:12px; padding:6px 10px;}
    .toolbar{display:flex; gap:8px}

    .tabs{display:flex; gap:8px; padding:8px 14px; border-bottom:1px solid #1a1a1a}
    .tab{flex:1; text-align:center; padding:10px 0; border-radius:12px; background:var(--soft); border:1px solid var(--ring); cursor:pointer; font-weight:700;}
    .tab.active{background:#121212; border-color:#2b466f; color:#dff0ff}

    main{padding:14px; display:grid; gap:12px}
    .card{background:var(--card); border:1px solid #161616; border-radius:16px; box-shadow:var(--shadow)}
    .card.pad{padding:14px}

    .kpis{display:grid; grid-template-columns:repeat(3, 1fr); gap:10px}
    .kpi{background:#090909; border:1px solid #161616; border-radius:12px; padding:10px}
    .kpi .label{font-size:11px; opacity:.8}
    .kpi .value{font-size:22px; font-weight:800; margin-top:2px}
    .kpi.ok .value{color:var(--ok)}
    .kpi.warn .value{color:var(--warn)}
    .kpi.bad .value{color:var(--bad)}

    .speed{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .speed .box{background:#090909; border:1px solid #161616; border-radius:12px; padding:10px}
    .speed .h{font-size:11px; opacity:.8}
    .speed .v{font-size:18px; font-weight:800; margin-top:2px}

    .pozo{display:grid; gap:8px}
    .pozo-title{display:flex; align-items:center; justify-content:space-between}
    .pozo-title .name{font-weight:900; letter-spacing:.3px; font-size:18px}
    .meta{display:flex; gap:8px}
    .badge{font-size:13px; background:#090909; border:1px solid #222; padding:5px 10px; border-radius:999px; font-weight:700}
    .row{display:flex; align-items:center; gap:14px}
    .progress{height:12px; background:#090909; border:1px solid #222; border-radius:999px; overflow:hidden; flex:1}
    .progress > i{display:block; height:100%; background:linear-gradient(90deg, #47a3ff, #60dbfb)}
    .pct{width:58px; text-align:right; font-size:14px; font-weight:800}

    .list{display:grid; gap:10px}
    .item{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:12px; border:1px solid #161616; background:#0a0a0a}
    .item .left{display:flex; flex-direction:column}
    .item .left .h{font-weight:700}
    .item .right{font-weight:800}

    .muted{opacity:.75}
    .tiny{font-size:11px}

    footer.nav{position:sticky; bottom:0; background:linear-gradient(0deg, #000, rgba(0,0,0,.85)); border-top:1px solid #1a1a1a;}
    .nav-inner{display:flex; gap:8px; padding:10px 14px}
    .nav-inner button{flex:1}

    @media (min-width:720px){ main{max-width:720px; margin:0 auto} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="bar">
        <div>
          <div class="title">Visor móvil – Etapas</div>
          <div class="sub" id="lastUpdate">—</div>
        </div>
        <div class="grow"></div>
        <div class="toolbar">
          <button id="btnRefresh" title="Actualizar datos">Actualizar</button>
        </div>
      </div>
      <div class="tabs">
        <div class="tab active" data-view="pozos">Por pozo</div>
        <div class="tab" data-view="dias">Por día</div>
      </div>
    </header>

    <main>
      <section class="card pad">
        <div class="kpis">
          <div class="kpi" id="kpiTotales"><div class="label">Etapas totales</div><div class="value">—</div></div>
          <div class="kpi ok" id="kpiRealizadas"><div class="label">Realizadas</div><div class="value">—</div></div>
          <div class="kpi warn" id="kpiRestantes"><div class="label">Restantes</div><div class="value">—</div></div>
        </div>
        <div class="speed">
          <div class="box">
            <div class="h">Promedio (últ. 3 días)</div>
            <div class="v" id="avgPace">—</div>
          </div>
          <div class="box">
            <div class="h">Fin estimado</div>
            <div class="v" id="etaFinish">—</div>
          </div>
        </div>
      </section>

      <section id="viewPozos" class="pozos"></section>
      <section id="viewDias" class="dias" style="display:none"></section>
    </main>

    <footer class="nav">
      <div class="nav-inner">
        <button id="btnShare">Compartir</button>
        <button id="btnInst">Instrucciones</button>
      </div>
    </footer>
  </div>

<script>
"use strict";

/* ========= CONFIG ========= */
const CONFIG = {
  DATA_URL: 'status.json',   // Debe estar junto a movil.html
  MAX_ETAPAS: 12,            // Usado si no se encuentra STOP
  AVG_WINDOW_DAYS: 3         // ventana para promedio de velocidad
};

/* ========= HELPERS ========= */
const $  = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt = n => new Intl.NumberFormat('es-AR').format(n);

function isStop(v){ return String(v).trim().toUpperCase() === 'STOP'; }

// Excel serial → Date (base 1899-12-30)
function excelSerialToDate(x){
  const n = Number(x);
  if(!isFinite(n)) return null;
  const ms = (n - 25569) * 86400 * 1000;
  const d = new Date(ms);
  return isNaN(d) ? null : d;
}
function isExcelSerial(v){
  const n = Number(String(v).trim());
  return isFinite(n) && n >= 20000 && n <= 80000;
}

function isValidDateCell(v){
  const s = String(v).trim();
  if(!s) return false;
  if(isExcelSerial(s)) return true;
  if(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/.test(s)) return true;
  if(/^(\d{1,2})-(\d{1,2})-(\d{4})$/.test(s)) return true;
  if(/^(\d{4})-(\d{2})-(\d{2})$/.test(s)) return true;
  return false;
}

function parseToYMD(v){
  const s = String(v).trim();
  if(isExcelSerial(s)){
    const d = excelSerialToDate(s);
    if(!d) return null;
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth()+1).padStart(2,'0');
    const dd= String(d.getUTCDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }
  let d,m,y;
  let m1 = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/);
  if(m1){ d=+m1[1]; m=+m1[2]; y=+m1[3]; if(y<100) y+=2000; return `${y.toString().padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
  let m2 = s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
  if(m2){ d=+m2[1]; m=+m2[2]; y=+m2[3]; return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
  let m3 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m3){ return s; }
  return null;
}
const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };

/* ========= EXTRACCIÓN =========
   - Nombres desde PRIMERA fila (FechaFracPozoN) y se descartan "X"/vacío.
   - Series SOLO con filas de datos: Fila = "#nn" (se ignoran encabezados), como en el TV.
*/
function extractFracturadoColumns(rows){
  const byPozo = {};
  if(!rows || !rows.length){ return byPozo; }

  const keys = Object.keys(rows[0] || {});
  const fechaCols = keys.filter(k => /^FechaFracPozo\d+$/i.test(k));
  if (!fechaCols.length){
    console.error('No se encontraron columnas FechaFracPozoN. Claves:', keys);
    alert('No se detectaron columnas FechaFracPozoN en status.json.');
    return byPozo;
  }

  // nombres
  const namesMap = {};
  const nameRow = rows[0] || {};
  for (const fk of fechaCols){
    const n = fk.match(/(\d+)/)[1];
    const val = String(nameRow[fk] ?? "").trim();
    if(val && val.toUpperCase() !== "X"){ namesMap[`pozo-${n}`] = val; }
  }

  // solo filas con Fila tipo "#nn"
  const dataRows = rows
    .map(r => ({...r, _fila:String(r.Fila||'').trim()}))
    .filter(r => /^#?\d+$/i.test(r._fila));

  for (const fk of fechaCols){
    const n = fk.match(/(\d+)/)[1];
    const pk = `pozo-${n}`;
    if(!(pk in namesMap)) continue; // ocultar pozos sin nombre
    const seqKey = keys.find(k => new RegExp(`^SecuenciaPozo${n}$`, 'i').test(k));
    byPozo[pk] = dataRows.map(r => ({
      fecha: r[fk] ?? "",
      sec:   seqKey ? (r[seqKey] ?? "") : ""
    }));
  }

  byPozo.__names = namesMap;
  return byPozo;
}

/* ========= CÓMPUTO ========= */
function computeStats(byPozo){
  const stats = {};
  for(const [pozo, serieObjs] of Object.entries(byPozo)){
    if(pozo === "__names") continue;
    const stopIdx = serieObjs.findIndex(o => isStop(o.fecha));
    const totalCells = (stopIdx >= 0) ? stopIdx : Math.min(serieObjs.length, CONFIG.MAX_ETAPAS);
    const considered = serieObjs.slice(0, totalCells);

    const realizadas = considered.filter(o => isValidDateCell(o.fecha)).length;
    const restantes  = Math.max(0, totalCells - realizadas);
    stats[pozo] = { total: totalCells, realizadas, restantes, serie: considered };
  }
  return stats;
}

function aggregateByDay(byPozo){
  const map = new Map(); // ymd -> count
  for(const [key, serie] of Object.entries(byPozo)){
    if(key === "__names") continue;
    for(const o of serie){
      const v = o.sec || o.fecha;
      if(isValidDateCell(v)){
        const ymd = parseToYMD(v);
        if(ymd){ map.set(ymd, (map.get(ymd)||0)+1); }
      } else if(isStop(o.fecha)){
        break;
      }
    }
  }
  return Array.from(map.entries()).sort((a,b)=> a[0] < b[0] ? 1 : -1);
}

/* ========= VELOCIDAD Y ETA ========= */
function computeAvgAndETA(daysArr, restantesTot){
  // daysArr: [['YYYY-MM-DD', count], ...] ordenado desc
  if(!daysArr.length) return {avg:null, etaDays:null, etaDate:null};
  const N = Math.min(CONFIG.AVG_WINDOW_DAYS, daysArr.length);
  let sum = 0;
  for(let i=0;i<N;i++) sum += daysArr[i][1];
  const avg = sum / N;
  if(!avg || avg<=0 || !isFinite(avg)) return {avg:0, etaDays:null, etaDate:null};
  const etaDays = Math.ceil(restantesTot / avg);
  const etaDate = addDays(new Date(), etaDays);
  return {avg, etaDays, etaDate};
}

/* ========= RENDER ========= */
function renderKPIs(stats){
  const all = Object.values(stats);
  const totales = all.reduce((a,b)=>a+b.total,0);
  const hechas  = all.reduce((a,b)=>a+b.realizadas,0);
  const rest    = all.reduce((a,b)=>a+b.restantes,0);
  $('#kpiTotales .value').textContent   = fmt(totales);
  $('#kpiRealizadas .value').textContent= fmt(hechas);
  $('#kpiRestantes .value').textContent = fmt(rest);
  return {totales, hechas, rest};
}
function renderSpeed(avg, etaDays, etaDate){
  $('#avgPace').textContent = (avg && avg>0) ? `${avg.toFixed(1)} etapas/día` : '—';
  $('#etaFinish').textContent = (etaDate)
    ? `${etaDate.toLocaleDateString('es-AR')} (≈ ${etaDays} días)`
    : '—';
}

function renderPozos(stats, names){
  const cont = $('#viewPozos');
  cont.innerHTML = '';
  const entries = Object.entries(stats).sort((a,b)=> a[0].localeCompare(b[0]));
  for(const [pozo, s] of entries){
    const pct = s.total>0 ? Math.round((s.realizadas/s.total)*100) : 0;
    const title = (names[pozo] || pozo.toUpperCase().replace('-', ' '));
    const el = document.createElement('section');
    el.className = 'card pad pozo';
    el.innerHTML = `
      <div class="pozo-title">
        <div class="name">${title}</div>
        <div class="meta">
          <span class="badge">Tot: ${s.total}</span>
          <span class="badge">Hechas: ${s.realizadas}</span>
          <span class="badge">Rest: ${s.restantes}</span>
        </div>
      </div>
      <div class="row">
        <div class="progress"><i style="width:${pct}%"></i></div>
        <div class="pct">${pct}%</div>
      </div>
    `;
    cont.appendChild(el);
  }
}

function renderDias(arr){
  const cont = $('#viewDias');
  cont.innerHTML = '';
  const box = document.createElement('section');
  box.className='card pad';
  const list = document.createElement('div');
  list.className='list';
  box.appendChild(list);

  if(arr.length===0){
    const empty = document.createElement('div');
    empty.className='muted';
    empty.textContent = 'Sin etapas registradas por día aún.';
    box.appendChild(empty);
  } else {
    const todayYMD = new Date().toISOString().slice(0,10);
    for(const [ymd, count] of arr){
      const d = new Date(ymd+'T00:00:00');
      const ddmmyy = d.toLocaleDateString('es-AR', { timeZone:'America/Argentina/Buenos_Aires' });
      const it = document.createElement('div');
      it.className='item';
      it.innerHTML = `<div class="left"><div class="h">${ddmmyy}</div><div class="tiny muted">${ymd===todayYMD?'Hoy':'—'}</div></div><div class="right">${fmt(count)}</div>`;
      list.appendChild(it);
    }
  }
  cont.appendChild(box);
}

/* ========= DATA LOAD ========= */
async function fetchData(){
  const res = await fetch(`${CONFIG.DATA_URL}?v=${Date.now()}`, { cache:'no-store' });
  if(!res.ok){ throw new Error('No se pudo cargar el JSON: '+res.status); }
  return await res.json();
}

async function load(){
  try{
    const data = await fetchData();
    const rows = data.items || data.rows || data || [];

    const byPozo = extractFracturadoColumns(rows);
    const names  = byPozo.__names || {};
    const stats  = computeStats(byPozo);
    const dias   = aggregateByDay(byPozo);

    const lu = (data.meta?.lastUpdate) || data.lastUpdate || new Date().toISOString();
    const dtAR = new Date(lu).toLocaleString('es-AR', { timeZone:'America/Argentina/Buenos_Aires' });
    $('#lastUpdate').textContent = `Actualizado: ${dtAR}`;

    const totals = renderKPIs(stats);
    // Promedio + ETA
    const pace = computeAvgAndETA(dias, totals.rest);
    renderSpeed(pace.avg, pace.etaDays, pace.etaDate);

    renderPozos(stats, names);
    renderDias(dias);
  }catch(err){
    console.error(err);
    alert('Error cargando datos: '+err.message+'\n• Verificá que movil.html y status.json estén en la MISMA carpeta\n• Abrí status.json en el navegador para confirmar que existe\n• Mirá la consola (F12) para ver detalles');
  }
}

/* ========= UI ========= */
$$('.tab').forEach(t => t.addEventListener('click', ()=> {
  const view = t.dataset.view;
  $$('.tab').forEach(x=> x.classList.toggle('active', x===t));
  $('#viewPozos').style.display = view==='pozos' ? '' : 'none';
  $('#viewDias').style.display  = view==='dias'  ? '' : 'none';
}));

$('#btnRefresh').addEventListener('click', load);
$('#btnInst').addEventListener('click', ()=>{
  alert(`Notas:
• Nombres de pozo desde la primera fila (FechaFracPozoN). Si es "X" o vacío, el pozo se oculta.
• Cómputo como el visor TV: sólo filas con Fila "#nn" cuentan; STOP define el total por pozo.
• Promedio = últimos ${CONFIG.AVG_WINDOW_DAYS} días con actividad. ETA = restantes / promedio.`);
});
$('#btnShare').addEventListener('click', async ()=>{
  try{ await navigator.share({ title:'Visor móvil – Etapas', text:'Estado de etapas', url: location.href }); }catch(_){}
});

/* ========= START ========= */
load();
</script>
</body>
</html>
