<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Visor móvil de etapas</title>
  <style>
    :root{
      --bg:#000; --card:#0b0b0b; --muted:#cfe8ff; --ok:#1ad598; --warn:#ffc857; --bad:#ff6b6b; --ink:#e8f0ff;
      --accent:#47a3ff; --soft:#111; --ring:#2d2d2d; --shadow: 0 6px 20px rgba(0,0,0,.55);
    }
    html,body{height:100%; margin:0; background:#000; color:var(--ink); font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;}
    .wrap{min-height:100%; display:flex; flex-direction:column;}
    header{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, #000, rgba(0,0,0,.85)); border-bottom:1px solid #1a1a1a;}
    .bar{display:flex; align-items:center; gap:10px; padding:12px 14px}
    .title{font-size:18px; font-weight:700; letter-spacing:.2px}
    .sub{font-size:12px; opacity:.8}
    .grow{flex:1}
    button, .chip{appearance:none; border:1px solid var(--ring); background:var(--soft); color:var(--ink); border-radius:12px; padding:8px 12px; font:inherit; font-weight:600}
    button:active{transform:scale(.98)}
    .chip{border-radius:999px; font-size:12px; padding:6px 10px;}
    .toolbar{display:flex; gap:8px}

    .tabs{display:flex; gap:8px; padding:8px 14px; border-bottom:1px solid #1a1a1a}
    .tab{flex:1; text-align:center; padding:10px 0; border-radius:12px; background:var(--soft); border:1px solid var(--ring); cursor:pointer; font-weight:700;}
    .tab.active{background:#121212; border-color:#2b466f; color:#dff0ff}

    main{padding:14px; display:grid; gap:12px}
    .card{background:var(--card); border:1px solid #161616; border-radius:16px; box-shadow:var(--shadow)}
    .card.pad{padding:14px}

    .kpis{display:grid; grid-template-columns:repeat(3, 1fr); gap:10px}
    .kpi{background:#090909; border:1px solid #161616; border-radius:12px; padding:10px}
    .kpi .label{font-size:11px; opacity:.8}
    .kpi .value{font-size:22px; font-weight:800; margin-top:2px}
    .kpi.ok .value{color:var(--ok)}
    .kpi.warn .value{color:var(--warn)}
    .kpi.bad .value{color:var(--bad)}

    .speed{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .speed .box{background:#090909; border:1px solid #161616; border-radius:12px; padding:10px}
    .speed .h{font-size:11px; opacity:.8; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .speed .v{font-size:18px; font-weight:800; margin-top:2px}
    .chip.toggle{cursor:pointer; border-color:#2b466f; background:#0f1520;}
    .chip.toggle.on{background:#12223a; color:#dff0ff; border-color:#3b5f98}

    .pozo{display:grid; gap:8px; cursor:pointer}
    .pozo:hover{outline:1px solid #1f3e66}

    .pozo-title{display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-radius:10px; background:#101010}
    .pozo-title .name{font-weight:900; letter-spacing:.3px; font-size:18px}
    .meta{display:flex; gap:8px}
    .badge{font-size:13px; background:#090909; border:1px solid #222; padding:5px 10px; border-radius:999px; font-weight:700}
    .pozo[class*="color-"] .pozo-title .badge{ background:rgba(0,0,0,.28); border-color:rgba(0,0,0,.35); color:#fff }

    .row{display:flex; align-items:center; gap:14px}
    .progress{height:12px; background:#090909; border:1px solid #222; border-radius:999px; overflow:hidden; flex:1}
    .progress > i{display:block; height:100%; background:linear-gradient(90deg, #47a3ff, #60dbfb)}
    .pct{width:58px; text-align:right; font-size:14px; font-weight:800}

    .list{display:grid; gap:10px}
    .item{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:12px; border:1px solid #161616; background:#0a0a0a}
    .item .left{display:flex; flex-direction:column}
    .item .left .h{font-weight:700}
    .item .right{font-weight:800}

    .muted{opacity:.75}
    .tiny{font-size:11px}

    .backbar{display:flex; align-items:center; gap:10px; padding:8px 14px}
    .backbar .t{font-weight:900; font-size:18px}
    .back{border-radius:10px}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .summary{display:grid; gap:8px}
    .kv{display:flex; align-items:center; justify-content:space-between; background:#0a0a0a; border:1px solid #161616; padding:10px 12px; border-radius:12px}
    canvas{width:100%; height:220px; display:block}

    footer.nav{position:sticky; bottom:0; background:linear-gradient(0deg, #000, rgba(0,0,0,.85)); border-top:1px solid #1a1a1a;}
    .nav-inner{display:flex; gap:8px; padding:10px 14px}
    .nav-inner button{flex:1}

    .color-1{ --c-bg:linear-gradient(90deg,#ffd83a,#ffd83a); --c-fg:#001; }
    .color-2{ --c-bg:linear-gradient(90deg,#7ad39a,#5fbf87); --c-fg:#001; }
    .color-3{ --c-bg:linear-gradient(90deg,#74b3ff,#4686ff); --c-fg:#001; }
    .color-4{ --c-bg:linear-gradient(90deg,#ff7b7b,#ff4c4c); --c-fg:#001; }
    .color-5{ --c-bg:linear-gradient(90deg,#ffffff,#f2f6f9); --c-fg:#001; }
    .color-6{ --c-bg:linear-gradient(90deg,#e8c3ff,#d79bf6); --c-fg:#201; }
    .pozo.color-1 .pozo-title,
    .pozo.color-2 .pozo-title,
    .pozo.color-3 .pozo-title,
    .pozo.color-4 .pozo-title,
    .pozo.color-5 .pozo-title,
    .pozo.color-6 .pozo-title{ background:var(--c-bg); color:var(--c-fg); }
    #detailBar[class*="color-"] .t{ background:var(--c-bg); color:var(--c-fg); padding:6px 10px; border-radius:10px; }

    @media (min-width:720px){ main{max-width:720px; margin:0 auto} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="bar">
        <div>
          <div class="title">Visor móvil – Etapas</div>
        </div>
        <div class="grow"></div>
        <div class="toolbar">
          <button id="btnRefresh" title="Actualizar datos">Actualizar</button>
          <button id="btnInst">Notas v1.0</button>
        </div>
      </div>
      <div class="tabs" id="mainTabs">
        <div class="tab active" data-view="pozos">Por pozo</div>
        <div class="tab" data-view="dias">Por día</div>
      </div>
      <div class="backbar" id="detailBar" style="display:none">
        <button class="back" id="btnBack">← Volver</button>
        <div class="t" id="detailTitle">Pozo</div>
      </div>
    </header>

    <main>
      <section class="card pad" id="topCard">
        <div class="kpis">
          <div class="kpi" id="kpiTotales"><div class="label">Etapas totales</div><div class="value">—</div></div>
          <div class="kpi ok" id="kpiRealizadas"><div class="label">Realizadas</div><div class="value">—</div></div>
          <div class="kpi warn" id="kpiRestantes"><div class="label">Restantes</div><div class="value">—</div></div>
        </div>
        <div class="speed" id="speedRow">
          <div class="box">
            <div class="h">
              Promedio (últimos 7 días, sin hoy)
              <span id="avgModeChip" class="chip toggle">Modo: Adaptativo</span>
            </div>
            <div class="v" id="avgPace">—</div>
            <div class="tiny muted" id="avgFoot">—</div>
          </div>
          <div class="box">
            <div class="h">Fin estimado</div>
            <div class="v" id="etaFinish">—</div>
          </div>
        </div>
        <div class="tiny muted" id="lastUpdate" style="margin-top:8px">—</div>
      </section>

      <section id="viewPozos" class="pozos"></section>

      <section id="viewDias" class="dias" style="display:none">
        <section class="card pad">
          <canvas id="daysChart" width="700" height="280" aria-label="Etapas por día (total PAD)"></canvas>
        </section>
        <section id="daysListBox" class="card pad"></section>
      </section>

      <section id="viewDetail" style="display:none; gap:12px">
        <section class="card pad">
          <canvas id="pozoChart" width="700" height="280" aria-label="Gráfica por día del pozo"></canvas>
        </section>
        <section class="card pad">
          <div class="grid2">
            <div class="summary">
              <div class="kv"><span>Total</span><strong id="dTot">—</strong></div>
              <div class="kv"><span>Hechas</span><strong id="dDone">—</strong></div>
              <div class="kv"><span>Restantes</span><strong id="dLeft">—</strong></div>
              <div class="kv"><span>Avance</span><strong id="dPct">—</strong></div>
              <div class="kv"><span>Primera</span><strong id="dFirst">—</strong></div>
              <div class="kv"><span>Última</span><strong id="dLast">—</strong></div>
            </div>
            <div>
              <div class="list" id="dList"></div>
            </div>
          </div>
        </section>
      </section>
    </main>

    <footer class="nav">
      <div class="nav-inner">
        <button id="btnShare">Compartir</button>
        <button id="btnHelp">Ayuda</button>
      </div>
    </footer>
  </div>

<script>
"use strict";

/* ========= CONFIG ========= */
const CONFIG = {
  DATA_URL: 'status.json',
  MAX_ETAPAS: 12
};

/* ========= HELPERS ========= */
const $  = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt = n => new Intl.NumberFormat('es-AR').format(n);
const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
const prefs = {
  get:(k,d)=>{ try{const v=localStorage.getItem(k); return v?JSON.parse(v):d;}catch(_){return d;} },
  set:(k,v)=>{ try{localStorage.setItem(k,JSON.stringify(v));}catch(_){ } }
};

function isStop(v){ return String(v).trim().toUpperCase() === 'STOP'; }
function isAbortCancel(v){
  const s = String(v).trim().toUpperCase();
  return s === 'ABORTADA' || s === 'CANCELADA';
}

// Excel serial → Date (base 1899-12-30)
function excelSerialToDate(x){
  const n = Number(x);
  if(!isFinite(n)) return null;
  const ms = (n - 25569) * 86400 * 1000;
  const d = new Date(ms);
  return isNaN(d) ? null : d;
}
function isExcelSerial(v){
  const n = Number(String(v).trim());
  return isFinite(n) && n >= 20000 && n <= 80000;
}

function isValidDateCell(v){
  const s = String(v).trim();
  if(!s) return false;
  if(isExcelSerial(s)) return true;
  if(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/.test(s)) return true;
  if(/^(\d{1,2})-(\d{1,2})-(\d{4})$/.test(s)) return true;
  if(/^(\d{4})-(\d{2})-(\d{2})$/.test(s)) return true;
  return false;
}
function parseToYMD(v){
  const s = String(v).trim();
  if(isExcelSerial(s)){
    const d = excelSerialToDate(s);
    if(!d) return null;
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth()+1).padStart(2,'0');
    const dd= String(d.getUTCDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }
  let d,m,y;
  let m1 = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/);
  if(m1){ d=+m1[1]; m=+m1[2]; y=+m1[3]; if(y<100) y+=2000; return `${y.toString().padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
  let m2 = s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
  if(m2){ d=+m2[1]; m=+m2[2]; y=+m2[3]; return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
  let m3 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m3){ return s; }
  return null;
}

/* ========= EXTRACCIÓN ========= */
let gByPozo = null;
let gStats  = null;
let gNames  = null;

let gDaysLabels = [];
let gDaysValues = [];

function extractFracturadoColumns(rows){
  const byPozo = {};
  if(!rows || !rows.length){ return byPozo; }

  const keys = Object.keys(rows[0] || {});
  const fechaCols = keys.filter(k => /^FechaFracPozo\d+$/i.test(k));
  if (!fechaCols.length){
    console.error('No se encontraron columnas FechaFracPozoN.');
    alert('No se detectaron columnas FechaFracPozoN en status.json.');
    return byPozo;
  }

  const namesMap = {};
  const nameRow = rows[0] || {};
  for (const fk of fechaCols){
    const n = fk.match(/(\d+)/)[1];
    const val = String(nameRow[fk] ?? "").trim();
    if(val && val.toUpperCase() !== "X"){ namesMap[`pozo-${n}`] = val; }
  }

  const dataRows = rows
    .map(r => ({...r, _fila:String(r.Fila||'').trim()}))
    .filter(r => /^#?\d+$/i.test(r._fila));

  for (const fk of fechaCols){
    const n = fk.match(/(\d+)/)[1];
    const pk = `pozo-${n}`;
    if(!(pk in namesMap)) continue;
    const seqKey = keys.find(k => new RegExp(`^SecuenciaPozo${n}$`, 'i').test(k));
    byPozo[pk] = dataRows.map(r => ({
      fecha: r[fk] ?? "",
      sec:   seqKey ? (r[seqKey] ?? "") : ""
    }));
  }

  byPozo.__names = namesMap;
  return byPozo;
}

/* ========= CÓMPUTO ========= */
function computeStats(byPozo){
  const stats = {};
  for(const [pozo, serieObjs] of Object.entries(byPozo)){
    if(pozo === "__names") continue;
    const stopIdx = serieObjs.findIndex(o => isStop(o.fecha));
    const totalCells = (stopIdx >= 0) ? stopIdx : Math.min(serieObjs.length, CONFIG.MAX_ETAPAS);
    const considered = serieObjs.slice(0, totalCells);

    const realizadas = considered.filter(o => isValidDateCell(o.fecha) || isAbortCancel(o.fecha)).length;
    const restantes  = Math.max(0, totalCells - realizadas);
    stats[pozo] = { total: totalCells, realizadas, restantes, serie: considered };
  }
  return stats;
}

function aggregateByDay(byPozo){
  const map = new Map(); // ymd -> count
  for (const [key, serie] of Object.entries(byPozo)){
    if (key === "__names") continue;
    for (const o of serie){
      if (isValidDateCell(o.fecha)){
        const ymd = parseToYMD(o.fecha);
        if (ymd) map.set(ymd, (map.get(ymd)||0) + 1);
      } else if (isStop(o.fecha)){
        break;
      } // ABORTADA/CANCELADA no suman por día
    }
  }
  // Devuelve orden DESC (más reciente primero)
  return Array.from(map.entries()).sort((a,b)=> a[0] < b[0] ? 1 : -1);
}

/* === PROMEDIO últimos 7 (sin hoy) con dos modos: adaptativo/fijo === */
function computeAvgLast7ExcludeToday(daysArr, mode /* 'adaptive' | 'fixed' */){
  // daysArr viene DESC: [['YYYY-MM-DD', count], ...]
  const map = new Map(daysArr);
  const tz = 'America/Argentina/Buenos_Aires';
  const today = new Date();
  const tzToday = new Date(today.toLocaleString('en-US', { timeZone: tz }));

  if (mode === 'adaptive'){
    // MODO ADAPTATIVO: usa solo días con datos previos (1..7), sin hoy
    const values = [];
    for (let i=1; i<=7; i++){
      const d = new Date(tzToday);
      d.setDate(d.getDate() - i);
      const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      if (map.has(ymd)) values.push(map.get(ymd)); // solo cuenta días existentes
    }
    const used = values.length || 1; // evita división por 0
    const sum  = values.reduce((a,b)=>a+b,0);
    return { avg: sum / used, window: values.slice().reverse(), usedDays: values.length };
  } else {
    // MODO FIJO: siempre 7 días previos, los faltantes cuentan 0
    const values = [];
    for (let i=1; i<=7; i++){
      const d = new Date(tzToday);
      d.setDate(d.getDate() - i);
      const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      values.push(map.get(ymd) || 0);
    }
    const sum = values.reduce((a,b)=>a+b,0);
    return { avg: sum / 7, window: values.slice().reverse(), usedDays: 7 };
  }
}

function computeETA(remaining, avgPerDay){
  if (!avgPerDay || avgPerDay <= 0 || !isFinite(avgPerDay)) return {etaDays:null, etaDate:null};
  const etaDays = Math.ceil(remaining / avgPerDay);
  const etaDate = addDays(new Date(), etaDays);
  return {etaDays, etaDate};
}

/* ========= RENDER (HOME) ========= */
function renderKPIs(stats){
  const all = Object.values(stats);
  const totales = all.reduce((a,b)=>a+b.total,0);
  const hechas  = all.reduce((a,b)=>a+b.realizadas,0);
  const rest    = all.reduce((a,b)=>a+b.restantes,0);
  $('#kpiTotales .value').textContent   = fmt(totales);
  $('#kpiRealizadas .value').textContent= fmt(hechas);
  $('#kpiRestantes .value').textContent = fmt(rest);
  return {totales, hechas, rest};
}
function renderSpeed(avg, etaDays, etaDate, usedDays, mode){
  $('#avgPace').textContent = (avg && avg>0) ? `${avg.toFixed(1)} etapas/día` : '—';
  $('#etaFinish').textContent = (etaDate)
    ? `${etaDate.toLocaleDateString('es-AR')} (≈ ${etaDays} días)`
    : '—';
  const lbl = mode === 'adaptive' ? 'Adaptativo' : 'Fijo';
  $('#avgFoot').textContent = `Modo: ${lbl} · Días usados: ${usedDays || (mode==='adaptive' ? 0 : 7)}`;
  const chip = $('#avgModeChip');
  chip.textContent = `Modo: ${lbl}`;
  chip.classList.toggle('on', mode==='adaptive');
}
const pozoIndex = (key)=> {
  const m = key.match(/pozo-(\d+)/i);
  return m ? parseInt(m[1],10) : 0;
};
function renderPozos(stats, names){
  const cont = $('#viewPozos');
  cont.innerHTML = '';
  const entries = Object.entries(stats).sort((a,b)=> a[0].localeCompare(b[0]));
  for(const [pozo, s] of entries){
    const pct = s.total>0 ? Math.round((s.realizadas/s.total)*100) : 0;
    const title = (names[pozo] || pozo.toUpperCase().replace('-', ' '));
    const idx = pozoIndex(pozo);
    const el = document.createElement('section');
    el.className = `card pad pozo color-${idx}`;
    el.setAttribute('data-key', pozo);
    el.innerHTML = `
      <div class="pozo-title">
        <div class="name">${title}</div>
        <div class="meta">
          <span class="badge">Tot: ${s.total}</span>
          <span class="badge">Hechas: ${s.realizadas}</span>
          <span class="badge">Rest: ${s.restantes}</span>
        </div>
      </div>
      <div class="row">
        <div class="progress"><i style="width:${pct}%"></i></div>
        <div class="pct">${pct}%</div>
      </div>
    `;
    el.addEventListener('click', ()=> openDetail(pozo));
    cont.appendChild(el);
  }
}

/* ====== POR DÍA (gráfica + lista) ====== */
function renderDias(daysArr){
  const recent = daysArr.slice(0, 20).reverse();
  gDaysLabels = recent.map(d=>d[0]);
  gDaysValues = recent.map(d=>d[1]);

  if ($('#viewDias').style.display !== 'none') {
    drawBarChart($('#daysChart'), gDaysLabels, gDaysValues);
  }

  const box = $('#daysListBox');
  box.innerHTML = '';
  const list = document.createElement('div');
  list.className='list';
  box.appendChild(list);

  if(daysArr.length===0){
    const empty = document.createElement('div');
    empty.className='muted';
    empty.textContent = 'Sin etapas registradas por día aún.';
    box.appendChild(empty);
  } else {
    const todayYMD = new Date().toISOString().slice(0,10);
    for(const [ymd, count] of daysArr){
      const d = new Date(ymd+'T00:00:00');
      const ddmmyy = d.toLocaleDateString('es-AR', { timeZone:'America/Argentina/Buenos_Aires' });
      const it = document.createElement('div');
      it.className='item';
      it.innerHTML = `<div class="left"><div class="h">${ddmmyy}</div><div class="tiny muted">${ymd===todayYMD?'Hoy':'—'}</div></div><div class="right">${fmt(count)}</div>`;
      list.appendChild(it);
    }
  }
}

/* ========= RENDER (DETALLE) ========= */
function dailyCountsForSerie(serie){
  const map = new Map();
  for (const o of serie){
    if (isValidDateCell(o.fecha)){
      const ymd = parseToYMD(o.fecha);
      if (ymd) map.set(ymd, (map.get(ymd)||0)+1);
    } else if (isStop(o.fecha)){
      break;
    }
  }
  return Array.from(map.entries()).sort((a,b)=> a[0].localeCompare(b[0]));
}

/* --- Gráfica (con etiquetas numéricas en cada barra) --- */
function drawBarChart(canvas, labels, values){
  const ctx = canvas.getContext('2d');
  const DPR = window.devicePixelRatio || 1;

  const parentW = canvas.parentElement ? canvas.parentElement.clientWidth : 0;
  const cssW = canvas.clientWidth || parentW || 700;
  const cssH = canvas.clientHeight || 220;

  const w = Math.max(50, Math.round(cssW * DPR));
  const h = Math.max(50, Math.round(cssH * DPR));
  if (canvas.width !== w)  canvas.width = w;
  if (canvas.height !== h) canvas.height = h;
  ctx.setTransform(DPR,0,0,DPR,0,0);

  const ymdToDisp = ymd => {
    const m = ymd.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    return m ? `${m[3]}/${m[2]}` : ymd;
  };

  ctx.clearRect(0,0,cssW,cssH);
  ctx.fillStyle = '#0a0a0a';
  ctx.fillRect(0,0,cssW,cssH);

  const P = {l: 12, r: 8, t: 8, b: 40};
  const W = Math.max(10, cssW - P.l - P.r);
  const H = Math.max(10, cssH - P.t - P.b);

  const maxV = Math.max(1, ...values);
  const count = Math.max(1, values.length);
  const stepX = W / count;
  const barW  = Math.max(8, Math.floor(stepX - 6));

  ctx.strokeStyle = '#1e1e1e';
  ctx.lineWidth = 1;
  ctx.beginPath();
  for (let y=0; y<=4; y++){
    const yy = P.t + H - (H * y / 4);
    ctx.moveTo(P.l, yy); ctx.lineTo(P.l+W, yy);
  }
  ctx.stroke();

  ctx.font = '11px Inter, system-ui, sans-serif';
  ctx.textAlign = 'center';
  for (let i=0;i<count;i++){
    const v = values[i] || 0;
    const hBar = Math.round(H * v / maxV);
    const x = P.l + i*stepX + (stepX - barW)/2;
    const y = P.t + H - hBar;

    const grad = ctx.createLinearGradient(0,y,0,y+hBar);
    grad.addColorStop(0, '#47a3ff');
    grad.addColorStop(1, '#60dbfb');
    ctx.fillStyle = grad;
    ctx.fillRect(x, y, barW, hBar);

    const cx = x + barW/2;
    const inside = hBar > 18;
    ctx.fillStyle = inside ? '#0b0b0b' : '#cfe8ff';
    const ty = inside ? (y + 12) : (y - 4);
    ctx.fillText(String(v), cx, ty);
  }

  ctx.fillStyle = '#cfe8ff';
  for (let i=0;i<count;i++){
    const lbl = ymdToDisp(labels[i] || '');
    const x = P.l + i*stepX + stepX/2;
    const y = P.t + H + 18;
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(-Math.PI/4);
    ctx.textAlign = 'right';
    ctx.fillText(lbl, 0, 0);
    ctx.restore();
  }
}

function renderDetail(pozoKey){
  const serie = gStats[pozoKey].serie;
  const name  = gNames[pozoKey] || pozoKey.toUpperCase().replace('-', ' ');
  $('#detailTitle').textContent = name;

  const idx = pozoIndex(pozoKey);
  const bar = $('#detailBar');
  bar.classList.remove('color-1','color-2','color-3','color-4','color-5','color-6');
  if (idx>=1 && idx<=6) bar.classList.add(`color-${idx}`);

  const s   = gStats[pozoKey];
  const pct = s.total>0 ? Math.round(100*s.realizadas/s.total) : 0;
  $('#dTot').textContent   = fmt(s.total);
  $('#dDone').textContent  = fmt(s.realizadas);
  $('#dLeft').textContent  = fmt(s.restantes);
  $('#dPct').textContent   = pct + '%';

  const fechas = serie
    .filter(o=>isValidDateCell(o.fecha))
    .map(o=>parseToYMD(o.fecha));
  const first = fechas.length ? new Date(fechas[0]+'T00:00:00') : null;
  const last  = fechas.length ? new Date(fechas[fechas.length-1]+'T00:00:00') : null;
  $('#dFirst').textContent = first ? first.toLocaleDateString('es-AR') : '—';
  $('#dLast').textContent  = last  ? last.toLocaleDateString('es-AR')  : '—';

  const list = $('#dList');
  list.innerHTML = '';
  let idxEt = 0;
  for (const o of serie){
    if (isStop(o.fecha)) break;
    if (!isValidDateCell(o.fecha)) continue;
    idxEt++;
    const ymd = parseToYMD(o.fecha);
    const dateDisp = new Date(ymd+'T00:00:00').toLocaleDateString('es-AR');
    const el = document.createElement('div');
    el.className='item';
    el.innerHTML = `<div class="left"><div class="h">Etapa ${idxEt}</div><div class="tiny muted">${ymd}</div></div><div class="right">${dateDisp}</div>`;
    list.appendChild(el);
  }

  let daily = dailyCountsForSerie(serie);
  if (daily.length > 14) daily = daily.slice(daily.length-14);
  const labels = daily.map(d=>d[0]);
  const values = daily.map(d=>d[1]);
  drawBarChart($('#pozoChart'), labels, values);
}

/* ========= NAVEGACIÓN ========= */
function openDetail(pozoKey){
  $('#mainTabs').style.display='none';
  $('#topCard').style.display='none';
  $('#viewPozos').style.display='none';
  $('#viewDias').style.display='none';
  $('#detailBar').style.display='';
  $('#viewDetail').style.display='grid';
  renderDetail(pozoKey);
  location.hash = pozoKey;
}
function closeDetail(){
  $('#detailBar').classList.remove('color-1','color-2','color-3','color-4','color-5','color-6');
  $('#detailBar').style.display='none';
  $('#viewDetail').style.display='none';
  $('#mainTabs').style.display='';
  $('#topCard').style.display='';
  const active = document.querySelector('.tab.active')?.dataset.view || 'pozos';
  $('#viewPozos').style.display = active==='pozos' ? '' : 'none';
  $('#viewDias').style.display  = active==='dias'  ? '' : 'none';
  history.replaceState(null, '', location.pathname + location.search);
}
$('#btnBack').addEventListener('click', closeDetail);

/* ========= DATA LOAD ========= */
async function fetchData(){
  const res = await fetch(`${CONFIG.DATA_URL}?v=${Date.now()}`, { cache:'no-store' });
  if(!res.ok){ throw new Error('No se pudo cargar el JSON: '+res.status); }
  return await res.json();
}

let gDaysArrDesc = []; // cache de [['yyyy-mm-dd', count], ...] DESC
function recomputeAndRender(avgMode){
  // KPIs y tarjetas
  const totals = renderKPIs(gStats);

  // Promedio + ETA
  const { avg, usedDays } = computeAvgLast7ExcludeToday(gDaysArrDesc, avgMode);
  const { etaDays, etaDate } = computeETA(totals.rest, avg);
  renderSpeed(avg, etaDays, etaDate, usedDays, avgMode);

  // Por día (gráfica + lista)
  renderDias(gDaysArrDesc);
}

async function load(){
  try{
    const data = await fetchData();
    const rows = data.items || data.rows || data || [];

    const byPozo = extractFracturadoColumns(rows);
    const names  = byPozo.__names || {};
    const stats  = computeStats(byPozo);
    const dias   = aggregateByDay(byPozo); // DESC

    gByPozo = byPozo; gStats = stats; gNames = names; gDaysArrDesc = dias;

    const lu = (data.meta?.lastUpdate) || data.lastUpdate || new Date().toISOString();
    const dtAR = new Date(lu).toLocaleString('es-AR', { timeZone:'America/Argentina/Buenos_Aires' });
    $('#lastUpdate').textContent = `Actualizado: ${dtAR}`;

    renderPozos(stats, names);
    recomputeAndRender(prefs.get('avgMode','adaptive'));

    const hash = (location.hash||'').replace('#','').trim();
    if (hash && stats[hash]) openDetail(hash);

  }catch(err){
    console.error(err);
    alert('Error cargando datos: '+err.message);
  }
}

/* ========= UI ========= */
$$('.tab').forEach(t => t.addEventListener('click', ()=> {
  const view = t.dataset.view;
  $$('.tab').forEach(x=> x.classList.toggle('active', x===t));
  $('#viewPozos').style.display = view==='pozos' ? '' : 'none';
  $('#viewDias').style.display  = view==='dias'  ? '' : 'none';

  if (view === 'dias') {
    requestAnimationFrame(()=> {
      drawBarChart(document.getElementById('daysChart'), gDaysLabels, gDaysValues);
    });
  }
}));
$('#btnRefresh').addEventListener('click', load);
$('#btnHelp').addEventListener('click', ()=>{
  alert('Tocá un pozo para abrir su detalle. Usá "Notas v1.0" para ver reglas y definiciones.');
});

document.getElementById('btnInst').addEventListener('click', ()=>{
  const mode = prefs.get('avgMode','adaptive')==='adaptive' ? 'Adaptativo' : 'Fijo';
  alert(
`Notas de versión 1.0

• Promedio de ritmo (últimos 7 días, sin hoy)
   - Modo Adaptativo: promedia solo días con etapas dentro de los últimos 7 (si hay 4 días, promedia 4).
   - Modo Fijo: siempre divide por 7; días sin etapas cuentan como 0.
   - Modo actual: ${mode}.
• ETA (fin estimado): etapas restantes / promedio diario (si el promedio = 0, no se muestra ETA).
• Reglas de conteo:
   - "Realizadas": celdas con fecha o con los textos ABORTADA/CANCELADA.
   - "Totales": cantidad de filas hasta la primera celda "STOP" (sin incluirla).
   - "Restantes": Totales – Realizadas.
   - Gráfica/tabla por día: SOLO cuentan celdas con fecha (ABORTADA/CANCELADA no suman por día).
• Vista por pozo: cada tarjeta muestra Tot/Hechas/Rest y %; el color del encabezado corresponde al número de pozo.
• Detalle de pozo: tocá un pozo para ver su gráfica por día y el listado de etapas (muestra fecha).
• Datos: se leen de status.json y se refrescan con “Actualizar”.

Sugerencias futuras:
• Corte de “día operativo” configurable (ej. 06:00) para agrupar días.
• Exportar CSV del detalle por pozo y del agregado por día.
• Filtros: rango de fechas y selección de pozos visibles.`
  );
});

$('#btnShare').addEventListener('click', async ()=>{
  try{ await navigator.share({ title:'Visor móvil – Etapas', text:'Estado de etapas', url: location.href }); }catch(_){}
});

window.addEventListener('resize', () => {
  const diasVisible = $('#viewDias').style.display !== 'none';
  if (diasVisible && gDaysLabels.length) {
    drawBarChart(document.getElementById('daysChart'), gDaysLabels, gDaysValues);
  }
});

/* === Toggle de modo de promedio (persistente) === */
const avgChip = document.getElementById('avgModeChip');
function updateAvgChip(){
  const mode = prefs.get('avgMode','adaptive');
  avgChip.textContent = `Modo: ${mode==='adaptive' ? 'Adaptativo' : 'Fijo'}`;
  avgChip.classList.toggle('on', mode==='adaptive');
}
avgChip.addEventListener('click', ()=>{
  const cur = prefs.get('avgMode','adaptive');
  const next = cur === 'adaptive' ? 'fixed' : 'adaptive';
  prefs.set('avgMode', next);
  updateAvgChip();
  if (gStats && gDaysArrDesc) recomputeAndRender(next);
});
updateAvgChip();

/* ========= START ========= */
load();
</script>
</body>
</html>
