<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Visor Móvil PAD - Dinastía AI</title>
  <style>
    :root{
      --bg:#000; --card:#0b0b0b; --muted:#cfe8ff; --ok:#1ad598; --warn:#ffc857; --bad:#ff6b6b; --ink:#e8f0ff;
      --accent:#47a3ff; --soft:#111; --ring:#2d2d2d; --shadow: 0 6px 20px rgba(0,0,0,.55);
    }
    html,body{height:100%; margin:0; background:#000; color:var(--ink); font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif; overflow-x:hidden;}
    .wrap{min-height:100%; display:flex; flex-direction:column;}
    header{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, #000, rgba(0,0,0,.85)); border-bottom:1px solid #1a1a1a;}
    .bar{display:flex; align-items:center; gap:10px; padding:12px 14px}
    .title{font-size:18px; font-weight:700; letter-spacing:.2px}
    .grow{flex:1}
    button, .chip{appearance:none; border:1px solid var(--ring); background:var(--soft); color:var(--ink); border-radius:12px; padding:8px 12px; font:inherit; font-weight:600}
    button:active{transform:scale(.98)}
    .chip{border-radius:999px; font-size:12px; padding:6px 10px;}
    .toolbar{display:flex; gap:8px}

    .tabs{display:flex; gap:8px; padding:8px 14px; border-bottom:1px solid #1a1a1a}
    .tab{flex:1; text-align:center; padding:10px 0; border-radius:12px; background:var(--soft); border:1px solid var(--ring); cursor:pointer; font-weight:700;}
    .tab.active{background:#121212; border-color:#2b466f; color:#dff0ff}

    main{padding:14px; display:grid; gap:12px}
    .card{background:var(--card); border:1px solid #161616; border-radius:16px; box-shadow:var(--shadow)}
    .card.pad{padding:14px}

    .kpis{display:grid; grid-template-columns:repeat(3, 1fr); gap:10px}
    .kpi{background:#090909; border:1px solid #161616; border-radius:12px; padding:10px}
    .kpi .label{font-size:12px; opacity:.8}
    .kpi .value{font-size:24px; font-weight:800; margin-top:2px}
    .kpi.ok .value{color:var(--ok)}
    .kpi.warn .value{color:var(--warn)}

    .speed{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .speed .box{background:#090909; border:1px solid #161616; border-radius:12px; padding:10px}
    .speed .h{font-size:11px; opacity:.8}
    .speed .v{font-size:18px; font-weight:800; margin-top:2px; line-height: 1.2;}

    .pozo{display:grid; gap:8px; cursor:pointer; margin-bottom:4px}
    .pozo-title{display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-radius:10px; background:#101010}
    .pozo-title .name{font-weight:900; font-size:18px}
    .meta{display:flex; gap:8px}
    .badge{font-size:13px; background:rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.1); padding:4px 10px; border-radius:999px; font-weight:700}

    .row{display:flex; align-items:center; gap:14px}
    .progress{height:12px; background:#090909; border:1px solid #222; border-radius:999px; overflow:hidden; flex:1}
    .progress > i{display:block; height:100%; background:linear-gradient(90deg, #47a3ff, #60dbfb)}
    .pct{width:50px; text-align:right; font-size:14px; font-weight:800}

    .list{display:grid; gap:10px}
    .item{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:12px; border:1px solid #161616; background:#0a0a0a}
    .item .left .h{font-weight:700}
    .item .right{font-weight:800}

    .backbar{display:flex; align-items:center; gap:10px; padding:8px 14px}
    .backbar .t{font-weight:900; font-size:18px}
    
    canvas{width:100%; height:220px; display:block}

    .overlay{position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:100; display:none; align-items:center; justify-content:center}
    .overlay.open{display:flex}
    .modal-box{background:#111; border:1px solid #222; width:90%; max-width:400px; border-radius:16px; padding:16px}
    .form-row{display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; padding:10px; background:#080808; border-radius:8px}

    /* Colores por pozo */
    .color-1{ --c-bg:linear-gradient(90deg,#ffd83a,#ffd83a); --c-fg:#000; }
    .color-2{ --c-bg:linear-gradient(90deg,#7ad39a,#5fbf87); --c-fg:#000; }
    .color-3{ --c-bg:linear-gradient(90deg,#74b3ff,#4686ff); --c-fg:#000; }
    .color-4{ --c-bg:linear-gradient(90deg,#ff7b7b,#ff4c4c); --c-fg:#000; }
    .color-5{ --c-bg:linear-gradient(90deg,#ffffff,#f2f6f9); --c-fg:#000; }
    .color-6{ --c-bg:linear-gradient(90deg,#e8c3ff,#d79bf6); --c-fg:#000; }
    .pozo[class*="color-"] .pozo-title, #detailBar[class*="color-"] .t{ background:var(--c-bg); color:var(--c-fg); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="bar">
        <div class="title">Visor Móvil PAD</div>
        <div class="grow"></div>
        <div class="toolbar">
          <button id="btnRefresh">↻</button>
          <button id="btnCfg">⚙️</button>
        </div>
      </div>
      <div class="tabs" id="mainTabs">
        <div class="tab active" data-view="pozos">Por pozo</div>
        <div class="tab" data-view="dias">Por día</div>
      </div>
      <div class="backbar" id="detailBar" style="display:none">
        <button id="btnBack">← Volver</button>
        <div class="t" id="detailTitle">Pozo</div>
      </div>
    </header>

    <main>
      <section class="card pad" id="topCard">
        <div class="kpis">
          <div class="kpi" id="kpiTotales"><div class="label">Total Etapas</div><div class="value">—</div></div>
          <div class="kpi ok" id="kpiRealizadas"><div class="label">Hechas</div><div class="value">—</div></div>
          <div class="kpi warn" id="kpiRestantes"><div class="label">Restantes</div><div class="value">—</div></div>
        </div>
        <div class="speed">
          <div class="box">
            <div class="h">Promedio Real</div>
            <div class="v" id="avgPace">—</div>
          </div>
          <div class="box">
            <div class="h">Fin estimado</div>
            <div class="v" id="etaFinish">—</div>
          </div>
        </div>
        <div id="lastUpdate" style="font-size:11px; opacity:0.5; margin-top:8px; text-align:center"></div>
      </section>

      <section id="viewPozos" class="pozos"></section>

      <section id="viewDias" class="dias" style="display:none">
        <section class="card pad" style="margin-bottom:10px"><canvas id="daysChart"></canvas></section>
        <div id="daysListBox"></div>
      </section>

      <section id="viewDetail" style="display:none">
        <section class="card pad" style="margin-bottom:10px"><canvas id="pozoChart"></canvas></section>
        <section class="card pad">
          <div class="summary" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:15px">
             <div class="kv" style="background:#0a0a0a; padding:10px; border-radius:8px"><span>Total:</span> <strong id="dTot">—</strong></div>
             <div class="kv" style="background:#0a0a0a; padding:10px; border-radius:8px"><span>Hechas:</span> <strong id="dDone">—</strong></div>
          </div>
          <div id="dList" class="list"></div>
        </section>
      </section>
    </main>
  </div>

  <div class="overlay" id="modalSettings">
    <div class="modal-box">
      <h3 style="margin-top:0">Ajustes de ETA</h3>
      <div class="form-row"><span>Usar Velocidad Fija</span><input type="checkbox" id="cfgUseManual"></div>
      <div class="form-row"><span>Etapas / Día</span><input type="number" id="cfgManualVal" step="0.1"></div>
      <button id="btnSaveCfg" style="width:100%; background:var(--accent); color:#000; border:none; padding:12px; border-radius:8px; font-weight:bold">Guardar</button>
      <button id="btnCloseCfg" style="width:100%; background:transparent; border:none; color:#fff; margin-top:10px">Cerrar</button>
    </div>
  </div>

<script>
"use strict";

const CONFIG = {
  DATA_URL: 'status.json',
  MAX_ETAPAS: 70 
};

let PREFS = JSON.parse(localStorage.getItem('mobile_prefs')) || { useManual: true, manualSpeed: 10 };
let gStats = {}, gNames = {}, gDays = [];

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

function isStop(v) { return String(v || "").trim().toUpperCase() === 'STOP'; }
function isValidDate(v) {
  const s = String(v || "").trim();
  if(!s) return false;
  if(!isNaN(s) && Number(s) > 40000) return true;
  return /^(\d{1,2})[\/\-]\d{1,2}[\/\-]\d{2,4}/.test(s) || /^\d{4}-\d{2}-\d{2}/.test(s);
}

function parseToYMD(v) {
  const s = String(v || "").trim();
  if(!isNaN(s) && Number(s) > 40000) {
    const d = new Date((Number(s) - 25569) * 86400 * 1000);
    return d.toISOString().split('T')[0];
  }
  const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
  if(m) {
    let y = +m[3]; if(y < 100) y += 2000;
    return `${y}-${String(m[2]).padStart(2,'0')}-${String(m[1]).padStart(2,'0')}`;
  }
  return s.match(/^\d{4}-\d{2}-\d{2}/) ? s : null;
}

async function load() {
  try {
    const res = await fetch(`${CONFIG.DATA_URL}?v=${Date.now()}`);
    const json = await res.json();
    const rows = json.items || [];
    
    const names = {};
    const firstRow = rows[0] || {};
    Object.keys(firstRow).forEach(k => {
      if(k.startsWith('FechaFracPozo')) {
        const id = k.match(/\d+/)[0];
        const val = String(firstRow[k] || "").trim();
        if(val && val.toUpperCase() !== 'X') names[id] = val;
      }
    });

    const stats = {};
    const dailyMap = new Map();
    const dataRows = rows.filter(r => {
        const f = String(r.Fila || r.fila || "").replace('#','');
        return f && !isNaN(f) && parseInt(f) <= CONFIG.MAX_ETAPAS;
    });

    Object.keys(names).forEach(id => {
      const fk = `FechaFracPozo${id}`;
      let totalSlots = 0, hechas = 0, serie = [], stopped = false;

      for(const r of dataRows) {
        const val = r[fk];
        if(isStop(val)) { stopped = true; break; }
        totalSlots++;
        if(isValidDate(val)) {
          hechas++;
          const ymd = parseToYMD(val);
          if(ymd) dailyMap.set(ymd, (dailyMap.get(ymd)||0) + 1);
        }
        serie.push({ f: r.Fila || r.fila, v: val, isH: isValidDate(val) });
      }
      if(totalSlots > 0 || hechas > 0) {
        stats[id] = { total: totalSlots, hechas, rest: totalSlots - hechas, serie, name: names[id] };
      }
    });

    gStats = stats; gNames = names;
    gDays = Array.from(dailyMap.entries()).sort((a,b) => b[0].localeCompare(a[0]));
    
    $('#lastUpdate').textContent = `Sincronizado: ${new Date().toLocaleTimeString()}`;
    renderMain();
    if($('#viewDias').style.display !== 'none') renderDays();
  } catch (e) { console.error("Error cargando datos:", e); }
}

function renderMain() {
  const all = Object.values(gStats);
  const t = all.reduce((a,b) => a + b.total, 0);
  const h = all.reduce((a,b) => a + b.hechas, 0);
  const r = t - h;

  $('#kpiTotales .value').textContent = t;
  $('#kpiRealizadas .value').textContent = h;
  $('#kpiRestantes .value').textContent = r;

  const last7 = gDays.slice(0, 7);
  const avg = last7.length ? (last7.reduce((a,b) => a + b[1], 0) / last7.length) : 0;
  $('#avgPace').textContent = `${avg.toFixed(1)} et/día`;

  const speed = PREFS.useManual ? PREFS.manualSpeed : avg;
  const speedLabel = PREFS.useManual ? `Manual: ${speed}` : `Real: ${avg.toFixed(1)}`;

  if(speed > 0 && r > 0) {
    const dLeft = r / speed;
    const target = new Date(Date.now() + dLeft * 86400000);
    $('#etaFinish').innerHTML = `${target.toLocaleDateString('es-AR', {day:'2-digit', month:'2-digit'})} <div style="font-size:10px; opacity:0.6; font-weight:normal">(Base: ${speedLabel} et/día)</div>`;
  } else { $('#etaFinish').textContent = "—"; }

  const cont = $('#viewPozos'); cont.innerHTML = '';
  Object.keys(gStats).forEach(id => {
    const p = gStats[id];
    const pct = p.total > 0 ? Math.round((p.hechas/p.total)*100) : 0;
    const el = document.createElement('div');
    el.className = `card pad pozo color-${id}`;
    el.innerHTML = `
      <div class="pozo-title">
        <div class="name">${p.name}</div>
        <div class="meta"><span class="badge">T: ${p.total}</span> <span class="badge">H: ${p.hechas}</span></div>
      </div>
      <div class="row">
        <div class="progress"><i style="width:${pct}%"></i></div>
        <div class="pct">${pct}%</div>
      </div>
    `;
    el.onclick = () => openDetail(id);
    cont.appendChild(el);
  });
}

function renderDays() {
  const box = $('#daysListBox');
  if(!box) return;
  box.innerHTML = '<div class="list"></div>';
  
  if (gDays.length === 0) {
    box.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.5">Sin datos registrados</div>';
    return;
  }

  gDays.forEach(([ymd, count]) => {
    const item = document.createElement('div');
    item.className = 'item';
    const dateParts = ymd.split('-');
    const displayDate = `${dateParts[2]}/${dateParts[1]}`;
    item.innerHTML = `<div class="left"><strong>${displayDate}</strong></div><div class="right">${count} etapas</div>`;
    box.firstChild.appendChild(item);
  });
}

function openDetail(id) {
  const p = gStats[id];
  $('#detailTitle').textContent = p.name;
  $('#detailBar').className = `backbar color-${id}`;
  $('#dTot').textContent = p.total;
  $('#dDone').textContent = p.hechas;
  
  const list = $('#dList'); list.innerHTML = '';
  p.serie.forEach(s => {
    const item = document.createElement('div');
    item.className = 'item';
    item.innerHTML = `<div class="left"><strong>Etapa ${s.f}</strong></div><div class="right" style="color:${s.isH?'#1ad598':''}">${s.v || '—'}</div>`;
    list.appendChild(item);
  });

  $('#topCard').style.display='none'; $('#viewPozos').style.display='none'; $('#mainTabs').style.display='none';
  $('#detailBar').style.display='flex'; $('#viewDetail').style.display='grid';
  drawChart($('#pozoChart'), p);
}

function drawChart(canv, pozoData) {
  const ctx = canv.getContext('2d'), dpr = window.devicePixelRatio || 1;
  const w = canv.clientWidth, h = canv.clientHeight;
  canv.width = w * dpr; canv.height = h * dpr;
  ctx.scale(dpr, dpr); ctx.clearRect(0,0,w,h);
  
  const m = new Map();
  pozoData.serie.forEach(s => { if(s.isH) { const y = parseToYMD(s.v); if(y) m.set(y, (m.get(y)||0)+1); } });
  const data = Array.from(m.entries()).sort((a,b) => a[0].localeCompare(b[0])).slice(-8);
  
  const max = Math.max(1, ...data.map(d=>d[1])), pad = 20, chartW = w - pad*2, chartH = h - pad*2;
  const stepX = chartW / Math.max(1, data.length);

  data.forEach((d, i) => {
    const bw = Math.max(10, stepX - 15), bh = (d[1]/max)*chartH, x = pad + i*stepX + (stepX-bw)/2, y = h - pad - bh;
    ctx.fillStyle = '#47a3ff'; ctx.fillRect(x, y, bw, bh);
    ctx.fillStyle = '#fff'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center'; ctx.fillText(d[1], x+bw/2, y-5);
    ctx.font = '8px sans-serif'; ctx.fillText(d[0].split('-').slice(1).reverse().join('/'), x+bw/2, h-5);
  });
}

$('#btnRefresh').onclick = load;
$('#btnBack').onclick = () => { $('#detailBar').style.display='none'; $('#viewDetail').style.display='none'; $('#topCard').style.display='block'; $('#viewPozos').style.display='grid'; $('#mainTabs').style.display='flex'; };
$('#btnCfg').onclick = () => { $('#cfgUseManual').checked = PREFS.useManual; $('#cfgManualVal').value = PREFS.manualSpeed; $('#modalSettings').classList.add('open'); };
$('#btnCloseCfg').onclick = () => $('#modalSettings').classList.remove('open');
$('#btnSaveCfg').onclick = () => { PREFS.useManual = $('#cfgUseManual').checked; PREFS.manualSpeed = parseFloat($('#cfgManualVal').value)||10; localStorage.setItem('mobile_prefs', JSON.stringify(PREFS)); $('#modalSettings').classList.remove('open'); renderMain(); };

$$('.tab').forEach(t => t.onclick = () => {
  $$('.tab').forEach(x => x.classList.remove('active')); t.classList.add('active');
  const v = t.dataset.view; 
  $('#viewPozos').style.display = v==='pozos'?'grid':'none'; 
  $('#viewDias').style.display = v==='dias'?'block':'none';
  if(v === 'dias') {
    renderDays();
    setTimeout(() => {
        const canv = $('#daysChart');
        const ctx = canv.getContext('2d'), dpr = window.devicePixelRatio || 1;
        const w = canv.clientWidth, h = canv.clientHeight;
        canv.width = w * dpr; canv.height = h * dpr;
        ctx.scale(dpr, dpr); ctx.clearRect(0,0,w,h);
        const data = gDays.slice(0, 10).reverse();
        const max = Math.max(1, ...data.map(d=>d[1])), pad = 20, chartW = w - pad*2, chartH = h - pad*2;
        const stepX = chartW / Math.max(1, data.length);
        data.forEach((d, i) => {
            const bw = Math.max(10, stepX - 15), bh = (d[1]/max)*chartH, x = pad + i*stepX + (stepX-bw)/2, y = h - pad - bh;
            ctx.fillStyle = '#47a3ff'; ctx.fillRect(x, y, bw, bh);
            ctx.fillStyle = '#fff'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center'; ctx.fillText(d[1], x+bw/2, y-5);
            ctx.font = '8px sans-serif'; ctx.fillText(d[0].split('-').slice(1).reverse().join('/'), x+bw/2, h-5);
        });
    }, 50);
  }
});

load();
setInterval(load, 60000);
</script>
</body>
</html>
